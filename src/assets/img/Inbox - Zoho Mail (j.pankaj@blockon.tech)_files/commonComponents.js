"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}define([],function(a){var b,c=a("zmComponent.keybindings"),d="navigatorScope",e=function(){var a=b.focused;return a=++a%b.dom.length},f=function(){var a=b.focused;return a-=1,a<0&&(a=b.dom.length-1),a},g=function(a,b){if(a)return!(a.isValidToFocus&&!a.isValidToFocus(a,b)||!a.onFocus)&&(a.onFocus(a,b),!0)},h=function(a){if(b){var c=b.dom,d=c[b.focused]||{};d.onBlur&&d.onBlur(d),a?b.focused=e():b.focused=f(),d=b.dom[b.focused],g(d,a)||h(a)}},i=h,j=h.bind(null,!0),k=function(){if(b){var a=b.dom[b.focused]||{},c=!a.onEscape||a.onEscape(a);c&&b.onEscape&&b.onEscape()}},l=function(){var a;b&&(a=b.dom[b.focused]||{},a.isValidToEnter&&!a.isValidToEnter(a)||a.onEnter&&a.onEnter(a))},m=[{uid:"next_tab",keyStr:"tab",actions:[j]},{uid:"previous_tab",keyStr:"shift+tab",actions:[i]},{uid:"clear",keyStr:"esc",actions:[k]},{uid:"onEnter",keyStr:"enter",preventDefault:!0,actions:[l]}],n=function(a){a=a||{},this.dom=a.dom||[],this.focused=a.focused||-1,this.onEscape=a.onEscape,this.previousScope=void 0},o=n.prototype;return o.setThisAsCurrentNavigator=function(){b=this,b.previousScope=c.getScope(),c.setScope(d)},o.clearTrace=function(){b===this&&(b.dom=[],b.focused=-1,c.getScope()===d&&b.previousScope&&(c.setScope(b.previousScope),b.previousScope=void 0),b=void 0)},c.registerAll({scope:d,allowDefaultScope:!1,shortcuts:m}),zmail.Navigator=n,zmail.Navigator}),define([],function(a,b){var c=function(a,b,c){return c=c||a.indexOf(b),c!==-1&&a.splice(c,1),a},d=function(a,b){var c,d,e=[],f=a.length;for(d=0;d<f;d++)c=a[d],c in b||e.push(c);return e},e=function(a,b){c(a.stack,b,void 0).push(b)},f=function(a,b){c(a.stack,b,void 0)},g=function(a){var b,c,e=a.store,f=a.isObjectInUse,g=a.stack,h=g.length,i=a.objectCount,j=a.evictCount,k=0,l={};for(j=h>=j?j:h,c=0;k<j&&c<h;c++)b=g[c],f(b)?(g.splice(c,1),g.push(b),h-=1):(delete e[b],l[b]=c,i-=1,k+=1);a.stack=d(g,l),a.objectCount=i},h=function(a){a=a||{},this.idName=a.idName||"id",this.store=a.store||{},this.objectCount=0,this.containerSize=a.containerSize||500,this.evictCount=a.evictCount||Math.ceil(.05*this.containerSize),this.considerAsHitOnRetrieval=void 0!==a.considerAsHitOnRetrieval&&a.considerAsHitOnRetrieval,this.isObjectInUse=a.isObjectInUse||function(a){return!1},this.stack=[]},i=h.prototype;return i.addObject=function(a){var b,c=this.store;this.objectCount>=this.containerSize&&g(this),b=a[this.idName],b in c||(this.objectCount+=1),this.store[b]=a,e(this,b)},i.rememberAsRecent=function(a){e(this,a)},i.addObjects=function(a){var b,c;for(c=0,b=a.length;c<b;c++)this.addObject(a[c])},i.getObject=function(a){var b=this.store[a];return b&&this.considerAsHitOnRetrieval&&e(this,a),b},i.removeObject=function(a){var b=this.store,c=b[a];return c&&(delete b[a],f(this,a),this.objectCount-=1),c},i.removeObjects=function(a){var b,c=a.length;for(b=0;b<c;b++)this.removeObject(a[b])},i.filter=function(a){var b,c=this.store,d=[];for(b in c)a(c[b])&&d.push(b);return d},zmail.Container=h,zmail.Container}),define([],function(a){var b=a("zmail.Core.Namespaces"),c=b.create("zmail.Components.AutoFill.Helper"),d=function(){var a=$("#topBar")[0],b=$("#wmstoolbar")[0],c=$(".zsw-enclosure.shw")[0],d=document.body.getBoundingClientRect(),e={top:d.top,right:d.right,bottom:d.bottom,left:d.left};return a&&(e.top=a.getBoundingClientRect().bottom),b&&(e.bottom=b.getBoundingClientRect().top),c&&(e.right=c.getBoundingClientRect().left),e},e=function(a){if(!a||"TEXTAREA"!==a.nodeName)return null;var b=a.getBoundingClientRect(),c=zmail.Utils.TextArea.findCursorPosition(a),d={top:b.top+c.top,right:b.left+c.left+c.width,left:b.left+c.left,bottom:b.top+c.top+c.height,height:c.height,width:c.width};return a.scrollTop>0&&(d.top-=a.scrollTop,d.bottom-=a.scrollTop),d},f=function(a){var b=null,c=null,f=null,g=null,h=null,i=null,j=0,k=0,l=0,m=0,n=!0;if(a=a||{},f={left:0,top:0},b=a.dom,b&&(c=a.anchor||$(b).data("anchor")),b=$(b)[0],c=$(c)[0],b&&c){var o=e(c);h=d(),g=c.getBoundingClientRect(),o&&(g=o),$(b).css({height:"auto"}),$(b).find(".content-wrapper").css({height:"auto"}),i=b.getBoundingClientRect(),f.left=g.left,f.top=g.bottom,j=Math.abs(g.top-h.top),k=Math.abs(g.bottom-h.bottom),l=Math.abs(g.left-h.left),m=o?Math.abs(g.right-h.right):Math.abs(g.left-h.right),k<i.height&&j>k&&(f.top=g.top-i.height,f.top<h.top&&(f.top=h.top),n=!1),m<i.width&&l>m&&(f.left-=Math.abs(i.width-g.width)),n&&k<i.height&&($(b).css({height:k+"px"}),$(b).find(".content-wrapper").css({height:k+"px"}),$(b).addClass("scroll-active")),!n&&j<i.height&&($(b).css({height:j+"px"}),$(b).find(".content-wrapper").css({height:j+"px"}),$(b).addClass("scroll-active")),$(b).css({top:f.top+"px",left:f.left+"px"}),a.hidden||$(b).addClass("shw")}},g=function(a,b){f(b)},h=function(){$.subscribe("autofill/open",g),$.subscribe("autofill/items/change",g)};return c.init=h,c.getAutofillViewPort=d,c.positionMenu=f,c}),define([],function(a){var b=a("zmText"),c=a("zmail.Core.Namespaces"),d=a("zmMention"),e=a("zmConUtil"),f=a("_zm"),g=c.create("zmAutoFill"),h=zmail.Components.AutoFill.Helper,i=b.get("commonComponents","autofill"),j={},k="ZC",l={},m={key:100},n=null,o=function(){if(!n){var a=zmail.Integrations.CRM.Contacts.DelayedRequestor;n=new a({delay:500})}return n},p=null,q=null,r=null,s=null,t=null,u=null,v=null,w=null,x=null,y=null,z=null,A=null,B=null,C="keypress.zmAutoFill",D=10,E=null,F=function(a,b,c){c=!1,setTimeout(function(){$.publish("autofill/items/change",{dom:a,anchor:b})},0)},G=function(a,b){var c={"#":{code:51,shiftKey:!0}},e=p($(a));if(e.hashTag){if(b&&(b.keyCode===c["#"].code||b.which===c["#"].code)&&b.shiftKey)return!0;var f=d.getCaretPosition(a),g=$(a).val().substring(0,f),h=g.lastIndexOf("#"),i=g.substring(h+1,g.length-1),j=/[ \n\r]+/gim,k=null===i.match(j),l=g.lastIndexOf(" ");if(h>=0&&l<=h&&k)return!0}return!1},H=function(a,b){if(G(a)){var c=d.getCaretPosition(a),e=q(a).substring(0,c),f=e.lastIndexOf("#"),g=$(a).val().substring(0,f);$(a).val(g+"#"+b+" "+$(a).val().substr(c));var h=("#"+g+b+" ").length;d.setCaretPosition(a,h)}},I=function(b,c,d,h,i){i=i||{};var j=a("zmComp"),k="",l="",m=$(b).attr("data-ty")?$(b).attr("data-ty"):"",n="",o=!0,x=p($(b));if(x.callback)return void x.callback(c);if(!c){if(!q(b).length)return!1;k=$.trim($(b).val());var y=e.splitncheck(k,"object",i);if(y.length>1)return void g.contactFill("",b,h,y);c=y[0],o=Boolean(c.photo),c["class"]+=o?"":" SC_np"}n=c["class"]||"SC_cs",k="1"!==String(x.OType)||c.gid?c.fn||c.name||c[x.display]||c.eid:(c.fn?c.fn:"")+(c.ln?" "+c.ln:"")||c.eid;var z,A={};"1"===String(x.OType)&&(A["data-eid"]=c.eid),(c.zid||c.id||c.gid)&&(A["data-uid"]=c.zid?c.zid:c.id),z={attr:A,name:k,img:o,ph:c.photo,iclass:"msi-close",cls:n,eid:c.eid},c.nn&&(z.name+=" ("+c.nn+")"),"function"==typeof x.onBubbleDOMCreate&&(i.modifyDOM=x.onBubbleDOMCreate),l=e.bubbleUtil(z,i);var B;if(l){B="edit"===m?$(l).insertAfter(b):$(l).insertBefore(b);var C=B.find("img");C.on("error",function(){C=$(this),setTimeout(function(){C.attr("src",zmail.defaultPhoto)},100)});var D=r(b,c,$(b).attr("tabindex")),E=$(b).data();$(B).data({store:E.store,afill:E.afill}),$(B).on({keydown:function(a){s(this,a)},dblclick:function(a){"1"===String(x.OType)&&(t(this),f.stopEvents(a))},click:function(a){u(a,$(B))}}).attr("tabindex",D),$(B).find(".msi-close").click(function(a){v(B),f.stopEvents(a)});var F=void 0===x.drag||x.drag;"1"===String(x.OType)&&!B.hasClass("zmerr")&&F&&w(b,B)}var G=$(b).parent(),H=$(G).attr("id");"edit"===m&&($(b).remove(),b=$(G).children("input").show()),H&&H.indexOf("Cmp")!==-1&&$(G).height()>61&&"1"===String(x.OType)&&($(G).attr("style","overflow:auto;height:61px"),j.resetHeight(G)),x.maxLength&&x.maxLength===$(b).siblings(".SC_cs").length?$(b).hide():g.resizeInput(b),d=void 0===d||d,$(b).val(""),d&&setTimeout(function(){$(b).focus()},0),x.actionCallback&&!h&&x.actionCallback($(b),{type:"add",data:c,elm:$(B)})};p=function(a){var b=$(a).data("store");return!!b&&f.copyOf(m[b].data)};var J=function(a,b){var c=$(a).data();c&&(j[c.store]&&j[c.store][c.afill]&&("reuse"===b?j[c.store][c.afill]=[]:delete j[c.store]),m[c.store]&&"reuse"!==b&&delete m[c.store])};r=function(a,b,c,d){var e=$(a).data(),f=e.store,g=e.afill;return j[f]||(j[f]=[]),j[f][g]||(j[f][g]=[]),d?void(j[f][g]=b):(c?j[f][g][c-1]=b:(j[f][g].push(b),c=j[f][g].length),c)};var K=function(a){var b=$(a).data(),c=$(a).attr("tabindex");return j[b.store][b.afill][c-1]},L=function(a){var b=$(a).data(),c=$(a).attr("tabindex");return j[b.store][b.afill].splice([c-1],1)},M=function(a,b){var c=m.key;$(b).data("store",c),m[c]={ele:b,data:a},m.key=c+1,b.length>1?$(b).each(function(a){$(this).data("afill",a)}):$(b).data("afill",0)},N=function(a){var b=$(a).data();return j[b.store]&&j[b.store][b.afill]?j[b.store][b.afill]:""},O=function(a,b,c,d){var e,g;if(40===b.keyCode||38===b.keyCode)return e=$("#zm_afill li.sel"),e.removeClass("sel"),g=40===b.keyCode?e.next().length?e.next():$("#zm_afill li").first():e.prev().length?e.prev():$("#zm_afill li").last(),g.addClass("sel"),$("#zm_afill").hasClass("scroll-active")&&($("#zm_afill")[0].scrollTop=Math.abs($("#zm_afill")[0].getBoundingClientRect().top-g[0].getBoundingClientRect().top)),!0;if(13===b.keyCode)return"searchByItem"===$("#zm_afill .sel").data("type")?("ZCRM"===k?x.search(a,$("#zm_afill ul")[0],b):y(b,a,p($(a)),"up",!0),!0):(z(a,c,d),b.preventDefault(),b.stopImmediatePropagation(),!0);if(8===b.keyCode){if(!q(a).length&&("1"===String(c)||"2"===String(c)))return"1"===String($(a).attr("data-kydn"))?($(a).removeAttr("data-kydn"),!0):($(a).prev(".SC_cs").addClass("zmfc").focus(),f.stopEvents(b),!0)}else if(!(39!==b.keyCode&&37!==b.keyCode||""!==q(a)||"1"!==String(c)&&"2"!==String(c)))return f.stopEvents(b,!1),s(a,b),!0;return!1},P=function(a,b){b=b.replace(/\./gi,"\\.").replace(/\+/gi,"\\+");var c,d=[],e=new RegExp(b,"i"),f=a.length;for(c=0;c<f&&!(a[c].match(e)&&""!==a[c].match(e)&&(d.push(a[c]),d.length>D));c++);return d},Q=function(a,b,c,d,e){var f,g,h=[],i=a.length,j=b.length;for(f=0;f<i;f++){for(g=0;g<j;g++){if(!e&&b[g]&&a[f][b[g]]&&a[f][b[g]].toLowerCase().indexOf(c.toLowerCase())!==-1){h.push(a[f]);break}if(e&&b[g]&&a[f][b[g]]&&a[f][b[g]].toLowerCase().startsWith(c.toLowerCase())){h.push(a[f]);break}}if(h.length>D&&!d)break}return h};x=function(){var a=null,b=['<li ref="wrapper">',"<div>",'<span ref="name" text-placeholder></span>',"<span>",'<span ref="email" text-placeholder></span>',"</span>","</div>",'<img ref="photo" />',"</li>"].join(""),c=function(b,c){A(c,function(d){var e=b.lastElementChild,g=$(e).data();g&&"searchByItem"===f.getProperty(g,"type")&&$(e).remove(),e=$(['<li class="lookupCRM">',"<i></i>","<div></div>","</li>"].join(""))[0],$(e).data("type","searchByItem");var h="ZCRM"===k;f.setAttr(e.querySelector("i"),{"class":h?"msi-crm":"msi-contacts"}),f.setTextContent(e.querySelector("div"),h?"Lookup CRM Contacts":"Lookup Mail Contacts"),b.appendChild(e),c.value.length<3&&(e.style.display="none"),f.bind(e,"mousedown",function(b,c,d,e){b?a(c,d,e):y(e,c,p($(c)),"up"),f.stopEvents(e)},[h,c,b],!0)})};return a=function(a,d,e){A(a,function(e){e=e||[],l=e;var g=0,h=Math.min(e.length,10);h>0&&(d.innerHTML="");var i=document.createDocumentFragment();for(g;g<h;g++){var j=e[g],m=j.SEID,n=j.FULLNAME,o=j.EMAIL,p=$(b),q=f.getDOMReferenceMap(p,!0);$(q.name).replaceWith(document.createTextNode(n)),$(q.email).replaceWith(document.createTextNode(o));var r=zmail.ContactBook.Templates.avatar({isValidPhoto:!1,initials:zmail.ContactBook.Utils.initials(n),avatarBgColor:zmail.ContactBook.Utils.colorClasses()});$(q.photo).replaceWith(r),$(p).data("cdata",{id:m,fn:n,eid:o,photo:"",crm:!0}),i.appendChild(p[0])}d.appendChild(i),k="ZC",c(d,a)})},A=function(a,b){var c=q(a);o().search(c).done(function(a){if(a.length>0)b(a);else{var c=f("#","zm_afill");if(c){var d=c.querySelector("ul").lastElementChild,e=$(d).data();d&&"searchByItem"===f.getProperty(e,"type")&&"ZCRM"===k&&$(d).remove(),F(c),0===c.querySelectorAll("ul li").length&&f.remove(f("#","zm_afill"))}}})},{toggleSwitch:c,search:a}}();var R={suggestionWithPhoto:['<li ref="wrapper">',"<div>",'<span ref="name" text-placeholder></span>',"<span>",'<span ref="email" text-placeholder></span>',"</span>","</div>",'<img ref="photo" />',"</li>"].join(""),listOneLinePhoto:['<li ref="wrapper">',"<div>",'<span ref="name" text-placeholder></span>',"</div>",'<img ref="photo" />',"</li>"].join(""),listSuggestions:['<li ref="wrapper">','<span ref="name" text-placeholder></span>',"</li>"].join("")},S=function(a){return a=a||{},zmail.ContactBook.Templates.avatar({isValidPhoto:!1,initials:zmail.ContactBook.Utils.initials(a.name||""),avatarBgColor:zmail.ContactBook.Utils.colorClasses()})},T=function(a,b,c){var d=null,e=function(){$(b).replaceWith(d)},f=(zmail.ContactBook.getGroups(a)||[])[0];if(f)return d=f.avatar(),void e();var g=(zmail.ContactBook.getCategories(a)||[])[0];if(g)return d=S({name:c}),void e();var h=zmail.Utils.EmailValidator.validate(a).status===!0;return h?void zmail.ContactBook.get({eid:a}).done(function(b){var f=b[0];b.length>1&&(f=b.filter(function(b){return b.attrs.eid===a})[0]),d=f?f.avatar():S({name:c}),e()}):(d=S({name:c}),void e())},U=function(a,b,c,d){l=b;var e,g=p($(a)),h=b.length,i=f("#","zm_afill"),j="",m="",n="",o=i.querySelector("ul"),q=document.createDocumentFragment();o.innerHTML="";for(var r=0;r<h;r++){var s=$(R.suggestionWithPhoto),t=f.getDOMReferenceMap(s,!0);j="",0===r&&"onDemand"!==g.selection&&(j="sel"),m=b[r][c[0]]?b[r][c[0]]:"",m+=" "+(b[r][c[1]]?b[r][c[1]]:""),n=b[r][c[3]]?b[r][c[3]]:"",e=b[r].photo?b[r].photo:zmail.defaultPhoto;var u=null;$(t.wrapper).attr({id:"pos"+r}),j&&$(t.wrapper).addClass(j),$(t.name).replaceWith(document.createTextNode(m)),$(t.email).replaceWith(document.createTextNode(n||" ")),u=t.photo,$(t.wrapper).data("cdata",{id:String(b[r].zid),fn:m,eid:n,photo:e}),$(u).hide(),T(n||b[r].zid,$(u),m),q.appendChild(s[0])}o.appendChild(q),k="ZCRM",x.toggleSwitch(o,a),F(i,a)},V=function(a,b,c,d){var e=p($(a));l=b;var g,h=b.length,i=f("#","zm_afill"),j="",k="",m=i.querySelector("ul");m.innerHTML="";for(var n=document.createDocumentFragment(),o=0;o<h;o++){var q=$(R.listOneLinePhoto),r=f.getDOMReferenceMap(q,!0);j="",0===o&&"onDemand"!==e.selection&&(j="sel"),g=b[o].eid||"",k=b[o][e.display]||b[o][c[0]],$(r.wrapper).attr({id:"pos"+o,title:g}),j&&$(r.wrapper).addClass(j),$(r.name).replaceWith(document.createTextNode(k));var s=r.photo;$(s).hide(),T(g||b[o].zid,$(s),k),n.appendChild(q[0])}m.appendChild(n),F(i,a)},W=function(a,b,c,d,e){l=b;var g,h,i="",j=f("#","zm_afill"),k=j.querySelector("ul"),m=p($(a)),n=b.length;k.innerHTML="";var o=document.createDocumentFragment();for(g=0;g<n;g++){var q=$(R.listSuggestions),r=f.getDOMReferenceMap(q,!0);i=0===g&&"onDemand"!==m.selection?"sel":"",h=m.display||"name",$(r.wrapper).attr({id:"pos"+g}),i&&$(r.wrapper).addClass(i),$(r.name).replaceWith(document.createTextNode(b[g][h])),o.appendChild(q[0])}k.appendChild(o),F(j,a)},X=function(a,b){for(var c=!0,d=[],e=a.length,f=b.length,g=0;g<e;g++){c=!0;for(var h=0;h<f;h++){var i=a[g].name?"name":"fn";String(a[g][i])===String(b[h][i])&&(c=!1)}c===!0&&d.push(a[g])}return d};q=function(a){var b;return b="DIV"===a.tagName?$(a).text():$(a).val(),$.trim(b)};var Y=function(a,b){"DIV"===a.tagName?$(a).text(b):$(a).val(b)},Z=function(a,b,c){var d;if(!b&&$("#zm_afill .sel").length&&(b=$("#zm_afill .sel")[0]),b){var e=b.id,f=e.slice(3,e.length),g=p($(a));d=l[f],g.text||G(a)?(G(a)?H(a,d.name):Y($(a)[0],d.name),$(a).data("uid",d.id)):I(a,d)}c&&c(d)},_=function(a){var b,c=[];return $(a).siblings(".SC_cs").each(function(){b=$(this).data("uid"),b&&c.push(b)}),c},aa=function(a){var b=$(a).siblings("input");$(a).remove(),$(b).show(),g.resizeInput($(b))};z=function(a,b,c,e){if(e=$(e).closest("li")[0],"1"===String(b))e?g.appContact(e,a):g.fillContacts(a,"zm_afill");else if("2"===String(b)||"3"===String(b)&&G(a))Z(a,e,c);else if("3"===String(b)&&$("#zm_afill").is(":visible")){e||(e=$("#zm_afill .sel")[0]);var f=e.id,h=f.slice(3,f.length),i=p(a);d.getVal(a,e,l[h],i.aliasPlusForAt)}g.removeMenu()};var ba=function(a,b,c,d,e,g){var h=E;return h?$(h).find(".content-wrapper ul").removeClass().addClass(d).html(""):(h=$(['<div id="zm_afill" class="SC_dd SC_zi900">','<div class="content-wrapper">','<ul class="'+d+'"></ul>',"</div>","</div>"].join(""))[0],E=h),$(h).data({anchor:$(a)[0]}),$(h).off("mousedown").on("mousedown",function(b){z(a,c,e,b.target),setTimeout(function(){$(a).focus()},0),f.stopEvents(b,!0)}),$(document.body).append(h),F(h,a),h},ca=/\w/,da=function(a,b,c,e,f,h,i,j){var l,m=null,n="",o="SC_P2r";f=String(f),h=String(h);var r,s,t,u;if("3"!==String(h)||G(b)){n=q(b);var v=p($(b));v.eliminateAt&&("@"===n.charAt(0)||v.aliasPlusForAt&&"+"===n.charAt(0))?n=n.substring(1,n.length):G(b)&&(r=d.getCaretPosition(b),s=q(b).substring(0,r),t=s.lastIndexOf("#"),u=s.charAt(t-1),0!==t&&" "!==u&&"\n"!==u||(n=s.substr(t+1),n=" "===n.charAt(0)||"\n"===n.charAt(0)?"":n.trim()))}else{r=d.getCaretPosition(b),s=q(b).substring(0,r),t=s.lastIndexOf("@");var w=p(b);u=s.charAt(t-1),u&&" "!==u&&"\n"!==u&&(t=-1),t<0&&w.aliasPlusForAt&&(t=s.lastIndexOf("+")),u=s.charAt(t-1),0!==t&&" "!==u&&"\n"!==u||(n=s.substr(t+1),n=" "===n.charAt(0)||"\n"===n.charAt(0)?"":n.trim());var y=s.charAt(t-1);ca.lastIndex=0;var z=null!==y.match(ca);t>0&&z&&(n=""),c=X(c,$(b).data("mentions"))}l=e.length?Q(c,e,n,"",j):P(c,n),l.length?(""!==$.trim(n)&&c.length&&("2"===f?o="SC_Phr":"3"===f&&(o="SC_Pr"),m=ba(b,["text"],h,o,i,a),"1"===f?U(b,l,e,h):"2"===f?W(b,l,e,h,i):"3"===f&&V(b,l,e,h)),F(m,b)):"1"===h?(k="ZCRM",m=ba(b,[],h,o,i,a),x.toggleSwitch($(m).find("ul")[0],b)):g.removeMenu(),null!==m&&$(m).find("li").off("mouseenter").on("mouseenter",function(a){$(this).one("mousemove",function(){$(this).parent().children().removeClass("sel"),$(this).addClass("sel")})}).off("mouseleave").on("mouseleave",function(a){$(this).removeClass("sel")})},ea=function(a,b,c,d,e,h,i,j){var k=O(b,a,h,i),l=f("#","zm_afill");q(b).length?k||da(a,b,c,d,e,h,i,j):g.removeMenu(),$(b).off("focusout.autofill").on("focusout.autofill",function(){g.removeMenu()}),F(l,b)},fa=function(a,b,c){"3"===String(c)&&d.updateElements(b)},ga=function(a,b){M(a,b)},ha=function(a,b,c){"3"===String(c)&&setTimeout(function(){d.updateElements(b)},100)},ia=function(a){if(a){var b=a.value;b=b||"",b.trim(),b=b.replace(/\n+/gim,","),b=b.replace(/\t+/gim,","),b=b.replace(/(?!@[^@ ]+)( +)/gim," "),b=b.replace(/([^@]+@[^@ ;,"]+)(?:(?: *, *)|(?: *; *)|(?: +))/gim,"$1, "),a.value=b}},ja=function(a){var b=a.target;$(b).data({contentPasted:!0})},ka=function(a){var b=a.target,c=$(b).data();c.contentPasted===!0&&($(b).data({contentPasted:!1}),ia(b));var d=p(b);if("keyup"===a.type){var e=a.which||a.keyCode;if(27===e&&"function"==typeof d.onEscKeyPress&&d.onEscKeyPress({event:a,elem:b}),[37,38,39,40,27,30,16,17,18,91,93].indexOf(e)!==-1)return}var f=d.onInputChange,g=$(b).val();"function"==typeof f&&f({type:"change",event:a,elem:b,text:g,length:g.length,isEmpty:0===g.length})},la=function(a){var b=$(a).parents(".cmntText"),c=$(a).parents(".zm_mention"),d=$(a).parents(".SCS_popUp"),e=0;if(d.length){var f=$(d).find(".SC_ptit");f.length&&(e=f[0].clientHeight)}if(!b.length||!c.length)return 0;var g=b.siblings(".cmntActions"),h=0;g.length&&(h=g[0].clientHeight);var i=b.find(".zms_rep"),j=0;i.length&&(j=i[0].clientHeight);var k=b.find(".SC_linkpreview"),l=0;k.length&&(l=k[0].clientHeight);var m=window.parseInt(b.css("max-height"));m=window.isFinite(m)?m:0;var n=window.parseInt(c.css("padding-top"));n=window.isFinite(n)?n:0;var o=window.parseInt(c.css("padding-bottom"));return o=window.isFinite(o)?o:0,m-(n+o+j+l+e+h)},ma=function(a,b){b=b||{};var c,d,e;if(a=$(a)[0]){c=b.height,d=b.maxHeight,e=$(a).prev(".zm_mentionbg"),e.css({overflow:"hidden",height:c+"px","max-height":d+"px"});var f=function(){e.scrollTop(a.scrollTop)};f(),$(a).off("scroll.mentions").on("scroll.mentions",f)}},na=function(a,b){if(b=b||{},zmail.Utils.TextAreaResizer.resize(a,{maxHeight:la(a),onResize:function(a){a=a||{},ma(a.element,{height:a.height,maxHeight:a.maxHeight,overflow:a.overflow,heightChange:a.change})},heightPadding:b.heightPadding||0}),b.resizeMentionsBG){var c=a.getBoundingClientRect();ma(a,{height:c.height,maxHeight:c.height})}},oa=function(a,b){b=b||{},a=$(a)[0];var c,e=a.value,f=a.selectionStart,g=a.selectionEnd,h=e.substring(0,f)||"",i=e.substring(g)||"";c=h+"\n"+i,a.value=c;var j=Math.abs(c.length-1-e.length);a.selectionStart=g-j+1,a.selectionEnd=a.selectionStart,d.updateElements(a),na(a,{heightPadding:b.heightPadding||0}),a.scrollTop>0&&a.scrollHeight>a.clientHeight&&a.selectionEnd===c.length&&(a.scrollTop=a.scrollHeight-a.clientHeight)},pa=function(a){var b={};return a.forEach(function(c,d){return c?void(b[c.eid]||(b[c.eid]=c)):void a.splice(d,1)}),Object.keys(b).map(function(a){return b[a]})},qa=function(a,b,c,e){if("3"===String(c)&&(64===a.keyCode||64===a.which)&&(d.isAtPressed=!0,e))if(d.getMentions(b)&&d.getMentions(b).length)d.isAtPressed=!1;else{var g=b.value;d.getCaretPosition(b)<g.replace(/\s+$/,"").length&&(a.preventDefault(),f.succErrMsg("e",i.errors.placedNotAtEnd))}},ra=function(a){var b=a.which||a.keyCode,c=",".charCodeAt(0);return b===c},sa=function(a,b,c){if(b=$(b),a&&b.length&&(c=String(c),"1"===c)){var d=p(b),e="onDemand"===d.selection;!ra(a)||a.shiftKey||e||(a.preventDefault(),z(b,c))}},ta=function(a,b,c){var e=a.keyCode||a.which;if(c=String(c),"1"===c){if((a.ctrlKey||a.metaKey)&&a.shiftKey&&65===e)return $(b).parent().find(".SC_cs").addClass("zmfc").last().focus(),a.preventDefault(),void a.stopPropagation();1===$(b).val().length&&8===a.keyCode&&$(b).attr("data-kydn","1")}else if("2"===c)13===a.keyCode?a.preventDefault():1===$(b).val().length&&8===a.keyCode?$(b).attr("data-kydn","1"):34!==a.keyCode&&33!==a.keyCode||$(b).blur();else if("3"===c&&$("#zm_afill").length){var f,g;38===a.keyCode||40===a.keyCode?$("#zm_afill").length&&a.preventDefault():13===a.keyCode||32===a.keyCode||39===a.keyCode?(f=d.getCaretPosition(b),g=$(b).val(),"%EF%BB%BF"===encodeURIComponent(g.charAt(f))&&d.setCaretPosition(b,f+1),13===a.keyCode&&$("#zm_afill").length&&a.preventDefault()):37!==a.keyCode&&8!==a.keyCode||(f=d.getCaretPosition(b),g=$(b).val(),"%EF%BB%BF"===encodeURIComponent(g.charAt(f-1))&&d.setCaretPosition(b,f-1))}},ua=function(a){var b=p(a);return b.contentArray=b.hashArray(),b.compare=["name"],b.LType="2",b};y=function(a,b,c,e,f){var h=G(b,a);c=p(b),h&&(c=ua(b));var j,k=[],l=c.contentArray,m=function(){"3"===String(c.OType)&&na(b,{heightPadding:c.heightPadding||0})},n=function(){f?da(a,b,k,c.compare,c.LType,c.OType,c.callback):ea(a,b,k,c.compare,c.LType,c.OType,c.callback,h)};if("3"!==String(c.OType)||d.isAtTyped(b)||c.aliasPlusForAt&&d.isPlusTyped(b)||h){if(l.length||"1"!==String(c.OType)){var o=_(b);o=c.restrict?o.concat(c.restrict):o;var r=q(b);if(c.eliminateAt&&"@"===r.charAt(0)&&(r=r.substring(1,r.length)),"org"===l){if("3"===String(c.OType)){var s=d.getCaretPosition(b),t=q(b).substring(0,s),u=t.lastIndexOf("@"),v=t.charAt(u-1);v&&" "!==v&&"\n"!==v&&(u=-1),u<0&&c.aliasPlusForAt&&(u=t.lastIndexOf("+")),v=t.charAt(u-1),0!==u&&" "!==v&&"\n"!==v||(r=t.substr(u+1),r=" "===r.charAt(0)||"\n"===r.charAt(0)?"":r.trim())}var w={org:!0,list:o,grpId:""};c.addtolist&&(w.addtolist=c.addtolist,w.groupId=c.groupId);var x=[];w.addtolist&&(x=w.groupId===!0?zmail.ContactBook.getGroups(r):zmail.ContactBook.getGroups(w.groupId));var y=[];if(!r.trim())return;return void $.Deferred().resolve(zmail.ContactBook.get({str:r,type:["org"],expected:D,exclude:o||[],excludeMe:!c.hasOwnProperty("excludeMe")||c.excludeMe,promise:!1})).promise().done(function(a){if(j=a.map(function(a,b){var c=$.extend({},a.attrs);return zmail.ContactBook.isGroup(a)&&(c.fn=c.name),c.photo=a.photo(!0),c}),x.length){zmUtil.isNewGroupUser()&&(x=x.filter(function(a){return a.get("disabled")!==!0}));for(var b=0,c=0;j.length<D&&b<x.length;){var d=$.extend({},x[b].attrs);d.fn=d.name,d.photo=x[b].photo(!0),d.zid=x[b].id,j.push(d),b++}x.forEach(function(a){y=a.attrs.members.concat(y)}),j.forEach(function(a,b){y.indexOf(a.zid)!==-1&&j.splice(c++,0,j.splice(b,1)[0])})}j.length>D&&(j=j.splice(0,D)),k=j||[],n(),m()})}if(parseInt(l))return void zmail.ContactBook.get({groupid:l}).done(function(a){k=a.map(function(a){var b=$.extend({},a.attrs);return b.photo=a.photo(!0),b}),n(),m()});if(l.indexOf("org")!==-1&&l.indexOf(":")!==-1){var z=l.substring(l.indexOf(":")+1,l.length),A=zmail.ContactBook.getGroups(z)[0],B=o||[];if(A&&(B=B.concat(A.attrs.members)),!r.trim())return;return void $.Deferred().resolve(zmail.ContactBook.get({str:r,type:["org"],expected:D,exclude:B,excludeMe:!c.hasOwnProperty("excludeMe")||c.excludeMe,promise:!1})).promise().done(function(a){j=a.map(function(a){var b=$.extend({},a.attrs);return zmail.ContactBook.isGroup(a)&&(b.fn=b.name),b.photo=a.photo(!0),b}),j.length>D&&(j=j.splice(0,D)),k=j||[],n(),m()})}k=l}else if(q(b))return void zmail.ContactBook.get({str:q(b),includeEmailedGroups:!0,includeCategories:!0,expected:D}).done(function(a){j=a.map(function(a){var b=$.extend({},a.attrs),c=!1;return zmail.ContactBook.isCategory(a)?(b.fn=b.cname,b.eid="["+i.category+"]",c=!0):zmail.ContactBook.isGroup(a)&&(b.fn=b.name),c?b.photo=zmail.defaultPhoto:b.photo=a.photo(!0),b}),j.length>D&&(j=j.splice(0,D)),k=j||[],k=pa(k),n(),m()});n()}else g.removeMenu();m()},u=function(a,b){if("IMG"===a.target.nodeName)return e.showContactCard({dom:$(b)[0],email:$(b).data("eid"),event:a,source:"compose"}),void f.stopEvents(a);if($(b).siblings("input").blur(),a.shiftKey)if($(b).siblings(".zmfc").length){var c=$(b).siblings(".zmfc").index(),d=$(b).index();c>d?$(b).parent().children().slice(d,c).addClass("zmfc"):$(b).parent().children().slice(c,d+1).addClass("zmfc")}else $(b).addClass("zmfc");else a.ctrlKey||a.metaKey?$(b).toggleClass("zmfc"):($(b).parent().children(".zmfc").removeClass("zmfc"),$(b).addClass("zmfc"));$(b).focus(),f.stopEvents(a)},t=function(a){$(a).siblings("input").hide();var b="",c=$("<input type='text' ></input>").insertBefore(a),d=$(a).attr("tabindex"),h=K($(a));return b=e.constructContact({firstName:h.fn,lastName:h.ln,nickName:h.nn,email:h.eid}),$(c).val(b).attr("size",b.length).attr("tabindex",d).data($(a).data()).on("keydown",function(a){B(this,a)}).on("focusout.autofill",function(a){g.fillContacts(c,"edit"),f.stopEvents(a)}).focus(),$(a).remove(),$(c)[0].setSelectionRange(0,0),$(c).select(),$(c)},B=function(a,b){13===b.keyCode&&(g.fillContacts(a,"edit"),f.stopEvents(b));var c=p($(a).siblings("input"));8===b.keyCode&&ta(b,a,c.OType),""===$.trim($(a).val())&&(v($(a)),$(a).attr("data-ty","edit"),$(a).off("keyup").keyup(function(b){y(b,$(a),c,"up")}),$(a).off("keydown").keydown(function(b){ta(b,$(a),"1")}),$(a).off(C).on(C,function(b){sa(b,$(a),"1")}),$(a).off("blur.autofill").on("blur.autofill",function(){g.fillContacts($(a),"edit")}))},s=function(a,b){var c,d=b.keyCode||b.which;if(13===b.keyCode)return f.stopEvents(b),void t(a);if((b.ctrlKey||b.metaKey)&&65===d)return $(a).parent().find(".SC_cs").addClass("zmfc"),void f.stopEvents(b);if((b.ctrlKey||b.metaKey)&&b.target&&"DIV"===b.target.tagName){var e=f("#","zmafill_hid");null===e&&(e=$("<input />").attr({id:"zmafill_hid"})[0],document.body.appendChild(e));var g,h=$(a).parent().find(".zmfc"),i=0,j=h.length||0,k="";for(i=0;i<j;i++)g=K(h[i]),0!==i&&(k+=","),g.fn&&(k+=g.fn),k+="<"+g.eid+">";return e.value=k,e.select(),void setTimeout(function(){$(e).remove(),$(a).focus()},0)}if(39===b.keyCode){$(a).removeClass("zmfc");var l=$(a).next(".SC_cs");0===$(a).next(".SC_cs").length&&(l=$(a).next("input")),c=$(l).focus()}else if(37===b.keyCode)1===$(a).prev(".SC_cs").length&&$(a).removeClass("zmfc"),c=$(a).prev(".SC_cs");else if(8===b.keyCode){if("INPUT"===$(a)[0].tagName&&1===$(a).val().length)return $("#zm_afill").hide(),void f.stopEvents(b);var m=$(a).siblings("input");0===$(a).siblings(".SC_cs").length?($(m).focus(),c=$(m)):(c=$(a).prev(".SC_cs"),!c.length&&$(a).next(".SC_cs")&&(c=$(a).next(".SC_cs"))),$(a).parent().children(".zmfc").each(function(){v($(this))}),f.stopEvents(b,!1)}$(c).hasClass("zm_sgst")||$(c).addClass("zmfc").focus(),b.ctrlKey||b.metaKey||f.stopEvents(b)},v=function(a){var b=$(a).siblings("input"),c=p($(a)),d=L($(a));"INPUT"!==$(a)[0].tagName&&$(a).remove(),$(b).siblings(".SC_cs").each(function(a){$(this).attr("tabindex",a+1)}),c.maxLength&&c.maxLength>$(a).siblings(".SC_cs").length&&!$(b).is(":visible")&&$(b).show(),c.actionCallback&&c.actionCallback($(b),{type:"remove",data:d[0]}),g.resizeInput(b)};var va=function(a,b,c){var d=$(a).data("store");c&&(m[d].data.restrict=c),b&&(m[d].data.contentArray=b)};w=function(a,b){var c=$(a).parent().attr("id"),d=c.substring(c.indexOf("Cmp")+3,c.length);$(b).draggable({revert:"invalid",containment:"#zmdArea_Cmp"+d+".zmdrop",scroll:!1,helper:function(){var a=$(this).clone().css({width:this.offsetWidth,position:"relative","z-index":"1"})[0];return a},addClasses:!1,drag:function(a,b){a.stopPropagation()},start:function(){$(this).hide()},stop:function(a,b){$(b.helper[0]).remove(),$(this).show()}}),$("#zmdArea_Cmp"+d+" .zmdrop").each(function(){$(this).droppable({drop:function(a,b){var c=b.draggable,d={};d=K($(c)),d["class"]=$(c).attr("class"),I($(this).children("input"),d),v($(c)),f.stopEvents(a,!0)}})})};var wa=function(a){a=a||{};var b,c=a,d=/(?:@[^@>]+>) *(,{1})/gim,e=/(.*)(?=<)/i,f=null,g=[],h='"';for(f=d.exec(c);null!==f;)g.push(c.substr(0,f.index+f[0].length)),c=c.substr(f.index+f[0].length),d.lastIndex=0,f=d.exec(c);return c=c.trim(),c&&g.push(c),g=g.map(function(a){return e.lastIndex=0,(f=e.exec(a))?(b=(f[0]||"").trim(),b&&b.charAt(0)!==h&&b.charAt(b.length-1)!==h&&(b=b.replace(/"/i,'\\"'),b=h+b+h,a=a.substr(f[0].length),a=b+" "+a),a):a}),a=g.join(" ")},xa={appContact:function(a,b){var c=$(a).data("cdata");if(c&&c.hasOwnProperty("crm"))I(b,c);else{var d=$(a).attr("id");d=d.substring(3,d.length);var e=l[d];e.cid?($(b).val(""),zmail.ContactBook.get({categoryid:e.cid,includeOnlyPrimary:!0}).done(function(a){a.forEach(function(a){I(b,a.attrs)})}).fail(function(){window.console.log("Error while fetching contacts for category !")})):I(b,e)}},fillContacts:function(a,b,c,d){var f,h=0;""===b&&(b="zm_afill");var i=p($(a));if(c)for(var j in c){Array.isArray(c[j])||(c[j]=[c[j]]),f=c[j],h=f.length;for(var m=0;m<h;m++)I(a,f[m],!1)}else if(!d)if(1===e.parseContacts($(a).val()).length||i.supressBlur)if("edit"!==b||$("#"+b).is(":visible"))if($("#"+b).is(":visible")){var n=$("#"+b+" .sel");if("searchByItem"===n.data("type")&&"ZCRM"===k)return x.search(a,n[0].parentNode),!1;var o=n.attr("id"),r=n.data("cdata");if(r&&r.hasOwnProperty("crm"))I(a,r);else if(i=p($(a)),o){o=o.substring(3,b.length);var s=l[o];s.cid?zmail.ContactBook.get({categoryid:String(s.cid),includeOnlyPrimary:!0}).done(function(b){b.forEach(function(b){I(a,b.attrs)})}).fail(function(){window.console.log("Error while fetching contacts for category !")}):I(a,s)}else i.callback&&i.callback()}else q($(a)[0])&&I(a);else""===$(a).val()&&(v($(a)),aa($(a))),$(a).attr("data-ty","edit"),I(a);else"edit"===b&&""===$(a).val()?(v($(a)),aa($(a))):g.contactFill($(a).val(),a);return $("#"+b).hide(),!0},getAddress:function(a,b,c){var d,f,g,h,i=N(a),j=[],k=!1,l=0,m=i.length;if(k=0!==$(a).siblings(".zmerr").length,"String"===b||"id"===b){for(l=0;l<m;l++)g=i[l],"id"===b?(d=g.id?g.id:g.zid,j.push(d)):g["class"]&&g["class"].indexOf("zmerr")!==-1||(h=e.constructContact({email:g.eid,firstName:g.fn,lastName:g.ln,nickName:g.nn}),j.push(h));j=j||[],f=j.join(",");var n=c?{address:f,count:m,error:k}:f;return n}return i},clearData:function(a,b){J(a,b)},clearView:function(a){$(a).parent().find(".SC_cs").remove()},resizeInput:function(a){var b=$(a).parent(),c=$(b).width(),d=$(b).children(".SC_cs").length,e=0,f=0;$(b).children(":not(.SC_cs)").each(function(){$(a)[0]!==$(this)[0]&&(f+=$(this).width())});var g=!1;if(d>0){var h=$(b).children(".SC_cs:last"),i=$(b).offset().left,j=$(h).width(),k=$(h).offset().left;g=c-(k-i+j)-f<50,e=g?c-f-30:c-(k-i+j)-f-30;
}else e=c-f-30;return $(a).attr("placeholder")&&$(a).data("placeholder",$(a).attr("placeholder")),0===d&&$(a).data("placeholder")?$(a).attr("placeholder",$(a).data("placeholder")):$(a).attr("placeholder",""),$(b).height()>=61&&($(b).scrollTop($(b).scrollTop()+61),$(b).css({height:"61px","overflow-y":"auto"}),$(b)[0].scrollTop=$(b)[0].scrollHeight),0===$(b).scrollTop()&&$(b).height("auto"),$(a).width(e),{isNextLine:g}},mentionData:function(a,b){var c=null;return b?r(a,b,"",!0):(d.updateElements(a),c=N(a)),c},updateArray:va,removeContact:v,contactFill:function(a,b,c,d,f){var h,i,j;for(f=f||{},d=d||[],!a&&d.length?h=d:("compose"===f.source&&(a=wa(a)),h=e.splitncheck(a,"object",f)),i=h.length,j=0;j<i;j++)I(b,h[j],!1,c,f);g.resizeInput(b)},addGroupData:function(a,b){var c;for(c in b)I(a,b[c],!1);g.resizeInput(a)},setAutofill:function(a,b,c){c=c||{};var d=String(m.key-1);if(a.keyID=d,"1"===String(a.OType)&&($(b).on("paste.emailInput",function(a){ja(a,b)}),$(b).on("keyup.emailInput",function(a){ka(a,b)}),$(b).on("change.emailInput",function(a){ka(a,b)}),$(b).on("focus.emailInput",function(b){var c=a.onInputFocusBlur;"function"==typeof c&&c({type:"focus",event:b,elem:b.target})}),$(b).on("blur.emailInput",function(b){var c=a.onInputFocusBlur;"function"==typeof c&&c({type:"blur",event:b,elem:b.target})})),"3"===String(a.OType)){if($(b).parent().hasClass("zm_mention"))return;$(b).wrap('<div class="zm_mention" style="color: transparent;" />'),$(b).before('<div class="zm_mentionbg"/>'),$(b).on("change",function(){na(this,{heightPadding:a.heightPadding||0})}),$(b).on("input",function(b){fa(b,this,a.OType)}),$(b).on("paste.autofill",function(b){ha(b,this,a.OType)}),a.resize&&$(b).focusin(function(){na(this,{heightPadding:a.heightPadding||0})}),a.resize||$(b).on("focusout.autofill",function(){""===$(this).val().trim()&&$(this).removeAttr("style")}),$(b).on("paste",function(b){ha(b,this,a.OType)})}else $(b).hasClass("zm_sgst")||$(b).addClass("zm_sgst");ga(a,b);var e=function(b){y(b,this,a,"up")};return $(b).off("keyup.autofill").on("keyup.autofill",e),$(b).off("keydown.autofill").on("keydown.autofill",function(b){ta(b,this,a.OType)}),"1"!==String(a.OType)||a.supressBlur||$(b).off("blur.autofill").on("blur.autofill",function(){g.fillContacts(this,"zm_afill",null)}),$(b).off(C).on(C,function(c){sa(c,this,a.OType),qa(c,this,a.OType,a.oneMention),a.keyCallback&&a.keyCallback(a.keyParam),"3"!==String(a.OType)||13!==c.which&&13!==c.keyCode||(c.preventDefault(),oa(b,{heightPadding:a.heightPadding||0}))}),m.key-1},removeAutoFill:function(a){var b,c=m[a],d="change input paste focusout keyup keydown blur";c&&(delete m[a],b=c.ele,b&&($(b).off(d),$(b).off(C)))},filterArray:Q,showAutoFill:function(a,b){ba(a,b.contentArray,b.OType,"SC_Phr",b.callback),W(a,b.contentArray,b.compare,b.OType,b.callback)}};return xa._dataStore={cacheData:function(){return j},fillData:function(){return l},storeData:function(){return m}},xa.removeMenu=function(){E&&($(E).remove(),E=null)},xa.isVisible=function(){return Boolean(E)},xa.resizeTextArea=na,h.init(),$.extend(!0,g,xa)}),define([],function(a){var b=a("zmail.Core.Namespaces"),c=b.create("zmMention"),d=function(a){return a.replace(/\$/gim,"$$$$")},e=function(a){return $(a).data("mentions")||[]},f=function(b,c){var d=a("_");c=c||[];var e=$(b).data("prevMentions")||[],f=c.length-e.length,g=!1,h=function(a){return a.zid},i=e.map(h),j=c.map(h),k=[];f>0?(g=!0,k=d.difference(j,i)):k=d.difference(i,j),f=Math.abs(f),$(b).data("mentions",c),f>0&&$(b).triggerHandler("mentions/change",{mode:g?"add":"remove",count:f,zidList:k}),$(b).data("prevMentions",[].concat(c))},g=function(a,b,d){var g=c.getCaretPosition(a),h=$(a).val().substring(0,g),i=h.lastIndexOf("@"),j=h.charAt(i-1);j&&" "!==j&&"\n"!==j&&(i=-1),i<0&&d&&(i=h.lastIndexOf("+")),j=h.charAt(i-1),j&&" "!==j&&"\n"!==j&&(i=-1);var k=b.name||b.fn;if(i>=0){var l=$(a).val().substring(0,i);$(a).val(l+k+"\ufeff"+$(a).val().substr(g));var m=(l+k+"\ufeff").length;c.setCaretPosition(a,m),b.from=l.length,b.to=m}var n=e(a);n.length&&n[0].from>=b.from?n.unshift(b):n.push(b),f(a,n),c.updateElements(a)},h={isAtPressed:!1,getCaretPosition:function(a){var b=0;if(document.selection){a.focus();var c=document.selection.createRange();c.moveStart("character",-a.value.length),b=c.text.length}else(a.selectionStart||0===a.selectionStart)&&(b=a.selectionStart);return b},getSelection:function(a){var b={};return b.start=a.selectionStart,b.end=a.selectionEnd,b},setSelection:function(a,b){a.focus(),a.setSelectionRange(b.start,b.end)},insertAtCursor:function(a,b){var c;if(document.selection)a.focus(),c=document.selection.createRange(),c.text=b;else if(a.selectionStart||0===a.selectionStart){var d=a.selectionStart,e=a.selectionEnd;a.value=a.value.substring(0,d)+b+a.value.substring(e,a.value.length),a.selectionStart=d+b.length,a.selectionEnd=d+b.length}else a.value+=b},insertNodeAtCaret:function(a){var b=window.getSelection();if(b.rangeCount){var c=b.getRangeAt(0);c.collapse(!1),c.insertNode(a),c.selectNodeContents(a),c.collapse(!1),b.setSingleRange(c)}},getMentions:function(a){return e(a)},getUserText:function(a){return c.updateElements(a,!0)},setCaretPosition:function(a,b){if(null!==a)if(a.createTextRange){var c=a.createTextRange();c.move("character",b),c.select()}else"undefined"!=typeof a.selectionStart?(a.focus(),a.setSelectionRange(b,b)):a.focus()},isCharTyped:function(a,b){var d=c.getCaretPosition(b),e=$.trim($(b).val()).substring(0,d),f=e.lastIndexOf(a),g=e.lastIndexOf(" "),h=e.lastIndexOf("\n");return f>=0&&(g<=f||f>=h)},isAtTyped:function(a){return c.isCharTyped("@",a)},isPlusTyped:function(a){return c.isCharTyped("+",a)},getVal:function(a,b,d,e){!b&&$(".SC_Psli").length&&(b=$(".SC_Psli")[0]),b&&g(a,d,e),c.isAtPressed=!1},placeCaretAfterNode:function(a){var b,c;window.getSelection&&(b=window.getSelection(),b.rangeCount&&(c=b.getRangeAt(0),c.setStartAfter(a),c.setEndAfter(a),b.removeAllRanges(),b.addRange(c)))},placeCaretBeforeNode:function(a){var b,c;window.getSelection&&(b=window.getSelection(),b.rangeCount&&(c=b.getRangeAt(0),c.setStartBefore(a),c.setEndBefore(a),b.removeAllRanges(),b.addRange(c)))},updateElements:function(b,c){var g,h,i,j,k,l=a("zmCont"),m=a("zmAutoFill"),n=$(b).val()||"",o=$(b).siblings(".zm_mentionbg"),p=e(b),q=0,r=[],s=[],t=[],u=[];for(q=0;q<p.length;q++)g=p[q].name||p[q].fn,h=p[q].id||p[q].zid;j=n.replace(/</g,"&lt;").replace(/>/g,"&gt;");var v=$(b).data("gid")||"",w="";for(q=0;q<p.length;q++)g=p[q].name||p[q].fn,h=p[q].id||p[q].zid,k=n.indexOf(g+"\ufeff"),k!==-1&&r.push(p[q]),w="zm_groupMember",v&&v!==p[q].zid&&(w=l.isGroupMember(p[q].zid,v)?"zm_groupMember":"zm_otherMember"),i=k,s.push(i),t.push(i+g.length),u.push(h),j=j.replace(g+"\ufeff","<b class="+w+'  z="'+h+'">'+d(g)+"</b>");s.length&&m.mentionData($(b),{from:s,to:t,text:u}),"\n"===j.charAt(j.length-1)&&(j+=" "),o.html(j),f(b,r);var x=c?n.replace(/\uFEFF/gi," "):$(b).val();return x},clearMention:function(a){$(a).removeData("mentions"),$(a).removeAttr("style"),$(a).siblings(".zm_mentionbg").html("")},resizeTArea:function(a,b,c){c||(a.style.height="auto");var d=a.offsetHeight-a.clientHeight,e=a.scrollHeight+d+"px";a.style.height=e,b||""!==$(a).val().trim()||$(a).removeAttr("style")}};return $.extend(!0,c,h)}),define([],function(a){var b,c=a("zmText"),d=a("zmail.Core.Namespaces"),e=d.create("zmComponent"),f={topAnn:"SC_topAnnBan",slideUp:"slideUp"},g={ANN_SHOW:"/announcement/show",ANN_HIDE:"/announcement/hide"},h="200",i=c.get("commonComponents","announcement"),j=['<div ref="wrapper" class="zmTopAnnBan show">','<div class="zmTopAnnBanWra">','<span ref="contentArea" class="zmTopAnnBanMsg">',"</span>",'<i ref="slideUp" class="msi-prev slideHit" />','<span ref="close" class="zmBanDis"></span>',"</div>",'<div ref="toggler" class="zmTopAnnBanTog"></div>',"</div>"].join(""),k=function(a){var b="";"s"===a?b=g.ANN_SHOW:"h"===a&&(b=g.ANN_HIDE),setTimeout(function(){$.publish(b)},h)},l=function(){$("body").removeClass(f.topAnn),$(b.wrapper).remove(),b=void 0,k("h")},m=function(){$("body").addClass(f.topAnn)},n=function(a){$(b.wrapper).hasClass(f.slideUp)?($(b.wrapper).removeClass(f.slideUp),$("body").addClass(f.topAnn),k("s")):($(b.wrapper).addClass(f.slideUp),$("body").removeClass(f.topAnn),k("h"))},o=function(a,b){$(a.close).text(i.doNotShow),$(a.slideUp).on("click",n),$(a.close).on("click",function(a){l(),"function"==typeof b.closeAction&&b.closeAction()}),$(a.toggler).on("click",n)},p=function(c){var d,e=a("_zm");c=c||{},b&&b.wrapper&&l(),d=e.getDOMReferenceMap(j,!0),"html"===c.contentType?$(d.contentArea).html(c.content):"text"===c.contentType&&$(d.contentArea).text(c.content),o(d,c),m(),$("body").append(d.wrapper),k("s"),b=d};return e.showAnnouncementBanner=p,e});var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();define([],function(a){var b=a("zmail.Core.Namespaces"),c=b.create("zmail.Components.InputSuggestionMenu"),d={SHOW_LIST:"shw",SELECTED_ITEM:"SC_Psli"},e={itemSelected:"itemSelected",escapeKeyDown:"escapeKeyDown",selectionChanged:"selectionChanged"},f={LIST:['<div class="SC_dd SC_zi900" ref="wrapper">','<div class="content-wrapper" ref="contentWrapper">','<ul class="SC_P2r" ref="listWrapper">',"</ul>","</div>","</div>"].join(""),LIST_ITEM:['<li class="list-item" ref="wrapper">',"<div>",'<span style="font-weight: 600;" ref="name"></span>','<span ref="email"></span>',"</div>",'<img ref="profile" />',"</li>"].join("")},g=function(){function a(b){_classCallCheck(this,a);var c=this;b=b||{},c.dom=null,c.refs=null,c.targetInput=null,c.list=[],c.containerDOM=document.body,c.initialized=!1,c.selectedItem=null,c.visible=!1}return _createClass(a,[{key:"_throwErrorIfNotInit",value:function(){var a=this;if(!a.initialized)throw new Error("Not initialized !")}},{key:"getTemplate",value:function(){return f.LIST}},{key:"getListItemTemplate",value:function(){return f.LIST_ITEM}},{key:"init",value:function(a){var b=this;if(a=a||{},b.list=a.list||[],b.containerDOM=a.container||document.body,b.targetInput=a.input||null,!b.targetInput)throw new Error("Input element is required !");b.initDOM(),b.render(),b.bindEvents(),b.initialized=!0}},{key:"destroy",value:function(){var a=this;a.unbindEvents(),$(a.dom).remove(),a.clearSelection(),a.dom=null,a.list=null,a.containerDOM=null,a.targetInput=null,a.initialized=!1,a.selectedItem=null,a.visible=!1}},{key:"_handleItemClick",value:function(a){var b=this,c=a.currentTarget;b.setSelection($(c).data().id),$(b).triggerHandler(e.itemSelected,{id:$(c).data().id}),a.stopPropagation()}},{key:"_moveSelectionUp",value:function(){var a=this;if(!a.selectedItem){var b=$(a.refs.listWrapper).find("li").last();return void a.setSelection($(b).data().id)}var c=$(a.refs.listWrapper).find("."+d.SELECTED_ITEM),e=$(c).prev();e.length?a.setSelection(e.data().id):a.setSelection($(a.refs.listWrapper).find("li").last().data().id)}},{key:"_moveSelectionDown",value:function(){var a=this;if(!a.selectedItem){var b=$(a.refs.listWrapper).find("li").first();return void a.setSelection($(b).data().id)}var c=$(a.refs.listWrapper).find("."+d.SELECTED_ITEM),e=$(c).next();e.length?a.setSelection(e.data().id):a.setSelection($(a.refs.listWrapper).find("li").first().data().id)}},{key:"_handleInputKeydown",value:function(a){var c=this;if(c.visible){var d=b.get("zmail.Components.AutoComplete.Constants"),f=d.KEYS,g=a["while"]||a.keyCode,h=!1;switch(g){case f.UP:c._moveSelectionUp(),h=!0;break;case f.DOWN:c._moveSelectionDown(),h=!0;break;case f.ENTER:c.selectedItem&&$(c).triggerHandler(e.itemSelected,{id:c.selectedItem}),h=!0;break;case f.ESC:$(c).triggerHandler(e.escapeKeyDown,{}),h=!0}h&&(a.stopPropagation(),a.preventDefault())}}},{key:"_handleMouseDown",value:function(a){a.stopPropagation()}},{key:"_handleClick",value:function(a){a.stopPropagation()}},{key:"bindEvents",value:function(){var a=this;$(a.dom).on("mousedown",a._handleMouseDown),$(a.dom).on("click",a._handleClick),a._handleItemClick=a._handleItemClick.bind(a),$(a.dom).on("mousedown","li.list-item",a._handleItemClick),a._handleInputKeydown=a._handleInputKeydown.bind(a),$(a.targetInput).on("keydown",a._handleInputKeydown)}},{key:"unbindEvents",value:function(){var a=this;$(a.dom).off("mousedown",a._handleMouseDown),$(a.dom).off("click",a._handleClick),$(a.dom).off("mousedown","li.list-item",a._handleItemClick),$(a.targetInput).off("keydown",a._handleInputKeydown)}},{key:"initDOM",value:function(){var a=this,c=b.get("zmail.Components.AutoComplete.Utils");a.initialized||a.dom||(a.dom=c.constructDOM(a.getTemplate()),a.refs=c.getDOMReferenceMap(a.dom,!0))}},{key:"setSelection",value:function(a){var b=this,c=!1;b.clearSelection(),$(b.refs.listWrapper).find("li").each(function(b,e){$(e).data().id===a&&($(e).addClass(d.SELECTED_ITEM),c=!0)}),c&&(b.selectedItem=a,$(b).triggerHandler(e.selectionChanged,{id:b.selectedItem}))}},{key:"clearSelection",value:function(){var a=this;$(a.refs.listWrapper).find("."+d.SELECTED_ITEM).removeClass(d.SELECTED_ITEM),a.selectedItem=null}},{key:"renderListItem",value:function(a){var c=this,e=b.get("zmail.Components.AutoComplete.Utils");if(!a.email)return null;var f=e.constructDOM(c.getListItemTemplate()),g=e.getDOMReferenceMap(f,!0);$(g.name).text(a.name),$(g.email).text(a.email),$(g.profile).attr({src:zmail.defaultPhoto}),zmail.Utils.Image.load(a.photo).done(function(){$(g.profile).attr({src:a.photo}).fadeIn()});var h=a.id||a.email;return $(f).data({id:h}),h===c.selectedItem&&(c.clearSelection(),c.selectedItem=h,$(f).addClass(d.SELECTED_ITEM)),f}},{key:"render",value:function(){var a=this,b=a.refs,c=a.list;$(b.listWrapper).html("");var d=document.createDocumentFragment();c.forEach(function(b){var c=a.renderListItem(b);c&&d.appendChild(c)}),$(b.listWrapper).append(d)}},{key:"positionList",value:function(){var a=this,c=b.get("zmail.Components.AutoComplete.Utils");$(a.dom).css({visibility:"hidden",display:"inline-block"}),c.positionDOM({dom:a.dom,viewPortBounds:c.getListComponentViewPort(),anchorBounds:a.targetInput.getBoundingClientRect()}),$(a.dom).css({visibility:"",display:""})}},{key:"show",value:function(){var a=this;a._throwErrorIfNotInit(),a.positionList(),$(a.dom).addClass(d.SHOW_LIST),a.visible=!0}},{key:"hide",value:function(){var a=this;a._throwErrorIfNotInit(),$(a.dom).removeClass(d.SHOW_LIST),a.clearSelection(),a.visible=!1}},{key:"mount",value:function(){var a=this;a._throwErrorIfNotInit(),$(a.dom).appendTo(a.containerDOM)}},{key:"unmount",value:function(){var a=this;a._throwErrorIfNotInit(),a.hide(),$(a.dom).detach(),a.clearSelection()}}]),a}(),h=function(b){var c=a("zmAppLoader"),d=$.Deferred();return setTimeout(function(){c.load("autoComplete").done(function(){d.resolve(new g(b))})},0),d.promise()};return c.createMenu=h,c.Events=e,c.BaseClass=g,c});