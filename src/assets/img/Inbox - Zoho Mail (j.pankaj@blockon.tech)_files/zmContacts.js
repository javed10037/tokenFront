!function(a){"use strict";var b=zmText.get("zmContacts"),c={},d={},e={},f={},g={},h=[],i=[],j=[],k={},l={},m=[],n=[],o=$.Deferred(),p=!1,q=!1,r=function(){g={},(zmail.ContactBook.getGroups()||[]).map(function(a){return a.attrs}).forEach(function(a){g[a.id]=a}),h=zmail.ContactBook.groups.order||[],l=zmail.ContactBook.groups.me.attrs||{}},s=function(a,b){if(b=b||[],b.constructor!==Array&&(b=[b]),a){c[a]=c[a]||[];var d=c[a];return b.forEach(function(a){a=a||{},d.forEach(function(b,c){b=b||{};var e=!1;b.eid&&a.eid===b.eid&&(e=!0),b.zid&&a.zid===b.zid&&(e=!0),e&&d.splice(c,1)})}),b=b.concat(d),c[a]=b,c[a]}},t=function(a){var b=a.substring(0,1).toLowerCase(),c=/[^a-z]$/;return b.match(c)?"others":b},u=function(a){if(a=[a,""].join(""),c.catlist)for(var d=c.catlist.length,e=function(a){return function(b){return b.cid===c.catlist[a].cid}},f=0;f<d;f++){var g=c.catlist[f].cname,h=t(g);h=[h,""].join(""),c[h]||(c[h]=[]),c[h].filter(e(f))[0]||c[h].push({fn:g,eid:"["+b.common.label.category+"]",cid:c.catlist[f].cid})}},v=function(a,b){var c=[];return zmUtil.checktype(a,Array)?c[b]=a:(c[b]=[],void 0!==a&&c[b].push(a)),c[b]},w=function(a,b){var g,h=b.clist;if(a=[a,""].join(""),"500"===a){for(g in h)c[g]=s(g,h[g]);if(b.catlist){var i=b.catlist;d.catlist=1,c.catlist=i,u(a)}}else if("100"===a){d[a]=1;for(g in h)e[g]=v(h[g],g);f=b.zlist||{},zmCont.isGroupLoaded()}else d[a]=1,c[g]=s(a,h[a]),u(a)},x=function(a,b){var c=a.clist,d=b.mode;return w(d,a),b.calbk?void b.calbk(d,"callback"):void("cat"===b.type&&zmAutoFill.fillContacts(b.obj,"",c))},y=function(a,b,c){if(a&&g[a]||zmail.zuid===a){var d,e;e=zmail.zuid===a?l:g[a],d=void 0!==c?parseInt(c):parseInt(e.scount),void 0!==c?e.scount=d:b?(d++,e.scount=d):(d--,e.scount=d),$.publish("group/unread",{groupId:a,count:d,incFlag:b})}},z=function(a,b){(b||[]).forEach(function(b){zmCont.GroupAPI.addMember(a,b)})},A=function(){var a=[];if(!n.length){var b,c=_.pluck(zmCont.getGroup(),"members"),d=c.length;for(b=0;b<d;b++)a=a.concat(c[b]);n=_.uniq(a)}return n},B=function(a,b,c){var d=[];a=[a,""].join("");var g=[].concat(e[a]);if(a&&(a.length>1&&"others"!==a&&(a=a.substring(0,1)),void 0!==e[a]))if(d=[],e.val&&e.val===a&&!b)d=e.tmp;else{if(b){var h,i=b.length;for(h=0;h<i;h++)g.indexOf([b[h],""].join(""))!==-1&&g.splice(g.indexOf([b[h],""].join("")),1)}var j,k,l=[],m=A();parseInt(c)&&(l=zmCont.getGroup(c).members);var n;for(l=l.concat(m),l=_.uniq(l),k=0,j=l.length||0,k=j;k>=0;k--)n=g.indexOf(l[k]),n!==-1&&(g.splice(n,1),g.unshift(l[k]));for(j=g.length,k=0;k<j;k++)[g[k],""].join("")!==[zmail.zuid,""].join("")&&d.push(f[g[k]]);e.tmp=d,e.val=a}return d},C=function(a,b){var d=(a.clist[b]||{}).mode,e=b.eid.substring(0,1);d&&!$.isArray(d)&&(d=[d]),d&&d.length?(k[a.qry]&&delete k[a.qry],c[e]&&c[e].length?c[e]=c[e].concat(d):(c[e]=c[e]||[],c[e]=c[e].concat(d))):k[a.qry]=1,b.callbk(a.clist,b)},D=function(a){return zmConUtil.getFormattedContactObj(a)},E=null,F={},G=function(a){if(F[a])return $.Deferred().reject().promise();if(E||(E=zmail.Utils.DeferredCollection.create({keepDeferreds:!1})),E.has(a))return E.get(a).promise();var b=E.get(a);return zmAjq.XHR({u:zmail.conPath+"/getContacts.do",p:{type:"d",email:a,mode:"200"},fn:function(c){var d=null;if(c=c||{},c.clist=c.clist||{},d=c.clist[200]||[],d.constructor!==Array&&(d=[d]),setTimeout(function(){$.publish("contacts/insert",{contacts:d})},0),d=d.filter(function(b){return b.eid===a}),d[0]){var e=D(d[0]);e._json=d[0],b.resolve(e)}else b.reject()},efn:function(){b.reject()},t:"GET"}),b.fail(function(){F[a]=!0}),b.promise()},H=function(a){var b,c=a.zuid||"",d=a.email||"",g=null,h=null,i=null,j=null;if(d){g="eid",h=d;var k=d.charAt(0).toLowerCase();k=t(k),j=e[k]||[]}else c&&(g="zid",h=c,j=Object.keys(f));for(var l=0;l<j.length;l++){var m=j[l],n=f[m];if(n[g]===h){b=n;break}}return b&&(i=D(b),i._json=b),i},I=function(a){a=a||{};var b,d,e=a.zuid||"",f=a.email||"",g=a.gid||"",h=a.request||!1,i=a.org||!1;if(f){if(i)return H(a);var j=f.charAt(0).toLowerCase();j=t(j);var k=c[j]||[];if(d=k.filter(function(a){return a.eid===f}),d=d[0],d&&d.eid?(b=D(d),b._json=d):(d=void 0,b=d),h&&!b)return G(f)}else if(e){if(i)return H(a);d=zmCont.getOrgContacts(e)||{},d=d[e],!d||d.isDummyObj?(d=void 0,b=d):(b={zohoUserID:e,firstName:d.fn||"",nickName:d.nn||"",emailAddress:d.eid,photoURL:d.photo},b.displayName=b.firstName||b.nickName||b.emailAddress,b._json=d)}else g&&(d=zmCont.getGroup(g),d&&(b={groupID:g,displayName:d.name,photoURL:d.photo,emailAddress:d.eid},g===zmail.zuid&&(b.displayName=zmail.IAMFullName,b.photoURL=zmail.urls.accURL+"/file?fs=thumb&nocache="+Date.now(),b.emailAddress=zmail.user.loginName),b._json=d));if(!f&&b&&b.photoURL&&(b.photoURL+=(b.photoURL.indexOf("?")===-1?"?":"&")+"API=true"),h){var l=$.Deferred();b?l.resolve(b):l.reject(),b=l}return b},J=function(a){a=a||{};var b=[],c=a.limit||null,d=(a.searchKey||"").trim(),e=a.caseSensitive||!1,g=a.sortKey||"",h=a.searchMiddleName||!1,i=a.searchNickName||!1,j=a.ignoreList||[],k={};if(j.forEach(function(a){k[a]=!0}),d){e||(d=d.toLowerCase());var l=[],m=f||{};Object.keys(m).forEach(function(a){l.push(m[a])});for(var n=0,o=l.length;n<o;n++){var p=l[n],q=p.fn||"";e||(q=q.toLowerCase());var r=p.mn||"";e||(r=r.toLowerCase());var s=p.ln||"";e||(s=s.toLowerCase());var t=p.nn||"";e||(t=t.toLowerCase());var u=p.eid||"";e||(u=u.toLowerCase());var v=p.chat||!1,w=0,x=q.indexOf(d);q&&x!==-1&&(w++,0===x&&(w+=10)),h&&r&&r.indexOf(d)!==-1&&w++;var y=s.indexOf(d);s&&y!==-1&&(w++,0===y&&(w+=5)),i&&t&&t.indexOf(d)!==-1&&w++;var z=u.indexOf(d);if(u&&z!==-1&&(w++,0===z&&(w+=8)),w&&v&&w++,w&&!k[p.zid]&&(b.push($.extend({_matchScore:w},p)),c&&b.length>=c))break}return"matchScore"===g&&(b=b.sort(function(a,b){return a._matchScore>b._matchScore?-1:a._matchScore<b._matchScore?1:0})),b}},K=function(a){var b=$.Deferred();return setTimeout(function(){var c=J(a);b.resolve(c)},0),b},L=zmail.Utils.DeferredCollection,M=L.create({keepDeferreds:!1}),N=function(a){a=a||{};var b=(a.searchWord||"").trim().toLowerCase();if(!b)return $.Deferred().reject().promise();var c=b.charAt(0);if(c=t(c),1===d[c])return $.Deferred().reject().promise();var e=M.has(c),f=M.get(c);return e?f.promise():(zmAjq.XHR({u:zmail.conPath+"/getContacts.do",t:"GET",fn:function(a){a=a||{};var b=a.clist||{},e=b[c]||[];s(c,e),d[c]=1,f.resolve()},efn:function(){f.reject()},p:{mode:c,type:"a"}}),f.promise())},O={getContactInfo:I,addGroupmember:z,contacts:function(a,b,e,f){var g,h,i,j=$.Deferred(),k=zmail.conPath+"/getContacts.do";if(a=[a,""].join(""),void 0===b||null===b||d[b]){if("1"===[d[b],""].join("")){var l={};return l.clist=c[b],void(e&&zmAutoFill.fillContacts(e,"",l))}g={mode:a},h={mode:a},"100"!==a||d[100]?"500"!==a&&"300"!==a&&(i=a,"others"!==a&&(i=t(a)),g={mode:i},h={mode:i}):(k=zmail.conPath+"/orgContacts.do",g.mode="orgdata")}else g={mode:a,cId:b},h={mode:b,type:"cat",obj:e};return f&&(h.calbk=f),g.type="a",zmAjq.XHR({u:k,t:"GET",fn:function(){var a=Array.prototype.slice.apply(arguments);x.apply(this,a),j.resolve()},efn:j.reject,p:g,ep:h}),j.promise()},getContact:function(a,b,e,f,h){var i=[],j=[],k=0,l=0,m=0,n=a,o={},p=!1,q=!0,r="";"object"==typeof a&&(void 0!==a.req&&(q=a.req),a.srch&&(r=a.srch),a=a.str,n=a),"others"!==a&&(n=a.substring(0,1),n=t(n)),h&&(p=h.org);var s="100";if(void 0!==p&&p&&1===d[s]){var u=[];h.grpId&&h.grpId!==zmail.zuid&&g[h.grpId]&&(u=g[h.grpId].members),h.list.length>0?u=h.list.concat(u):u.length>0&&(u=u.concat(h.list));var v=h.addtolist?h.groupId:"";if(j=B(n,u,v),v){var w={};parseInt(v)?v=[v]:v.constructor!==Array&&(v=Object.keys(zmCont.getGroup())),v.forEach(function(a){var b=zmCont.getGroup(a);b&&(w[a]=b)});var x={},y={};for(var z in w)y=w[z],x={fn:y.name,nn:"",eid:y.eid,photo:y.photo,zid:z},j.push(x)}}else p&&!d[100]?zmCont.contacts(100):(j=c[n],!d[n]&&q&&(d[n]=2,k=1,zmCont.contacts(a,null,null,f)));e=[e,""].join(""),"s"===e&&1===a.length&&(e="f");var A=function(b){var c=a||"";return b=b||"",!(!c||!b)&&(c=c.toLowerCase(),b=b.toLowerCase(),"f"===e?('"'!==c.charAt(0)&&"'"!==c.charAt(0)||(c=c.substr(1)),0===b.indexOf(c)):b.indexOf(c)!==-1)};if(j){l=j.length;for(var C,D,E,F,G,H,I="",J=0;J<l&&m<b;J++)G=0,H=j[J].name?"name":"fn",""!==r&&A(j[J][r])?G=1:(C=j[J].eid,D=j[J][H],E=j[J].ln,F=j[J].nn,I=[D,E,F].join(" "),C&&A(C)?G=1:D&&A(D)?G=1:E&&A(E)?G=1:F&&A(F)?G=1:A(I)&&(G=1)),1===G&&(j[J].cid||j[J].photo||(j[J].photo=zmail.defaultPhoto),i.push(j[J]),m++)}return o.result=i,1===k&&(o.mc=k),o},consContact:function(a){var b="";return""!==a.fn&&(b+='"fn":"'+zmUtil.quotUnEscape(a.fn)+'"'),a.ln&&""!==a.ln&&(b+=',"ln":"'+zmUtil.quotUnEscape(a.ln)+'"'),a.nn&&""!==a.nn&&(b+=',"nn":"'+zmUtil.quotUnEscape(a.nn)+'"'),a.zid&&""!==a.zid&&(b+=',"zuid":"'+a.zid+'"'),b+=a.photo&&""!==a.photo?',"photo":"'+a.photo+'"':',"photo":zmail.defaultPhoto',""!==b&&(b+=","),b+='"eid":"'+a.eid+'"'},getCateDetails:function(a,b){return c[a]?c[a]:void(2!==d[a]&&"catlist"!==a&&(zmCont.contacts(300,a,null,b),d[a]=2))},isEmailExist:function(a,b,c){if(a){var e,f,g,h=a.substring(0,1),i={str:a,req:!1,srch:"eid"};if(e=zmCont.getContact(i,500,"f"),1===k[a])return{req:!1};if(d[h]||e.result.length||!b||(f={type:"d",email:a,mode:"200"},g={eid:a,callbk:b,mode:"200",elm:c},k[a]=0,m.indexOf(a)<0?(m.push(a),zmAjq.XHR({u:zmail.conPath+"/getContacts.do",t:"GET",fn:C,p:f,ep:g})):b({req:!1},g)),0!==e.result.length)return e.result[0]}},getOrgContacts:function(a,b){var c,d,e,g=a.split(","),h=g.length;for(c="Array"===b?[]:{},d=0;d<h;d++)e=f[g[d]]?f[g[d]]:{g:2,zid:"",nn:"",photo:zmail.defaultPhoto,eid:"",fn:"",isDummyObj:!0},"string"===b?c[g[d]]="{"+zmCont.consContact(e)+"}":"Array"===b?c.push(e):c[g[d]]=e;return c},isGroupLoaded:function(a,b){var c="100";if(d[c]){if(a&&1===d[c])a.apply(null,b);else if(!a&&1===d[c]&&i.length){var e=0,f=i.length;for(e=0;e<f;e++)i[e].apply(null,j[e]);i=[],j=[]}}else zmail.trialUsers?zmail.ContactBook.fetchProcess.done(function(){d[c]=1,zmCont.isGroupLoaded()}):zmCont.contacts("100"),a&&(i.push(a),j.push(b))},getContactsForGroup:function(a){var b=[];return a&&(b=zmCont.getOrgContacts(zmCont.getGroup(a).members.join(","),"Array")),b},getGroup:function(a,b){var c={},d=!1;return"undefined"==typeof a?(c=_zm.copyOf(g),d=!0):a===zmail.zuid?(c=_zm.copyOf(l),d=!0):g[a]&&(c=_zm.copyOf(g[a]),d=!0),b&&a!==zmail.zuid&&(c[zmail.zuid]=_zm.copyOf(l),d=!0),d||(c=void 0),c},getGroupOrder:function(){return _zm.copyOf(h)},isGroupMember:function(a,b){var c=g[b];return!(!c||c.members.indexOf(a)===-1)},isGroup:function(a){return a&&"undefined"!=typeof g[a]},getEmailEnabledGroup:function(){var a={},b=g,c=0,d=h.length,e=2;for(c=0;c<d;c++)(zmail.trialUsers||!zmail.trialUsers&&b[h[c]].eid)&&!b[h[c]].disabled&&(a[h[c]]=$.extend({},b[h[c]]),a[h[c]].order=e,e++,zmail.trialUsers&&(e=3===c?e+1:e,c>3&&(a[h[c]].hideNode=!0)));return a[l.id]=$.extend({},l),a[l.id].name=zmText.get("zmContacts","common.label.streamsSelfGroup"),a[l.id].order=1,zmail.trialUsers&&d>4&&(a.more={name:"More ..",id:"more",order:6,txtNodeClass:"SC_thm",rowTitle:"View all groups"},a.less={name:"Less ..",id:"less",order:e++,hideNode:!0,txtNodeClass:"SC_thm",rowTitle:"Hide groups"}),a},changeUnread:function(a,b,c){y(a,b,c)},addGroup:function(a,b){g[a]||(g[a]=b,h?h.unshift(a):h=[a],$.publish("group/added",{groupID:a}))},removeGroup:function(a){a&&(h.splice(h.indexOf(a),1),delete g[a])}},P={indices:function(){return c},orgIndices:function(){return e},zidList:function(){return f},tempcont:function(){return d},initialize:function(a){a=a||{},c=a.indices||{},e=a.orgIndices||{},d[100]=1,f=a.zidArr||{}}},Q=function(a){a=a||{};var b=a.email,c=a.name||a.email,d=zmail.Utils.EmailValidator;if(b&&d.validate(b).status){var e=t(b),f={eid:b,fn:c};s(e,[f])}},R=function(){var a=o;if(p&&q)return a.promise();var b=$.Deferred().resolve(),c=zmCont.contacts(500);zmail.isOrg&&(b=zmCont.contacts(100));var d=function(){p&&q&&a.resolve()};return c.done(function(){p=!0,d()}).fail(function(){_zm.succErrMsg("e","Could not load Personal contacts"),a.reject()}),b.done(function(){q=!0,d()}).fail(function(){_zm.succErrMsg("e","Could not load Organisation contacts"),a.reject()}),a.promise()},S=function(a){a=a||{},a.contacts=a.contacts||[],a.contacts.constructor!==Array&&(a.contacts=[a.contacts]),a.contacts.forEach(function(a){if(a=a||{},a.eid){var b=a.eid.charAt(0);b=t(b),s(b,[a])}})},T=function(){$.subscribe("compose/addToContacts",function(a,b){Q({email:b.email,name:b.name})}),$.subscribe("contacts/insert",function(a,b){S(b)}),$.subscribe("group/member/removed",function(a,b){b=b||{};var c=b.group,d=b.member,e=g[c];e&&(String(e.owner)===String(d)&&(e.owner=-1),zmail.zuid===d&&(e.isOwner=!1))}),$.subscribe("group/moderator/removed",function(a,b){b=b||{};var c=b.group,d=b.moderator,e=g[c];e&&(String(e.owner)===String(d)&&(e.owner=-1),zmail.zuid===d&&(e.isOwner=!1))}),$.subscribe("group/moderator/added",function(a,b){b=b||{};var c=b.group,d=b.moderator,e=g[c];e&&zmail.zuid===d&&(e.isOwner=!0)})},U=function(a,b){var c=g[a];if(!c)return!1;c.members=c.members||[];var d=c.members.indexOf(b);return d===-1&&(c.members.push(b),$.publish("group/member/added",{group:a,member:b}),!0)},V=function(a,b){var c=g[a];if(!c)return!1;c.members=c.members||[];var d=c.members.indexOf(b);return d!==-1&&(c.members.splice(d,1),$.publish("group/member/removed",{group:a,member:b}),!0)},W=function(a,b){var c=g[a];if(!c)return!1;c.moderator=c.moderator||[];var d=c.moderator.indexOf(b);return d===-1&&(c.moderator.push(b),$.publish("group/moderator/added",{group:a,moderator:b}),!0)},X=function(a,b){var c=g[a];if(!c)return!1;c.moderator=c.moderator||[];var d=c.moderator.indexOf(b);return d!==-1&&(c.moderator.splice(d,1),$.publish("group/moderator/removed",{group:a,moderator:b}),!0)},Y=function(a,b){a=a||[],b=b||{};var c=$.Deferred(),d={},e=[],f=!b.hasOwnProperty("request")||b.request;return a.forEach(function(a){var b=$.Deferred();e.push(b);var g=zmail.Utils.EmailValidator.validate(a);return g.status?void zmCont.getContactInfo({email:a,request:f}).done(function(c){d[a]=c,b.resolve()}).fail(function(){var c=zmCont.getContactInfo({email:a,org:!0});if(c)d[a]=c;else{var e=zmail.Utils.EmailParser.parse(a)[0];d[a]={firstName:e.name,emailAddress:a,photoURL:zmail.defaultPhoto,isPsuedoContact:!0}}b.resolve()}):(window.console.log("invalid email",a),window.console.trace(),void c.reject())}),$.when.apply($,e).done(function(){c.resolve(a.map(function(a){var b=d[a],c=zmail.Utils.EmailParser.parse(b.firstName)[0];return c&&c.valid&&(b.firstName=c.name),b}))}),c.promise()};O._store=P,O.loadContacts=R,O.getOrgContactInfo=H,O.searchORGContacts=J,O.searchORGContactsAsync=K,O.getContactsForEmailList=Y,O.fetchContacts=N,O.insertContacts=S,O.fetchProcess=o.promise(),T(),O.initGroups=r,O.GroupAPI={addMember:U,removeMember:V,addModerator:W,removeModerator:X},a.zmCont=O}(window),function(a){"use strict";var b=zmail.Utils.EmailValidator,c=function(a){a=a||"";var c=b.validate(a);return zmail.debug&&!c.status&&window.console.log("Invalid Email-Address - "+a+" - "+c.errorMessage),c.status},d=function(a,b){b=b||{};var c=/(?:\(([^)]+)\))/gim;a=a||"",a=a.trim(),b.keepHTMLEntity||(a=zmUtil.replaceHTMLEntities(a));var d=zmail.Utils.EmailParser,e=d.parse(a),f=[];return f=e.map(function(a){var b=a.name;b=b.trim();var d=c.exec(b);d=d?d[1]:"",b=b.replace(c,"");var e={fn:b,eid:a.email,nn:d};if(a.valid){e["class"]="SC_cs";var f=zmail.ContactBook.get({promise:!1,eid:a.email,type:["personal","org"]})[0];f&&(e.photo=f.photo(!0))}else e["class"]="SC_cs zmerr",e.invalid=!0;return e})},e=function(a,b){a=a||{},b=b||{};var c="",d=a.firstName,e=a.lastName,f=a.nickName,g="",h=a.email||a.emailAddress;return d=(d||"").trim(),e=(e||"").trim(),f=(f||"").trim(),d&&(g+=d),e&&(g+=" "+e),f&&(f="("+f+")",g+=" "+f),g=g.trim(),h=(h||"").trim(),h&&(h="<"+h+">"),g?(g='"'+g+'"',c=g+" "+h):c=h,b.keepHTMLEntity||(c=zmUtil.replaceHTMLEntities(c)),c},f=function(a,b,c){return a?(b=b||"object","object"!==b&&(a.ph=a.photo,a.name=a.fn,a.cls=a["class"],a.attr={"data-eid":a.email},a=zmConUtil.bubbleUtil(a,b,c)),a):null},g=function(a,b,c){return a=a||[],a.map(function(a){return f(a,b,c)}),a},h={HEADER:['<li ref="wrapper" class="">',"<div>",'<span id="crm_contactname"><b ref="name" class="contact-name"></b></span>','<span ref="email" style="display: inline; vertical-align: middle;"></span>',"</div>",'<div ref="avatarWrapper" class="avatar-wrapper"></div>',"</li>"].join(""),SEPARATOR:['<li class="SC_lne list-separator"></li>'].join(""),LISTITEM:['<li class="list-item"></li>'].join("")},i=function(a){a=a||{};var b=a.dom||a.anchor,c=a.items||[],d=[],e=a.event,f=a.source||"",g=a.email||"",i=a.name||g||"",j=a.zuid||"",k=a.gid||"",l=j||k||a.zid||"";if(e&&zmUtil.stopEvents(e),$(b).length){!g&&$(b).length&&(g=$(b).attr("data-eid"),g=g||""),!l&&$(b).length&&(l=$(b).attr("data-uid")||$(b).attr("z")||$(b).attr("data-zid"),l=l||"");var m=null,n=null,o=null,p=null,q="",r={};if(j)r={zuid:j};else if(k)r={gid:k};else if(l){var s=!1;zmail.ContactBook.isGroup(l)&&zmail.zuid!==l&&(s=!0),s?(r={gid:l},k=l):(r={zuid:l},j=l)}else g&&(r={email:g});r.zuid?m=zmail.ContactBook.get({promise:!1,zuid:r.zuid,type:["personal","org"]})[0]:r.email?m=zmail.ContactBook.get({promise:!1,eid:r.email,type:["personal","org"]})[0]:r.gid&&(m=zmail.ContactBook.getGroups(r.gid)[0]),n=m,n&&(q=n.type),q=q||"personal",m=m?$.extend({displayName:[m.attrs.fn,m.attrs.mn,m.attrs.ln,m.attrs.nn?"("+m.attrs.nn+")":""].join(" "),emailAddress:m.attrs.eid},m.attrs):null,m?(m.found=!0,g=g||m.emailAddress):m={found:!1},m.personalContact="personal"===q,m=$.extend({displayName:i||g,emailAddress:g},m),m=$.extend(m,{emailAddress:g,eid:g});var t=zmail.Utils.EmailParser.parse(m.displayName);t=t[0]||{},!m.found&&t.valid&&(m.displayName=a.displayName||t.name||m.displayName,i=m.displayName);var u=$(h.HEADER),v=_zm.getDOMReferenceMap(u,!0);$(v.name).text(m.displayName),$(v.email).text(m.emailAddress||""),r.displayName=m.displayName,r.type="dom",r.email&&(r.email=m.emailAddress);var w=n?n.avatar():zmail.ContactBook.Templates.avatar({isValidPhoto:!1,initials:zmail.ContactBook.Utils.initials(m.displayName),avatarBgColor:zmail.ContactBook.Utils.colorClasses()});o=$.Deferred().resolve(w).promise(),o.done(function(a){p=$(a),$(v.avatarWrapper).prepend(p)}),zmail.wmsAPI.showPresence(m.emailAddress,$(v.avatarWrapper));var x=$(h.SEPARATOR);$.publish("contacts/openingCard",{source:f,insertItems:function(a){a=a||[],c=c.concat(a)}}),d.push(u[0]);var y=zmail.isPeopleUser!==!1&&zmail.isPeopleIntegEnabled&&(j||l||g);y&&d.push('<li class="nohr peopleLoading"><div class="SC_ctpro" id="peopleInfo"><div class="loading_dots"><span></span><span></span><span></span><span></span></div></div></li>');var z=j||l||m&&m.zid;z&&z!==zmail.zuid&&"undefined"!=typeof WebMessanger&&zmail.wmsAPI.addChatIcons(z,$(v.email).parent()),c.length&&d.push(x[0]),c.forEach(function(a,b){if(a=a||{},a.id=a.id||"opt_"+b,a.show!==!1&&m[a.show]===a.value){var c=$(h.LISTITEM);c.attr({id:a.id}),c.text(a.htm),"function"==typeof a.clk&&(a.args=a.args||[],a.args.unshift(m),_zm.bind(c[0],"click",a.clk,a.args)),d.push(c[0])}});var A={par:b,showArrow:!0,liDom:d,ulClass:"SC_P2r",spanClass:"SC_ctdtl"},B=new zmDropDownMenu;if(B.setDropObj(A),B.paint(),y&&zmAppLoader.load("peopleinteg").done(function(){var a=function(){B.$el.find(".peopleLoading").remove(),setTimeout(function(){B.position()},200)},b={zuid:j||l,email:g};zmail.peopleInteg.util.getProfileInfo(b).done(function(){var c=b.zuid||zmail.peopleInteg.aliasZuid[g.toLowerCase()];if(c&&zmail.peopleInteg.peopleData[c]){var d=B.$el.find(".contact-name");B.$el.find("#peopleInfo").html(zmail.peopleInteg.view.contactCardView(c));var e="//people."+zmail.zohoUrl+"/hr#home/dashboard/profile-userId:"+zmail.peopleInteg.peopleData[c].erecno;d.html("<a class='SC_thm' target='_blank' href='"+e+"'>"+d.text()+"</a>"),zmail.peopleInteg._core.getCheckinStatus(c).done(function(a){if(a&&void 0!==a.isUserAvailable){var b="<span class='SC_peoSts"+(a.isUserAvailable?" active'":" leave'")+"><span>"+(a.isUserAvailable?"In":"Out")+"</span></span>";d.append(b)}})}else a()}).fail(function(){a()})}),zmail.isInternalOrgUser&&zmail.isCRMServiceUser&&g){g=g.toLowerCase(),zmail.crmInteg=zmail.crmInteg||{};var C=function(){B.$el.find("#crm_contactname").append("<a target='_blank' class='SC_frt SC_thm' href='//"+zmail.urls.crmURL+"/crm/EntityInfo.do?module="+zmail.crmInteg.crmData[g].MODULE+"&id="+zmail.crmInteg.crmData[g].SEID+"'><i class='msi-crm'></i></a></span>"),zmComponent.tooltip({elm:B.$el.find(".msi-crm")[0],text:zmText.get("preUtils").integration.crm.viewincrm,arrow:"top"})};zmail.crmInteg.crmData&&void 0!==zmail.crmInteg.crmData[g]?zmail.crmInteg.crmData[g]&&C():zmail.Integrations.CRM.Contacts.request(g).done(function(a){zmail.crmInteg.crmData=zmail.crmInteg.crmData||{},zmail.crmInteg.crmData[g]=a[0]||!1,a[0]&&C()})}if((!g||m.found&&m.personalContact)&&$("#zms_add").hide(),l){var D=_zm("#","zm_dropDown");_zm.setAttr(D,{zid:l})}}},j=function(a){var b=$.Deferred();a=a||{};var c=a.dom||a.anchor,d=a.email||"",e=a.zuid||"",f=a.gid||"",g=a.zid||"";if(!d&&$(c).length&&(d=$(c).attr("data-eid"),d=d||""),!g&&$(c).length&&(g=$(c).attr("data-uid")||$(c).attr("z")||$(c).attr("data-zid"),g=g||""),g&&zmail.ContactBook.getGroups(g)[0]?f=g:e=g,e&&!d){var h;h=zmail.ContactBook.get({promise:!1,zuid:e,type:["org"]})[0],h=h?$.extend({emailAddress:h.attrs.eid},h.attrs):null,h&&(d=h.emailAddress)}if(f){var j;j=zmail.ContactBook.getGroups(f)[0],j=j?$.extend({emailAddress:j.attrs.eid},j.attrs):null,j&&(d=j.emailAddress)}return d?zmail.ContactBook.get({eid:d}).always(b.resolve):b.resolve(),b.always(function(){i(a)}),b.promise()},k={splitncheck:function(a,b,c){var e=d(a);return g(e,b,c)},fillImgSrc:function(a,b){var c,d=[];if(b){$.isArray(b)?d=b:d.push(b),c=d.length;for(var e=0;e<c;e++)"IMG"===$(d[e]).get(0).tagName?$(d[e]).attr("src",a):$(d[e]).children("img").attr("src",a)}},fillContDet:function(a,b){var c,d=b.mode,e=a[d],f=b.eid,g=b.elm;if(void 0!==e){if($.publish("contacts/insert",{contacts:e}),$.isArray(e)){for(var h=0;h<e.length;h++)if(e[h].eid===f){c=e[h];break}}else c=e;c.photo&&""!==c.photo&&zmConUtil.fillImgSrc(c.photo,g)}},bubbleUtil:function(){var a='<div class=""><img src="" /><span></span><i class=""></i></div>';return function(b,c){var d,e,f,g,h,i;c=c||{},b=b||{},b.cls=b.cls||"SC_cs",b.attr=b.attr||{},b.eid=b.eid||"",b.ph=b.ph||zmail.defaultPhoto,b.name=b.name||"",b.iclass=b.iclass||"",b.img=b.img||!1,b.ret=b.ret||"string",f=$(a)[0],g=f.childNodes[0],h=f.childNodes[1],i=f.childNodes[2],$(f).attr("class",b.cls),$(f).attr("title",b.eid);for(d in b.attr)$(f).attr(d,b.attr[d]);return $(g).attr("src",b.ph),e=zmUtil.replaceHTMLEntities(b.name),$(h).text(e),$(i).attr("class",b.iclass),b.img||$(g).remove(),b.iclass||$(i).remove(),"function"==typeof c.modifyDOM&&c.modifyDOM({contact:b,dom:f}),"dom"===b.ret?f:"string"===b.ret?f.outerHTML:void 0}}(),loadCompose:function(a,b){zmUtil.hideMenu();var c="";a.fn&&(c+=a.fn),a.ln&&(c+=" "+a.ln),a.eid&&(c+="<"+a.eid+">"),zmUtil.compose({TO:c}),_zm.stopEvents(b)},listMails:function(a){if(a.eid){var b;zmSearchUtil.isNewSearch()?(b=[{className:"Sender",value:a.eid}],zmail.Search.setContext(zmail.Search.Models.Contexts.mailSearchContext),zmail.Search.newSearch(b)):(b={searchQueryArr:[{lhs:"Sender",contains:!0,value:a.eid}]},zmSearch.setPrevAppSearch("m"),zmSearch.addSearch(b)),zmUtil.hideMenu()}},listAttachment:function(a){a.eid&&(zmUtil.listAttachmentInAttSearchView({type:"s",srchStr:a.eid}),zmUtil.hideMenu())},createChat:function(a){var b;zmUtil.hideMenu(),"string"==typeof a?b=a:a.zid&&(b=a.zid),b&&zmAjq.XHR({u:zmail.conPath+"/util.do",t:"GET",p:{mode:"createChat",recipient:b}})},checkemail:c,addToContacts:function(a){var b=$.Deferred(),c={mobile:"MOBILE_ph",home:"HOME_ph",work:"WORK_ph",fax:"FAX_ph",others:"OTHERS_PH"};if(a=a||{},a.firstName=a.firstName||"",a.middleName=a.middleName||"",a.lastName=a.lastName||"",a.nickName=a.nickName||"",a.email=a.email||"",a.phone=a.phone||"",a.phoneType=c[a.phoneType]?a.phoneType:"others",!a.email)return b.reject({code:1,msg:zmText.get("zmContacts","utility.message.validEmailNeeded")}),b.promise();a.firstName||a.middleName||a.lastName||(a.firstName=a.email),a.phone||(a.phoneType="");var d={url:"/mail/addContact.do",data:{accId:[zmail.accId,""].join(""),xhr:[Date.now(),""].join(""),zmrcsr:zmAjq.getCookie("zmcsr"),cfN:a.firstName,cmN:a.middleName,clN:a.lastName,cnN:a.nickName,ceA:a.email,cpN:a.phone,cphT:c[a.phoneType]},type:"POST",success:function(c){c=c[0]||{},c=c.zmrsp||"",c=c.replace(/'/gim,""),c?b.resolve({contact:a}):b.reject({code:3,msg:zmText.get("zmContacts","utility.message.contactAvailable")})},error:function(){b.reject({code:2,msg:zmText.get("zmContacts","utility.message.addContactTryAgain")})}};return $.ajax(d),b.promise()},handleAddToContact:function(a,b){a=a||{},_zm.succErrMsg("i",zmText.get("zmContacts","utility.message.addingContact"),{hideAfter:1e3}),zmConUtil.addToContacts({email:a.eid,firstName:a.fn}).done(function(a){a=a||{};var c=a.contact;c&&c.email&&$.publish("contacts/insert",{contacts:[{eid:c.email,fn:c.firstName}]}),_zm.succErrMsg("s",zmText.get("zmContacts","utility.message.addContactSuccess")),$(b.target).fadeOut()}).fail(function(a){a=a||{};var c="e";3===a.code&&($(b.target).fadeOut(),c="i");var d=a.msg||zmText.get("zmContacts","utility.error.unknownError"),e=zmText.get("zmContacts","utility.message.addContactFail",{errorReason:d});_zm.succErrMsg(c,e)})},parseContacts:d,constructContact:e};k.getFormattedContactObj=function(a){a=a||{};var b={emailAddress:a.eid,firstName:a.fn||"",lastName:a.ln||"",nickName:a.nn||"",photoURL:a.photo,zohoUserID:a.zid};return b&&b.photoURL&&(b.photoURL+=(b.photoURL.indexOf("?")===-1?"?":"&")+"API=true"),b.displayName=[b.firstName,b.lastName].join(" ").trim()||b.nickName||b.emailAddress,b._json=a,b},k.showDet=j,k.showContactCard=j,a.zmConUtil=k}(window),function(){"use strict";var a=zmail.Core.Namespaces,b=a.create("zmail.Integrations.CRM.Contacts"),c=zmail.conPath+"/crm/internal/json/Info/getACRecords",d=3,e=!0,f={},g=zmail.Utils.DeferredCollection.create({keepDeferreds:!1}),h=function(a){var b=$.Deferred();return(e=zmail.isCRMServiceUser)?($.ajax({url:c+"?searchWord="+a,type:"post",success:function(a){if(a=a||[],a.constructor!==Array){var c=a.response||{};c.error&&4102===c.error.code&&(e=!1,b.reject())}else b.resolve(a)},error:function(){b.reject()}}),b.promise()):b.reject().promise()},i=function(a,b){a=a||"";var c="";c=a.trim().toLowerCase();var e=!g.has(c),i=g.get(c);if(!c||c.length<d)return $.Deferred().reject().promise();if(b&&(f[c]=null),f[c])return i.resolve(f[c]).promise();if(e){var j=f[c.substring(0,3).toLowerCase()];if(j&&!j.length)return f[c]=[],i.reject().promise();h(c).done(function(a){a=a||[],f[c]=a,i.resolve(a)}).fail(function(){f[c]=[],i.reject()})}return i.promise()},j=function(a){var b=this;a=a||{},b.id=a.id,b._requestDelay=a.delay||1e3,b._searchKey="",b._requestID=null,b._deferred=null};j.prototype.search=function(a,b){var c=this;a=a||"";var e="";return e=a.trim().toLowerCase(),!e||e.length<d?$.Deferred().reject().promise():(0===e.indexOf(c._searchKey)&&(c._deferred&&(c._deferred.reject(),c._deferred=null),clearTimeout(c._requestID)),c._searchKey=e,c._deferred=$.Deferred(),c._requestID=setTimeout(function(){i(a,b).done(function(a){c._deferred.resolve(a)}).fail(function(){c._deferred.reject()})},c._requestDelay),c._deferred.promise())},b.request=i,b.DelayedRequestor=j,b._getCache=function(){return f}}(),zmail.wmsAPI=function(){"use strict";var a=zmText.get("zmContacts","utility.chat")||{},b={1:a.available,4:a.idle,0:a.offline,3:a.busy,2:a.invisible,"-1":a.unapproved},c={1:"available",2:"invisible",3:"busy",4:"idle",0:"offline"},d=function(){return{UNKNOWN:-2,UNAPPROVED:-1,OFFLINE:0,AVAILABLE:1,INVISIBLE:2,BUSY:3,IDLE:4}},e=function(){return"undefined"!=typeof WmsContacts},f=function(a){var b=$.Deferred();return a=a||{},a.email&&zmail.ContactBook.get({str:a.email,promise:!0}).always(function(a){var c=a.length?a[0].attrs:{};b.resolve(c)}),b.promise()},g=function(a){a=a||{};var e=a.status,f=a.zuid||a.gid||a.zid,g=["<i></i>"].join(""),h=d();"undefined"==typeof e&&(e=h.UNKNOWN),e=[e,""].join("");var i=["statusIcon"],j=b[e],k=c[e]||"";i.push(k),i=i.join(" ");var l=$(g);return l.addClass(i),l.attr({title:j}),e!==[h.UNKNOWN,""].join("")&&e!==[h.UNAPPROVED,""].join("")||l.hide(),a.openChatOnClick!==!1&&l.on("click",function(a){_zm.stopEvents(a),zmConUtil.createChat(f)}),l[0]},h=function(a,b){a&&"undefined"!=typeof WebMessanger&&(zmAjq.XHR({u:"/zm/util.do",p:{ctype:b,mode:"createChat",recipient:a},t:"GET"}),"audio"===b?WebMessanger.startAudioCall(a):"video"===b?WebMessanger.startVideoCall(a):"chat"===b&&WebMessanger.chat(a))},i=function(b,c){if(c){var d=$('<div class="zmCCchatInteg"><i title="'+a.startChat+'" class="msi-cliq zmThmHvrClr" data-type="chat"></i><div class="SC_SDot"></div><i title="'+a.audio+'" class="msi-audioCall zmThmHvrClr" data-type="audio"></i><div class="SC_SDot"></div><i title="'+a.video+'" class="msi-videoCall zmThmHvrClr" data-type="video"></i></div>');$(c).append(d),$(d).click(function(a){zmUtil.hideMenu(),h(b,$(a.target).data("type"))})}},j=function(a,d){var e;try{e=WmsContacts.status(a)}catch(f){}$(d).hasClass("SC_avtr")||(d=$(d).find(".SC_avtr"));var g=c[e]||"",h=_zm.getDOM(["I",{attrs:{"class":["statusIcon",g].join(" "),title:b[e]}}]);h=_zm.getDOM(h),d.length&&g&&($(d).after(h),$(h).click(function(b){_zm.stopEvents(b),zmConUtil.createChat(a)}))},k={STATUS_CONSTANTS:d(),getPresenceAsync:f,getPresenceIcon:g,addChatIcons:i,showPresence:function(a,b){if(a=(a||"").trim(),!e()||!a)return null;var c,d=zmail.Utils.EmailValidator.validate(a);d&&d.status?f({email:a}).done(function(a){a&&a.zid&&(c=a.zid,j(c,b))}):$.isNumeric(a)&&(c=a,j(c,b))}};return k}();