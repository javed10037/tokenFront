define([],function(a){"use strict";var b,c,d=a("_zm"),e=a("$"),f=a("zmText"),g=a("zmAjq"),h=a("zmAppLoader"),i=a("zmail.Core.Namespaces"),j=i.create("zmApp"),k=!1;zmail.extAppsDeferred={},zmail.extAppsDeferred.contacts={},zmail.extAppsDeferred.calendar={};var l=function(){var b=a("zmsuite"),c=a("zmInit"),d=a("zmTab");if(b.isWorkspaceAvailable("zm_Container")){var e=b.getAppObj("zm_Container");d.setTabForApp(e.obj),b.showApp("zm_Container"),b.getLeft().setListener("click",function(a){c.bindLeftActions(a)}),b.getLeft().setListener("contextmenu",function(a){c.bindLeftActions(a)}),b.getLeft().getNodes()[0].getLayer("zmlTreeH").setChildToggle(c.viewChild)}else c.initMailSuite()},m=function(b){var c,d=a("zmsuite"),e=a("zmTab");if(d.isWorkspaceAvailable("zm_notes")){var f=d.getAppObj("zm_notes");c=a("znNote"),e.setTabForApp(f.obj),d.showApp("zm_notes"),c.showNotesApp(b)}else h.load("notes").done(function(){c=a("znNote"),zmail.ContactBook.fetchProcess.done(function(){c.notesLoad(b)})})},n=function(){var b,c=a("zmsuite");c.isWorkspaceAvailable("zm_task")?(b=a("zmTask"),b.init()):h.load("task").done(function(){b=a("zmTask"),b.init()})},o=function(){var b=a("zmsuite"),c=a("zmLink");b.isWorkspaceAvailable("zm_links")?c.App.Core.init():h.load("links").done(function(){zmail.ContactBook.fetchProcess.done(function(){c.App.Core.init()})})},p=function(){var a;if(a=e.Deferred(),b)a.resolve(b);else{var c=function(){d.succErrMsg("e",f.get("appsframework","calendarError")),a.reject()};g.XHR({u:"/mail/ncal/loadjs.do",t:"GET",fn:function(b){a.resolve(b)},onerror:c})}return a},q=function(){var a;return a=e.Deferred(),e.when(p()).then(function(c){b=c,a.resolve()}),a},r=function(a){if(zmail.extAppsDeferred.calendar[a])return zmail.extAppsDeferred.calendar[a].promise();var c=e.Deferred();return e.when(q()).then(function(){var d,e;d=b.jsPath||zmail.urls.calURL,e=b.cssPath||zmail.urls.calURL,b[a].css&&h.constJS(b[a].css,"//"+e,"css"),h.constJS(b[a].js,"//"+d,"js").done(function(){c.resolve()})}),zmail.extAppsDeferred.calendar[a]=c,c.promise()},s=function(){e.when(p()).then(function(a){var b=a.cssPath||zmail.urls.calURL;a.calendar.css&&h.constJS(a.calendar.css,"//"+b,"css")})},t=function(){var a;if(a=e.Deferred(),c)a.resolve(c);else{var b="/zm/zc/new/jsp/loaded.jsp";g.XHR({u:b,t:"GET",fn:function(b){a.resolve(b)},xhr:!1})}return a},u=function(){var a;return a=e.Deferred(),e.when(t()).then(function(b){c=b,a.resolve()}),a},v=function(a){if(zmail.extAppsDeferred.contacts[a])return zmail.extAppsDeferred.contacts[a].promise();var b=e.Deferred();return e.when(u()).then(function(){var d,f;d=c.jsPath,f=c.cssPath,c[a].css&&h.constJS(c[a].css,f,"css"),h.constJS(c[a].js,d,"js").done(function(){e.publish("contacts/metaDataLoaded",{data:c.metaJson}),b.resolve()})}),zmail.extAppsDeferred.contacts[a]=b,b.promise()},w=function(a){r("streamEvent").done(function(){"function"==typeof a&&a()})},x=function(a,b){r("calendar").done(function(){e.publish(a,[b])})},y=function(a){k?a&&e.publish(a):v("contacts").done(function(){k=!0,a&&e.publish(a)})},z=function(){r("picker"),y()},A=function(){var a=e.Deferred();return u().done(function(){r("setting").done(a.resolve).fail(a.reject)}).fail(a.reject),a.promise()};e.extend(!0,j,{selectionClass:"SC_mailApp",currentApp:"m",selectApp:function(a){if(a&&!zmail.fromOtherService)switch(a){case"m":zmail.accId===zmail.defAccId?zmail.appList.appObj.mail.selectApp():zmail.appList.accListObj[zmail.accId]&&zmail.appList.accListObj[zmail.accId].selectAccount();break;case"n":zmail.appList.appObj.notes.selectApp();break;case"t":zmail.appList.appObj.task.selectApp();break;case"c":zmail.appList.appObj.cal.selectApp();break;case"cn":zmail.appList.appObj.contacts.selectApp();break;case"l":zmail.appList.appObj.links.selectApp()}},showApp:function(b,c){var g=a("zmUtil");g.hideMenu();var h=f.get("appsframework","createText"),i="SC_mailApp";j.selectedApp=b,"m"===b?(h=d.isSmartComposeEnabled()?f.get("appsframework","smartCompose"):f.get("appsframework","composeText"),l()):"n"===b?(h=f.get("appsframework","createNote"),m(c),i="SC_noteApp"):"t"===b?(h=f.get("appsframework","createTask"),n(),i="SC_taskApp"):"c"===b?(h=f.get("appsframework","createEvent"),x("/calendar/load"),i="SC_calApp"):"cn"===b?(h=f.get("appsframework","createContact"),y("/contacts/load"),i="SC_contApp"):"l"===b&&(h=f.get("appsframework","createLink"),o(),i="SC_linkApp"),j.selectApp(b),e(".zm_comp span").eq(0).text(h),e("body").removeClass(j.selectionClass).addClass(i),j.selectionClass=i,j.currentApp=b},loadCalendar:x,loadCalendarJS:q,loadPicker:z,loadStreamEvent:w,loadCalendarCSS:s,loadCalendarSettingsResources:A});var B=function(){e.when(zmail.postJsDeffered).then(function(){j.loadPicker()})};return B(),j});