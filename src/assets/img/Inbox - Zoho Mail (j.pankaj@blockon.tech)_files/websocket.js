"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}define([],function(){var a=zmail.Core.Namespaces,b=a.create("zmail.Components.WebSocket"),c={};return c.ERROR_CODES={INTERNAL_SERVER_ERROR:1011,AUTH_FAILED:4001,TOO_MANY_CONNECTIONS:4002,TOO_MANY_SESSIONS:4004,EMPTY_TICKET:4006},c.SERVICE_NAME="VirtualOffice",c.SERVER_NAME="ws",c.IDLE_MSG="?-",c.isSupported="WebSocket"in window||"MozWebSocket"in window,b.constants=c,c});var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();define([],function(a){var b=a("zmail.Components.WebSocket"),c=100,d=function(){function b(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:c;_classCallCheck(this,b);var d=this;d.maxSize=a,d._logs=[],d._currentSize=0}return _createClass(b,[{key:"push",value:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},c=this;c._currentSize>=c.maxSize&&c.pop(),c._logs.push({msg:a,time:new Date,opts:b}),c._currentSize++}},{key:"pop",value:function(){var a=this;if(a._currentSize>0)return a._currentSize-=1,a._logs.shift()}},{key:"getLogs",value:function(){var a=this;return a._logs}},{key:"clear",value:function(){var a=this;a._logs.splice(0),a._currentSize=0}},{key:"toString",value:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},b=this,c=a.separator||"\n",d="";return b._logs.forEach(function(a){d+=a.time+"--> "+a.msg+c}),d}},{key:"downloadLog",value:function(){var b=this,c=a("zmComponent.downloadAsFile");c.download(b.toString(),{fileName:Date.now()})}},{key:"sendLogInMail",value:function(){var b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},c=this,d=b.mailId;a("zmUtil").compose({TO:d,CONTENT:c.toString({separator:"<br>"})})}}]),b}();return b.logger=d,d}),define([],function(a){var b=a("zmail.Components.WebSocket"),c={};return c.PUBSUB=a("zmail.Framework.Utils.PUBSUB"),b.Util=c,c.PUBSUB});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();define([],function(a){var b=a("zmUtil"),c=a("zmComponent"),d=zmail.Core.Namespaces,e=d.create("zmail.Components.WebSocket"),f=e.logger,g=e.Util.PUBSUB,h={PONG_MSG:"--/--",REFRESH_VIEW:"FRH"},i={SEQ_NO:"s",MSG_DATA:"m",SET:"set",MODULE:"mod",LATEST_SEQ:"ls",PUSH_MSG_TYPE:"type"},j=function(){function a(){var b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,a);var c=this;c._latestSeqNo=Number(b.latestSeqNo)||-1,c._refreshReceived=!1,c._pubsub=new g,c._logger=new f(200)}return _createClass(a,[{key:"setLatestSeqNo",value:function(a){b.debugLog("WS :: Seq number updated: "+a),this._latestSeqNo=Number(a)}},{key:"getLatestSeqNo",value:function(){return this._latestSeqNo}},{key:"subscribePushMsg",value:function(a,b){var c=this;c._pubsub._subscribeHandler(a,b)}},{key:"unsubscribePushMsg",value:function(a,b){var c=this;c._pubsub._unsubscribeHandler(a,b)}},{key:"isSeqNumReceivedValid",value:function(a){var c=this,d=c._refreshReceived,e=c.getLatestSeqNo();return a=Number(a),d&&(c._refreshReceived=!1),b.debugLog("WS :: New Seq num received "+a),!(e!==-1&&e!==a-1&&!d)}},{key:"parseAndReturnValidJSON",value:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",c={};try{c=$.parseJSON(a)}catch(d){b.debugLog("WS :: Invalid msg format")}return c}},{key:"_processSeqNumber",value:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},d=this,e=d.getLatestSeqNo();return d.isSeqNumReceivedValid(a)?(d.setLatestSeqNo(a),b.hasOwnProperty(i.MODULE)&&d.handleNotificationPush(b)):e>=Number(a)?c.duplicateNotification=!0:(c.invalidSeqNo=!0,c.lastAckedSeqNo=d.getLatestSeqNo()),c}},{key:"_processLatestSeqMessage",value:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},c=this,d=c.getLatestSeqNo();d===-1?c.setLatestSeqNo(a):Number(a)>d||Number(a)<d?(b.invalidSeqNo=!0,b.lastAckedSeqNo=c.getLatestSeqNo()):b.duplicateNotification=!0}},{key:"_handlePushMessages",value:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},c=(arguments[2],this);if("push"===a){var d=b[i.MODULE];d&&c._pubsub.publish(d,b)}}},{key:"handleNotificationPush",value:function(a){var d={};if(a.hasOwnProperty(i.MSG_DATA))try{d=$.parseJSON(a[i.MSG_DATA])}catch(e){b.debugLog("Invalid format Received")}d&&("object"===("undefined"==typeof d?"undefined":_typeof(d))&&(d.newWS=!0),c.notifier.push(d,{module:a[i.MODULE]}))}},{key:"processMsg",value:function(a){var c,d,e,f,g=this,j={},k=a.data;return k!==h.PONG_MSG&&g._logger.push(k),k===h.PONG_MSG?(b.debugLog("WS :: Pong Messsage Received"),j):k===h.REFRESH_VIEW?(g._refreshReceived=!0,j.refreshView=!0,j):0===k.indexOf(h.REFRESH_VIEW)?(j.refreshView=!0,g.setLatestSeqNo(k.split(":")[1]),j):(c=g.parseAndReturnValidJSON(k),c[i.SET]&&(j.sessionId=c[i.SET].cid),d=c[i.SEQ_NO],d||(e=c[i.LATEST_SEQ],f=c[i.PUSH_MSG_TYPE]),"undefined"!=typeof d?(b.debugLog("WS :: Msg Notifier publisher"+k),g._processSeqNumber(d,c,j)):"undefined"!=typeof e?g._processLatestSeqMessage(e,j):f&&g._handlePushMessages(f,c,j),j)}}]),a}();return e.WSMessageHandler=j,e});var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();define([],function(){var a=zmail.Core.Namespaces,b=a.create("zmail.Components.WebSocket"),c=b.WSMessageHandler,d=b.logger,e={WSS:"wss",WS:"ws",TIMEOUT_VAL:3e4,PING_MSG:"-?-",PONG_MSG:"--/--",REQ_MSG:"req",MAX_RECONNECT_PERIOD:90},f=function(){function a(){var b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,a);var f=this;f.serverName=b.serverName,f.path=b.path,f.idleMsg=b.idleMsg,f.callbacks=b.callbacks||{},f.protocol=b.secure?e.WSS:e.WS,f.pingTimeout=null,f.sessionId=null,f._retry=Boolean(b.handleRetry),f._messageHandler=new c,f.ws=null,f._logger=new d(100),f._consecutiveFailCount=0,f._reconnectPeriod=0,f._reconnectTimer=null,this.requestedSeqMap={},this._lastReceivedMsgTime=-1,this._idleConnectingTimer=null}return _createClass(a,[{key:"getSessionId",value:function(){return zmUtil.debugLog("session Id: "+this.sessionId),this.sessionId}},{key:"updateSessionId",value:function(a){var b=this,c=b.callbacks;b.sessionId=a,"function"==typeof c.onSessionIdUpdate&&c.onSessionIdUpdate(a)}},{key:"subscribePushMsg",value:function(a,b){var c=this;c._messageHandler.subscribePushMsg(a,b)}},{key:"unsubscribePushMsg",value:function(a,b){var c=this;c._messageHandlergeHandler.unsubscribePushMsg(a,b)}},{key:"getReconnectPeriod",value:function(){return this._reconnectPeriod}},{key:"setReconnectPeriod",value:function(a){zmUtil.debugLog("WS :: Set reconnect period: "+a),this._reconnectPeriod=a}},{key:"getLastReceivedMsgTime",value:function(){return this._lastReceivedMsgTime}},{key:"_setLastReceivedMsgTime",value:function(a){this._lastReceivedMsgTime=a}},{key:"_onOpen",value:function(a){var b=this,c=b.callbacks,d=b.getSessionId();b._onopenCalled=!0,b._clearTimeout(b._idleConnectingTimer),b._logger.push("WS :: Websocket connection opened"),zmUtil.debugLog("WS :: Websocket connection opened"),b._setLastReceivedMsgTime(-1),b.pingServer(),"function"==typeof c.onOpen&&c.onOpen(d,a)}},{key:"_onClose",value:function(a){var b=this,c=b.callbacks,d=b._retry;b._logger.push("closeEvent triggered",a),zmUtil.debugLog("WS :: Websocket connection closed"),b._clearTimeout(b._idleConnectingTimer),b._consecutiveFailCount+=1,"function"==typeof c.onClose&&(d=c.onClose(a)),d.retryStatus&&b.handleConnectionRetry(),d.closeStatus&&(b._lastClosedStatus=d.closeStatus)}},{key:"_onMessage",value:function(a){var b=this,c=b.callbacks;b._setLastReceivedMsgTime(Date.now()),0!==b._consecutiveFailCount&&(b._consecutiveFailCount=0,b.updateReconnectPeriod("reset"));var d=b._messageHandler.processMsg(a);b.handleMsgObject(d),"function"==typeof c.onMsg&&c.onMsg(a)}},{key:"disableRetry",value:function(){var a=this;a._retry=!1}},{key:"enableRetry",value:function(){var a=this;a._retry=!0}},{key:"updateReconnectPeriod",value:function(a){var b=this,c=b.getReconnectPeriod();"reset"===a?c=0:"inc"===a&&(0===c?c=1:c*=3),c>e.MAX_RECONNECT_PERIOD&&(c=e.MAX_RECONNECT_PERIOD),b.setReconnectPeriod(c)}},{key:"handleConnectionRetry",value:function(a){var b,c=this,d=c.getSessionId(),e=c.ws.readyState;return e!==WebSocket.CONNECTING&&e!==WebSocket.CONNECTED&&(b=0,a||(b=c.getReconnectPeriod(),c.updateReconnectPeriod("inc")),c._logger.push("WS :: Current Reconnect period "+b+"seconds"),zmUtil.debugLog("WS :: Current Reconnect period "+b+"seconds"),void(c._reconnectTimer=setTimeout(function(){return delete c._reconnectTimer,!c.isConnected()&&void c._initializeConnection(d)},1e3*b)))}},{key:"removeFromRequestedSeqMap",value:function(a){var b=this;delete b.requestedSeqMap[a]}},{key:"requestMissingNotifcations",value:function(a){var b,c=this;return!c.requestedSeqMap[a]&&(c._logger.push("request Missing Notification : "+a),b=c.send(e.REQ_MSG+":"+a),void(b&&(c.requestedSeqMap[a]=!0,setTimeout(function(){c.removeFromRequestedSeqMap(a)},3e3))))}},{key:"handleMsgObject",value:function(a){var b=this,c=b.callbacks;a.sessionId&&(b.updateSessionId(a.sessionId),zmUtil.debugLog("WS :: Session Id updated")),a.invalidSeqNo&&b.requestMissingNotifcations(a.lastAckedSeqNo),a.refreshView&&"function"==typeof c.onRefreshView&&c.onRefreshView()}},{key:"send",value:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",b=this;return!(!a||!b.isConnected())&&(b.ws.send(a),b.pingServer(),!0)}},{key:"_clearTimeout",value:function(a){clearTimeout(a)}},{key:"pingServer",value:function(){var a=this,b=a.getLastReceivedMsgTime();b>-1&&Date.now()-b>2*e.TIMEOUT_VAL&&(zmUtil.debugLog("No response from server for past 60 seconds"),a.close(!0)),a.pingTimeout&&a._clearTimeout(a.pingTimeout),a.pingTimeout=setTimeout(function(){a.send(e.PING_MSG)},e.TIMEOUT_VAL)}},{key:"close",value:function(a){var b=this;b.ws.onclose=void 0,b._reconnectTimer&&b._clearTimeout(b._reconnectTimer),b.ws.close(),a&&b._initializeConnection()}},{key:"_initializeEvents",value:function(){var a=this,b=a.ws;b.onopen=a._onOpen.bind(a),b.onclose=a._onClose.bind(a),b.onmessage=a._onMessage.bind(a)}},{key:"_initializeConnection",value:function(){var a=this,b=a.getConnectionPath();a._onopenCalled=!1;var c=new WebSocket(b);a._logger.push("Initialize connection called"),a._idleConnectingTimer=setTimeout(function(){a._logger.push("In Connecting state for too long. Closing and reconnecting"),a.close(),a._initializeConnection()},2e4),a.ws=c,a._initializeEvents()}},{key:"getConnectionPath",value:function(){var a=this,b=a.protocol+"://"+a.path+"/";return b+=a.serverName+"?zuid="+zmail.zuid,a.sessionId&&(b+="&cid="+a.sessionId),b}},{key:"isConnected",value:function(){var a=this,b=a.ws;if(b){var c=b.readyState;if(WebSocket.OPEN===c||WebSocket.CONNECTING===c)return!0}return!1}},{key:"init",value:function(){var a=this;if(a.ws){if(a.isConnected())return!1;a.close()}a._initializeConnection()}}]),a}();return b.WebSocketComponent=f,b}),define([],function(){var a=zmail.Core.Namespaces,b=a.create("zmail.Components.WebSocket.Module.Mail"),c=function(a,b){var c,d;try{c=$.parseJSON(b.m);var e=c.act;"MAIL_CONTENT"===e&&(d=$.parseJSON(c.res),zmContentCache.processResponse(d,d.M),zmContentCache.getCacheStore().put(d.MSGID,d))}catch(f){zmUtil.debugLog("Invalid format")}zmUtil.debugLog("In mail push msg handler : Data pushed from WS server "+b)},d=function(){var a=zmail._ws;a.subscribePushMsg("mail",c)};return b.init=d,b}),define([],function(a){var b,c,d=a("zmUtil"),e=zmail.Core.Namespaces,f=e.get("zmail.Components.WebSocket"),g=f.constants,h=zmail.wsServerURL,i=g.SERVICE_NAME,j=g.SERVER_NAME,k=g.IDLE_MSG,l=g.ERROR_CODES,m=!1,n=2e4,o=f.logger,p=new o(100),q=0,r=2e3,s=9e5,t=0,u=function(a){d.debugLog("Server Error"+a)},v=function(){d.debugLog("Too May Connections. Retry Connection will be initiated after dur: "+s),setTimeout(function(){zmail._ws.init()},s)},w=function(){var a=document.getElementById("zmwsconnect");a&&a.parentElement.removeChild(a),a=document.createElement("iframe"),a.id="zmwsconnect",a.style.display="none",a.src=zmail.urls.accURL+"/clogin?client_auth=true&servicename="+i+"&serviceurl="+location.protocol+"//"+h+"/connector?pd="+location.host+"&t="+Date.now(),a.onload=b,$("body").append(a)};b=function(a){p.push("iframe load success"),setTimeout(function(){return!(q>8)&&void(m?(p.push("Ticket generation success"),q=0,r=2e3):(q++,3*r>n?r=n:r*=3,p.push("Accounts Login Failure : Retry timer"+r),w()))},r)};var x=function(a){t=0},y=function(a){var b={},c=!0,d=a.code;if(d===l.AUTH_FAILED)c=!1,p.push("WS :: Authentication Failed"),m=!1,w();else if(d===l.TOO_MANY_CONNECTIONS)p.push("WS :: TOO MANY CONNECTIONS"),c=!1,b.closeStatus="TOO MANY CONNECTIONS",v();else if(d===l.INTERNAL_SERVER_ERROR)p.push("WS :: Internal Server Error"),b.closeStatus="INTERNAL SERVER ERROR",u(a);else if(d===l.TOO_MANY_SESSIONS)p.push("WS: Too Many user sessions"),b.closeStatus="TOO MANY SESSIONS",c=!1;else if(d===l.EMPTY_TICKET){p.push("WS: Empty ticket"),b.closeStatus="EMPTY TICKET";var e,f=document.getElementById("zmwsconnect");f?(e=2*t*1e3,e>9e4&&(p.push("WS: Empty ticket counter crossed 90s"),e=9e4),setTimeout(function(){f.contentWindow.postMessage("updTic",location.protocol+"//"+h)},e),t++):w(),c=!1}return d!==l.EMPTY_TICKET&&(t=0),b.retryStatus=c,b},z=function(){},A=function(a){$.publish("/ws/sessionIdUpdate",a)},B=function(a){var b,d=a.origin||a.originalEvent.origin;d==="https://"+h&&(b=a.data,"init"===b?(m=!0,zmail._ws.init()):0===b.indexOf("tic$$")&&(c=b.split("tic$$")[1]))},C=function(){window.addEventListener("message",B,!1)},D=function(){$.publish("zmailReconnect")},E=function(){C(),w()};return zmail._ws=new f.WebSocketComponent({serverName:j,path:h,idleMsg:k,secure:!0,callbacks:{onOpen:z,onClose:y,onMsg:x,onSessionIdUpdate:A,onRefreshView:D},handleRetry:!0}),g.isSupported&&E(),f.getWSTicket=function(){return c},f.Module.Mail.init(),f._connectionLogger=p,f});