window.zmStreamsApp=window.zmStreamsApp||{},window.zmStreamsApp.CommentModule=function(a){"use strict";var b=a.models,c=a.views,d=zmStreamsApp.constants.notifications,e=function(a,c){var d=["commentAdd"],e=c.gid+"#"+c.pid;if(d.indexOf(c.key)!==-1&&b.comments){var f=_.find(b.comments.models,function(a){return a.id===c.pid});f||(f=_.find(b.comments.models,function(a){return a.id===e})),f&&(c.data&&c.data.cmnt?f.updateModel({comment:c.data.cmnt},f,"add"):f.getsinglecomment(c.cid,"","update"))}},f=function(a){var c;c=a.group?a.group.id?a.group.id:a.group:zmail.zuid,a.eid&&a.eid.indexOf("#")===-1&&c&&(a.eid=c+"#"+a.eid);var d;return b&&b.comments&&(d=_.find(b.comments.models,function(b){return b.id===a.eid})),d};a.updateInvitees=function(a){var b=f(a);if(b){var c="",d="";"addInvitee"===a.type?c=a.inviteeList:d=a.inviteeList,b.trigger("change:inviteeList",c,d)}},a.removeViews=function(a){var b,c;_.each(a,function(a){b=$(a).data();var d=f({eid:b.id});d&&(c=d.getView(b.commentviewid),c.onClose())})},a.retainComment=function(a){var b=$(a).find(".sc_cmdv.SCS_cmnt");if(b.length){var c,d=$(b[0]).data(),e=f({eid:d.id});if(e&&(c=e.getView(d.commentviewid))){var g=a.getElementsByTagName("TEXTAREA")[0];g&&c.saveUnpost(g)}}},$.subscribe("zmstreamsapp/postactions",e),"undefined"!=typeof zmComponent&&zmComponent.notifier&&zmComponent.notifier.addHandler("streams",function(a,b){b=b.data||{},b=_zm.copyOf(b),"string"==typeof b.group&&(b.group=$.parseJSON(b.group));var c=b.ntype,g=c===d.add_comment||c===d.comment_group_mention||c===d.comment_mention;g&&e("",{key:"commentAdd",pid:b.eid,cid:b.commentuuid,gid:b.group.id});var h=f(b);if(h){var i=c===d.like_comment,j=c===d.unlike_comment;if(i||j){var k=h.pickComment(b.commentuuid).index,l=_zm.copyOf(h.get("comments"));if(b.nby!==zmail.zuid&&k!==-1){var m=l[k].likes;m=i?m+1:m-1,l[k].likes=m;var n=l[k].likeList||{};if(i){var o=n.hasOwnProperty(b.nby);if(o)l[k].likes=m-1;else{var p=_.isArray(b.nBy)?b.nBy[0]:JSON.parse(b.nBy)[0],q=p[b.nby]||"";n[b.nby]=q}}else delete n[b.nby];l[k].likeList=n,h.set("comments",l),h.trigger("change:like",b.commentuuid)}}if(c===d.add_private_comment){var r={parentuuid:b.parentuuid,by:b.nby};h.getsinglecomment(b.commentuuid,"","wmsprivatecomment",r)}c===d.delete_comment&&h.pickComment(b.commentuuid).index!==-1&&h.updateModel({comment:b},h,"del"),c===d.delete_post&&h.set("isDeleted",!0),c===d.delete_private_comment&&h.updateModel({comment:b},h,"deletePrivate")}});var g=function(a,b,d,e,f){var g=new c.Comment({model:a,postElm:b,highlightComment:d,viewJSON:e,isNewCollabUser:f});return g.$el};return a.init=function(c,d,e){"undefined"!=typeof zmStreamsApp.GroupApp&&zmStreamsApp.GroupApp.fetchHashTags(),b.comments||(b.comments=new b.CommentCollection({})),a.resizeFn=c.resizeComment,c.parentElm=d;var h,i,j,k=c.isNewCollabUser,l=f({eid:c.id,group:c.groupId});if(l){j=l,i=zmStreamsApp.CommentModule.parseInput(c,!0),j.set("attachIndex",i.attachIndex+1);var m=i.comments;if(m.length>l.get("comments").length||i.total!==l.get("total"))l.set({comments:m,total:i.total});else if(m.length){for(var n,o=_zm.copyOf(l.get("comments")),p=0;p<m.length;p++)n=l.pickComment(m[p].id),n.index!==-1&&(o[n.index]=_zm.copyOf(m[p]));l.set("comments",o)}l.set({privateToOwner:i.privateToOwner,mention:i.mention,inviteeList:i.inviteeList}),i.groupsMention&&l.set("groupsMention",i.groupsMention)}else j=new b.Comments(c,{parse:!0}),b.comments.add(j);return j.get("fetchData")&&j.listAll(),h=g(j,d,e,i,k)},a.getCommentTemplate=function(b){var c=a.templates.comments(b);$(b.elm).append(c)},a.sendPrivateToOwner=function(a,c,d){if(d)d.addNewPrivate(c);else{var e=_.find(b.comments.models,function(b){return b.id===a});e.trigger("add:commenttoowner",c)}},a.disableComments=function(a,c){var d=_.find(b.comments.models,function(b){return b.id===a});d.set("disableComment",c),d.trigger("change:disableComment",c)},a.setMentions=function(a,c){var d=_.find(b.comments.models,function(b){return b.id===a});d.set("mention",c,{silent:!0}),d.trigger("change:mentionData",c)},a.getLockValue=function(a){var c;b&&b.comments&&(c=_.find(b.comments.models,function(b){return b.id===a}));var d=!1;return c&&(d=c.get("lockInvites")),d},$.subscribe("/mail/selectMail",function(a,b){var c=$(b.containerDOM).find(".sc_cmdv.SCS_cmnt").data(),d=f({eid:c.id});if(d){var e=d.getView(c.commentviewid);e&&e.selectMail(b.mailID,b.mode)}}),a}(zmStreamsApp.CommentModule||Zmail.App.extend({})),function(){"use strict";var a=zmText.get("streams");window.zmStreamsApp=window.zmStreamsApp||Zmail.App.extend({}),zmStreamsApp.CommentModule=function(a){return a}(zmStreamsApp.CommentModule||Zmail.App.extend({})),zmStreamsApp.CommentModule.unPost={},zmStreamsApp.CommentModule.models=function(b){var c=zmStreamsApp.CommentModule;return b.Comments=Zmail.Model.extend({defaults:{eid:0},url:zmail.conPath+"/comment.do",serialized:function(a,b){var c={},d=this,e=b.mentions,f=b.commentId,g=this.get("shId"),h=b.parent;switch(b.callback=this.updateModel,a){case"addComment":if(c={mode:"add",mentions:e.mention,comments:b.text,actionType:"addComment"},b.replyTo&&(c.replyTo=b.replyTo),e.mention.length){var i=e.offset;c.offsetstarts=i.from,c.offsetends=i.to,c.offsettexts=i.text}b.attTmpObj&&(c.attTmpObj=b.attTmpObj),b.attEntObj&&(c.attEntObj=b.attEntObj),b.linkData&&zmStreamsApp.linkPreview.addDataToParams(b.linkData,c),this.get("isSharedFolder")&&(c.shId=g);break;case"likeComment":c={mode:"like",like:b.like,actionType:b.actionType,authorZuid:b.author,commentId:f};break;case"getAllComments":this.get("fetchData")?(c={accId:zmail.accId,comments:!0},b.url=zmail.conPath+"/mailComments.do"):(c={mode:"list",start:f,actionType:this.get("actionType"),count:11},b.extraParamObj={elm:b.elm});break;case"delete":c={mode:"del",actionType:"deleteComment",commentId:f},this.get("isSharedFolder")&&(c.shId=g);break;case"addPrivate":c={mode:"add",actionType:"addComment",comments:b.comment,privateZuid:b.toZid,parentId:h},h&&"undefined"!==h||(c.isPrivateToPost=!0);break;case"getLikes":c={mode:"like",actionType:"viewGroupEntity",commentId:f},b.extraParamObj={elm:b.elm};break;case"getsinglecomment":c={mode:"singlecomment",actionType:"viewGroupEntity",commentId:f},b.error=function(){};break;case"getRecipientsForMail":c={mailID:this.getUnparsedId(),useConversation:!1,zohoID:zmail.zuid,accountID:zmail.accId,requiredData:"recipientList",mode:"getMailShareData"},b.url=zmail.conPath+"/mailCollab.do"}var j;return b.url.indexOf("mailComments.do")===-1?c.streamsView=!0:j="list",b.success=function(a){b.callback(a,d,j,b.ep)},b.url.indexOf("mailCollab.do")===-1&&(c.groupId=this.get("groupId"),c.entityType=this.get("etype"),c.entityId=this.getUnparsedId()),c},getUnparsedId:function(){var a=this.id;return a&&a.indexOf("#")!==-1&&(a=a.substring(a.indexOf("#")+1,a.length)),a},setView:function(a,b){var c=this.get("views");c=c||{},c[a]=b,this.set("views",c)},getView:function(a){var b=this.get("views");return b[a]},removeView:function(a){var b=this.get("views");delete b[a],_.isEmpty(b)&&this.trigger("destroy",this)},sendPrivate:function(a,b,c,d){this.sync("addPrivate",this,{parent:b,comment:a,toZid:c,error:d})},listAll:function(a,b,c){var d=this.pickComment(a).index,e=this.get("total");if(a&&d!==-1&&b!==e){var f=this.get("comments").length,g=b+11>e?e-b:11;if(f===e&&b+g<=f)return void this.trigger("change:listAll",a,c,!0)}return this.sync("getAllComments",this,{commentId:a,elm:c,error:function(a){_zm.succErrMsg("e",a.msg),c.removeClass("zmLock")}})},remove:function(a,b,c){return this.sync("delete",this,{commentId:a,isPrivate:b,parentId:c})},NewComment:function(b){var c=this,d=c.get("createEntityDeferredCallback");return b=b||{},b.error=b.error||function(){},"function"!=typeof d?void c.sync("addComment",c,b):(c.set("lockInvites",b.lockInvites),void d({mentions:b.sharedMailInvitees||b.mentions.mention,includeRecipients:b.includeRecipients,lockInvites:b.lockInvites,selectedMailIds:b.selectedMailIds}).done(function(){c.set("sharedApiCall",!1),c.set("createEntityDeferredCallback",void 0),c.set("entityExists",!0),c.get("isDraftShare")&&$.publish("/streams/draftShared",{draftId:c.getUnparsedId()}),c.sync("addComment",c,b)}).fail(function(c){c=c||{},c.error=c.error||{},c.error.message=c.error.message||a.common.labels.unknown,c.error.messageOpts=c.error.messageOpts||{},c.error.suppress=c.error.suppress||!1,c.error.messageOpts.suppress=c.error.suppress,b.error({message:c.error.message||a.common.labels.createCommentFail},c.error.messageOpts)}))},pickComment:function(a){var b=this.get("comments"),c=_.pluck(b,"id").indexOf(a),d=b[c];return{commentObj:d,index:c}},getsinglecomment:function(a,b,c,d){var e=this.pickComment(a),f=this.get("replyTo"),g=_.pluck(f,"id").indexOf(a);return e.index!==-1?e.commentObj:"popup"===c&&g!==-1?f[g]:void this.sync("getsinglecomment",this,{commentId:a,ep:{elm:b,type:c,dataObj:d}})},likeComment:function(a,b){var c=this.pickComment(a).commentObj,d=!c.liked,e=c.by,f=d?"likecomment":"unlikecomment";return this.sync("likeComment",this,{commentId:a,like:d,author:e,actionType:f,error:function(){b.removeClass("zmLockLike")}})},getRecipientsForMail:function(){var a=this.get("recipientList");if(a){var b=a[0].orgUsers||[],c=[];return b.concat(c)}this.sync("getRecipientsForMail",this,{mailID:this.getUnparsedId(),useConversation:!1,zohoID:zmail.zuid,accountID:zmail.accId,requiredData:"recipientList"})},getPvtComments:function(a){var b={};return b=a?this.pickComment(a).commentObj:this.get("privateToOwner")},updateModel:function(a,b,c,d){if(c=c||this.data.mode,this.data){var e=this.data.mode;c="add"===e&&this.data.privateZuid||d&&"wmsprivatecomment"===d.type?"addPrivate":e,c="like"===e&&void 0===this.data.like?"getLikes":c}d&&"wmsprivatecomment"===d.type&&(this.data.parentId=d.dataObj.parentuuid,this.data.privateZuid=d.dataObj.by),"deletePrivate"===c&&(this.isPrivate=!0,c="del");var f,g=_zm.copyOf(b.get("comments")),h=this.data?this.data.commentId:"";switch(c){case"add":var i=a.comment,j=g;f=b.get("total"),j.push(i),f=isNaN(f)?j.length:f+1,b.set({total:f,comments:j}),$.publish("/streams/comment",{mode:"add",entityId:b.getUnparsedId(),etype:b.get("etype"),total:f}),b.get("sharedCall")||i.by!==zmail.zuid||b.get("isSharedFolder")||zmStreamsApp.PostApp.watchPost({gid:b.get("groupId"),pid:b.get("id")}),b.trigger("change:add");break;case"like":var k=b.pickComment(h).index,l=b.get("comments");l[k].liked=this.data.like;var m=l[k].likeList||{},n=m.hasOwnProperty(zmail.zuid),o=this.data.like;if(o&&!n||!o&&n){var p=l[k].likes;if(p=o?p+1:p-1,l[k].likes=p,o){var q=zmStreamsApp.util.getContactDetails([zmail.zuid])[zmail.zuid];m[zmail.zuid]=q.fn}else delete m[zmail.zuid];l[k].likeList=m}b.set("comments",l),b.trigger("change:like",h);break;case"list":var r=g;a=a.comment?a.comment:a;var s=a.order,t=a.comments,u=_(s).map(function(a,b){var c=t[a];return c.sequence=b+1,c});for(var v in r)s.indexOf(r[v].id)===-1&&u.push(r[v]);b.set("comments",u,{silent:!0}),b.trigger("change:listAll",h,this.extraParamObj.elm);break;case"del":var w,x,y=h;!h&&a.comment&&(y=a.comment.commentuuid,w=a.comment.parentuuid);var z=b.pickComment(y).index,A=this.isPrivate,B=this.parentId||w;if(z!==-1)f=b.get("total"),j=g,j.splice(z,1),f=isNaN(f)?j.length:f-1,b.set({total:f,comments:j}),$.publish("/streams/comment",{mode:"delete",entityId:b.getUnparsedId(),total:f,etype:b.get("etype")});else if(A){var C=g;x=!B;var D,E,F,G=x?{}:b.pickComment(B),H=x?b.get("privateToOwner"):G.commentObj["private"];for(var I in H)if(D=$.isArray(H[I])?H[I]:[H[I]],E=_.pluck(D,"id"),F=E.indexOf(y),F!==-1){D.splice(F,1),x?D.length?H[I]=D:delete H[I]:D.length?C[G.index]["private"][I]=D:delete C[G.index]["private"][I],b.set("comments",C);break}}b.trigger("change:removeComment",y,A,x);break;case"addPrivate":var J,K,L,M,N,O=a.comment.isprivateToPost,P="private";if(O?(J=b.get("privateToOwner")||{},K=b.get("owner")===zmail.zuid?this.data.privateZuid:zmail.zuid):(N=this.data.parentId,M=b.pickComment(N),K=M.commentObj.by===zmail.zuid?String(this.data.privateZuid):zmail.zuid,J=M.commentObj[P]||{}),L=$.isEmptyObject(J))J[K]=[],J[K].push(a.comment),O||(j=g,M.commentObj[P]=J,j[M.index]=M.commentObj,b.set("comments",j));else{if(!$.isArray(J[K])){var Q=J[K];void 0===Q?J[K]=[]:J[K]=[Q]}J[K].push(a.comment)}O&&b.set("privateToOwner",J),b.trigger("add:privateComment",O,a.comment,this.data.parentId,L,K);break;case"getLikes":var R=b.pickComment(h).index,S=b.get("comments"),T=S[R].likeList||{},U=a.users;T&&_.size(T)&&$.extend(U,T),S[R].likeList=U,S[R].likes=_.size(U),b.set("comments",S),b.trigger("change:getLikes",h,this.extraParamObj.elm);break;case"singlecomment":var V=a.comment;if("popup"===d.type)j=b.get("replyTo")||[],j.push(V),b.set({replyTo:j});else{var W=b.pickComment(V.id).index;if(W===-1){j=g,j.push(V);var X=b.get("total");b.set({comments:j,total:X+1}),$.publish("/streams/comment",{mode:"add",entityId:b.getUnparsedId(),etype:b.get("etype"),total:b.get("total")})}}b.trigger("change:singlecomment",h,d);break;case"getMailShareData":b.set("recipientList",a.recipientList)}},parse:function(a){var b=a.id;b.indexOf("#")===-1&&(a.id=a.groupId+"#"+b);var d=c.parseInput(a,!0);return d.attachIndex=0,d}}),b.CommentCollection=Zmail.Collection.extend({model:b.Comments,url:"/zm/stream.do",addModel:function(a,b,c){return this.remove(a,{silent:c}),this.add(a,{at:b,silent:c}),this}}),b}(zmStreamsApp.CommentModule.models)}(),zmStreamsApp.CommentModule.parseInput=function(a,b){"use strict";var c=a.comments||{},d=c.comments,e=c.order||[],f=_(e).map(function(a,b){var c=d[a];return c.sequence=b+1,c});void 0===a.streamsEnabled&&(a.streamsEnabled=!0);var g=c.total||e.length||a.total,h={total:g,parentElement:a.parentElm,id:a.id,groupId:a.groupId,mention:a.mentions,etype:a.etype,owner:a.owner,privateToOwner:a.privateToOwner,actionType:a.actionType||"viewGroupEntity",sharedCall:a.sharedCall||!1,groupsMention:a.groupsMention||!1,placeHolder:a.placeHolder,isSharedFolder:a.isSharedFolder,shId:a.shId,disableComment:a.disableComment,fixedComment:a.fixedComment||!1,fixedElement:a.fixedElement,miscData:a.miscData||{},sharedApiCall:a.sharedApiCall||!1,createEntityDeferredCallback:a.createEntityDeferredCallback,isDraftShare:a.isDraftShare||!1,entityExists:a.entityExists||!1,fetchData:void 0===a.comments,shGroup:a.shGroup||[],shOwner:a.shOwner,inviteeList:a.inviteeList,recipientList:a.recipientList,openedId:a.openedId,streamsEnabled:a.streamsEnabled};return f&&b&&(h.comments=f),h},window.zmStreamsApp=window.zmStreamsApp||{},zmStreamsApp.CommentModule.templates=function(){"use strict";var a,b={},c=zmStreamsApp.template,d=zmText.get("streams"),e=!0;return b.comments=function(c,f,g,h){var i=c.id,j=c.comments,k=c.fixedComment||!1,l=c.isShare||!1,m=c.disableComment||!1,n=c.placeHolder;e=c.streamsEnabled,a=c.etype;var o=k?"fixedComment":"",p=["UL",{attrs:{"class":"Stcmt cmnt_ul","data-type":o,"data-sharedview":c.sharedCall}}],q=_zm.getDOM(p);if(c.notifyId=g,b.commentList(c,q),!k&&!m&&!c.isDisableAdd){var r=b.newcomment({cid:i,sharedCall:c.sharedCall,sharedApiCall:c.sharedApiCall,entityExists:c.entityExists,isDraftShare:c.isDraftShare,attId:f,placeHolder:n,fixedComment:!1,isShare:l});q.appendChild(_zm.getDOM(r))}var s=j.length,t=c.total-s,u=_zm.getDOM(["DIV",{attrs:{"class":"sc_cmdv SCS_cmnt"}}]);if(c.sharedCall&&s&&!c.isDraftShare&&u.appendChild(b.commentHeader()),c.privateToOwner){var v=b.privateToOwner(c.privateToOwner,c.owner,g,c.disableComment,c.parentElement);u.appendChild(v)}if(c.isDraftShare&&!s&&h&&u.appendChild(b.draftNoComment()),t){var w=c.comments[0]?c.comments[0].id:"";u.appendChild(b.viewmore(zmText.applyArgs(d.common.labels.viewMoreComments,{count:t}),w,s))}return u.appendChild(q),u},b.draftNoComment=function(){return _zm.getDOM(["DIV",{attrs:{"class":"zmNoCmnt greyText"},child:[["I",{attrs:{"class":"msi-comment"}}],["DIV",{child:[["text",d.common.labels.nocomments]]}]]}])},b.commentHeader=function(){return _zm.getDOM(["DIV",{attrs:{"class":"cmntLabel"},child:[["text",d.common.labels.comments]]}])},b.commentList=function(a,c){for(var e,f=a.comments,g=a.notifyId,h=a.disableComment||!1,i=0;i<f.length;i++)if(e=f[i],e.user)c.appendChild(b.comment(e,a)),e["private"]&&!a.isPrint&&b.privateCommentBlock(c,e,"","",g,h);else{var j=e.by||"",k=e.name||(zmStreamsApp.util.getContactDetails([j])[j]||{}).fn||d.common.labels.unknown,l=e.text||"";c.appendChild(b.systemComment(k,l))}},b.quotedCommentList=function(a,c,d){for(var e,f=0;f<a.length;f++)e=a[f],c.appendChild(b.quoteComment(e,a,d))},b.fixedComment=function(a){var c=a.sharedCall?[]:["UL",{attrs:{"class":"Stcmt"}}],d=["DIV",{attrs:{"class":"SCS_cmnt zms_fixed",type:"notification"},child:[c]}],e=_zm.getDOM(d),f=b.newcomment(a);if(a.sharedCall){a.totalCount>0&&e.appendChild(_zm.getDOM(b.commentInfo(a.totalCount))),e.appendChild(f);var g=b.commentActions(a);g.style.display="none",e.appendChild(g)}else{var h=$(e).find(".Stcmt");$(h).append($(f))}return e},b.commentInfo=function(a){var b=["DIV",{attrs:{"class":"cmntInfo"},child:[["I",{attrs:{"class":"msi-comment zm_shrnk"}}],["SPAN",{attrs:{"class":"StCnt zm_dIB"},child:[["text",a]]}]]}];return b},b.commentActions=function(a){var c=a.entityExists||a.isDraftShare?[]:["SPAN",{attrs:{"class":"zm_dIB zm_inclr zm_shrnk"},child:[["I",{attrs:{"class":"msi-uncheck zm_shrnk"}}],["text",d.common.labels.includeEveryoneNew]]}],e=a.entityExists?[]:["B",{attrs:{"class":"lockClass mailSharedLock zm_shrnk"},child:[["I",{attrs:{"class":"msi-Ainvitee inviteeColor zm_shrnk"}}]]}],f=a.totalCount?b.commentInfo(a.totalCount):[],g=a.entityExists?{}:a.placeHolder,h="function"==typeof g.button?g.button():g.button;h=h||d.streams.common.comment;var i=a.inviteeList?a.inviteeList.length:0;a.inviteeList=a.inviteeList||[];var j=i?b.addInviteeList(zmStreamsApp.util.getContactDetails(a.inviteeList)):[],k=b.getInviteeFontDOM(i),l=["DIV",{attrs:{"class":"cmntActions"},child:[["DIV",{attrs:{"class":"SC_flt"},child:[["DIV",{attrs:{"class":"SCS_postAct zm_dIB"},child:[["DIV",{attrs:{"class":"cmAct"},child:[["DIV",{attrs:{"class":"mailAct"},child:[["I",{attrs:{"class":"msi-attachment zmst_attach zm_shrnk"}}],["DIV",{attrs:{"class":"SC_SLine"}}],f,["UL",{attrs:{"class":"inviteeList invitedList zm_shrnk"},child:[j]}],k,["DIV",{attrs:{"class":"SC_SDot"}}],c]}]]}]]}]]}],["DIV",{attrs:{"class":"SC_frt"},child:[["DIV",{attrs:{"class":"zm_dIB zm_slc"},child:[["DIV",{attrs:{style:"display:none;","class":"SC_SDot"}}],e]}],["DIV",{attrs:{"class":"SC_PUbtm zm_dIB"},child:[["SPAN",{attrs:{"class":"sel addcomnt zm_shrnk"},child:[["text",h]]}]]}]]}]]}];return _zm.getDOM(l)},b.privateCommentBlock=function(a,c,e,f,g,h,i,j,k){var l,m=_zm.getDOM(["LI",{attrs:{"class":"pvtMsg"}}]),n="private";i?a.after(m):a.appendChild(m);var o=e?c:c[n],p=e?f:c.by,q=e?"":c.id,r="",s={};for(r in o)o[r]&&(s.recepient=r,s.replyTo=zmail.zuid===r?p:r,m.appendChild(b.private_comments(q,s,o[r],!1,e,g,h)));var t=!1;if(g)for(var u in o)if(o[u]instanceof Array){for(var v=0,w=o[u].length;v<w;v++)if(o[u][v].id===g){t=!0;break}}else if(o[u].id===g){t=!0;break}if(j||t){if(e&&k)l=$(k).find(".ShwPrv"),l.length&&(l[0].childNodes[1].textContent=d.common.labels.hidePrivateComments);else if(l=$(a).find(".zms_comment"),l.length){var x=$(l[l.length-1]).find(".ShwPrv");x[0].childNodes[1].textContent=d.common.labels.hidePrivateComments}}else e?$(m).parent("ul.pvtOwn")[0].style.display="none":m.style.display="none"},b.newcomment=function(a){var b=a.cid,c=a.attId,e=a.fixedComment,f=a.placeHolder,g=a.entityExists,h=a.sharedApiCall,i=a.isDraftShare,j=a.sharedCall,k=a.isShare;c="p"+b+c;var l=e?"fixed":"";c=c.substring(c.indexOf("#")+1,c.length),f=g?{}:f,f=f||{},f.button=f.button||d.streams.common.comment,f.textArea=f.textArea||d.common.labels.writeComment;var m="function"==typeof f.button?f.button():f.button,n="function"==typeof f.textArea?f.textArea():f.textArea,o=k?[]:["I",{attrs:{"class":"msi-attachment zmst_attach SC_flt zm_shrnk"}}],p=j?"":"display:none",q=!j||g||i?[]:["DIV",{attrs:{"class":"zm_inclr zm_dIB"},child:[["I",{attrs:{"class":"msi-uncheck"}}],["DIV",{attrs:{"class":"zm_dIB"},child:[["text",d.common.labels.includeEveryone]]}]]}],r=h||i&&!g?["DIV",{attrs:{"class":"SCmb mailSharedLock"},child:[["UL",{child:[["LI",{attrs:{"class":"SC_lbr"},child:[["B",{attrs:{"class":"lockClass"},child:[["I",{attrs:{"class":"msi-Ainvitee inviteeColor zm_shrnk"}}],["DIV",{attrs:{"class":"SC_hd"}}]]}]]}]]}]]}]:[],s=e&&j&&!i&&!zmUtil.isChildWindow()?["DIV",{attrs:{"class":"zmCmntSC"},child:[["I",{attrs:{"class":"msi-comment mailCmnt zm_shrnk",style:"display:none"}}],["I",{attrs:{"class":"msi-notes noteCmnt zm_shrnk"}}],["I",{attrs:{"class":"msi-task taskcmnt zm_shrnk"}}]]}]:[],t=["DIV",{attrs:{"class":"cmntText"},child:[["TEXTAREA",{attrs:{placeholder:n,id:"comnt_"+b,"data-attach":c,autocomplete:"off",autocorrect:"off","class":"zms_cmTxt",autocapitalize:"off","data-type":l}}],s,["I",{attrs:{"class":"msi-smiley zm_shrnk"}}]]}],u=["LI",{attrs:{type:"commentbox","class":"zms_txtLI"},child:[["DIV",{attrs:{"class":"zmImg"}}],t,["DIV",{attrs:{"class":"SC_PUbtm",style:p},child:[o,q,r,["SPAN",{attrs:{"class":"addcomnt sel"},child:[["text",m]]}]]}]]}],v=_zm.getDOM(u);if(e&&j)v=_zm.getDOM(t);else{var w=$(v).find(".zmImg"),x=zmStreamsApp.util.getContactDetails([zmail.zuid])[zmail.zuid];if(x.avatar)$(w[0]).replaceWith(x.avatar);else{var y=_zm.getDOM(zmail.ContactBook.Templates.avatar({isValidPhoto:!1,photo:void 0,initials:zmail.ContactBook.Utils.initials(zmail.IAMFullName),avatarBgColor:zmail.ContactBook.Utils.colorClasses()})[0]);$(w[0]).replaceWith(y)}}return v},b.groupDom=function(){return _zm.getDOM(["DIV",{attrs:{"class":"SCmb zm_dIB appGroup","data-grp":String(zmail.zuid)},child:[["UL",{child:[["LI",{attrs:{"class":"SCtxt"},child:[["B",{child:[["DIV",{attrs:{"class":"SC_hd"}}],["SPAN",{attrs:{"class":"zm_grptxt zm_shrnk"},child:[["text","Select a Group"],["I",{attrs:{"class":"msi-barrow"}}]]}]]}]]}]]}]]}])},b.getInviteeFontDOM=function(a){return a=a||0,zmStreamsApp.PostActions.template.getFontDOM(a,!0,!1,"inviteeList")},b.addInviteeList=function(a,c){var d,e=[],f=Object.keys(a).length,g=0;if(!$.isEmptyObject(a))for(d in a)g<3&&(e.push(["IMG",{attrs:{src:a[d].photo}}]),g++);var h=["LI",{child:e}];return c?(c=c.querySelector(".zms_fixed .inviteeList"),c.innerHTML="",c.appendChild(_zm.getDOM(h)),$(c).siblings("font.fontClass").remove(),$(c).after(_zm.getDOM(b.getInviteeFontDOM(f))),void 0):h},b.viewmore=function(a,b,c){var d=["DIV",{attrs:{"class":"cmntMore","data-cid":b,"data-count":c},child:[["I",{attrs:{"class":"msi-comment"}}],["text",a]]}];return _zm.getDOM(d)},b.createPrivate=function(a,b,c,e){var f=zmStreamsApp.util.getContactDetails([String(b)])[String(b)].fn,g=zmText.applyArgs(d.streams.post.pvtReply,{userName:f}),h="display:none",i="";c||(i="display:none",h="");var j=zmStreamsApp.util.getContactDetails([zmail.zuid])[zmail.zuid],k=[["LI",{attrs:{"class":"pvtRlyLi",style:i},child:[["DIV",{attrs:{"class":"zmImg"},child:[["IMG",{attrs:{src:j.photo}}]]}],["DIV",{child:[["DIV",{attrs:{"class":"cmntText"},child:[["INPUT",{attrs:{"class":"sfocus",placeholder:g,"data-z":b,"data-cid":a,autocomplete:"off",autocorrect:"off",autocapitalize:"off"}}]]}]]}]]}],["LI",{attrs:{"class":"pvtRlyLink",style:h},child:[["SPAN",{attrs:{"class":"SndPrvRep"},child:[["text",d.common.labels.reply]]}]]}]],l=_zm.getDOM(k),m=$(l).children().find(".zmImg");if(j.avatar)$(m[0]).replaceWith(j.avatar);else{var n=_zm.getDOM(zmail.ContactBook.Templates.avatar({isValidPhoto:!1,photo:void 0,initials:zmail.ContactBook.Utils.initials(zmail.IAMFullName),avatarBgColor:zmail.ContactBook.Utils.colorClasses()})[0]);$(m[0]).replaceWith(n)}var o,p=l;if(c){if(o=_zm.getDOM(["LI",{attrs:{"class":"pvtMsg"},child:[["UL",{attrs:{"class":"pvtOwn"}}]]}]),p=o,e){var q=_zm.getDOM(["UL",{attrs:{"class":"pvtOwn"}}]);q.appendChild(o),p=q}o.children[0].appendChild(l)}return p},b.comment=function(a,b){var e=a.id,f=a.by,g=zmStreamsApp.util.getContactDetails([String(f)])[f],h=a.text,i=g.zid===zmail.zuid?d.common.labels.me:g.fn||a.name,j=a.tags,k=b.id,l=b.notifyId,m=b.shOwner,n=b.isShare,o=b.groupId,p=[],q=":",r={text:h,offset:j,group:k,span:a.replyTo,shGroup:b.shGroup,inviteeList:b.inviteeList};"13"===b.etype&&a.commentType&&(r.span=!0);var s=c.setOffsetValues(r);if(a.replyTo){var t=a.replyToDisplayName+d.common.labels.apostrophes||"";a.replyToZuid===zmail.zuid&&(t=d.common.labels.your),p=["SPAN",{attrs:{},child:[["text",d.common.labels.repliedTo+" "+t+" "],["SPAN",{attrs:{style:"text-decoration: underline;cursor:pointer","class":"zm_replyto","data-cid":a.replyTo},child:[["text",d.common.labels.commentSmall]]}],s]}],q="",g.zid===zmail.zuid&&(i=d.common.labels.you)}else p=s;if("13"===b.etype&&a.commentType){q="",g.zid===zmail.zuid&&(i=d.common.labels.you);var u="";1===a.commentType?u=d.twitter.retweetText:2===a.commentType&&(u=d.twitter.replyText),p=["SPAN",{attrs:{},child:[["text",u],s]}]}var v=a.on,w=d.common.labels.sendPrivateReply,x=[],y=[],z=[],A=[],B=[];if(!n&&!b.isSharedFolder){z=b.disableComment?[]:["SPAN",{attrs:{"class":"SndRep","data-cid":e,"data-z":f},child:[["text",d.common.labels.reply]]}];var C=!a.likes&&!b.streamsEnabled&&"1"!==b.etype,D=b.streamsEnabled===!1?"pointerEventsNone":"";A=C?[]:["I",{attrs:{"class":"msi-love zmcnt "+D,"data-cmid":e}}],B=["FONT",{attrs:{style:a.likes?"":"display:none","data-cid":e,"class":"zm_lcnt"},child:[["text",a.likes?a.likes:""]]}],x=b.disableComment?[]:["SPAN",{attrs:{"class":"SndPrv SndPrvCmt","data-cid":e,style:a["private"]?"display:none":"","data-z":f},child:[["text",w]]}],y=["SPAN",{attrs:{"class":"SndPrv ShwPrv zmShowV",style:a["private"]?"":"display:none","data-z":f},child:[["I",{attrs:{"class":"msi-comment"}}],["text",d.common.labels.showPrivateComments]]}]}var E,F="";b.isSharedFolder&&m===zmail.zuid&&(E=!0),n||b.isSharedFolder||a.by!==zmail.zuid||(E=!0),"13"===b.etype&&a.commentType&&a.by===zmail.zuid&&(E=!1),E&&(b.streamsEnabled||"1"===b.etype)&&(x="",z=[],F=["I",{attrs:{"class":"msi-close delCmnt","data-cid":e}}]);var G=k.indexOf("#")!==-1?k.substring(k.indexOf("#")+1,k.length):k,H=zmail.conPath+"/#stream/tab/"+b.groupId+"/"+G+"/"+b.etype+"/"+b.actionType+"/"+a.id,I=b.isSharedFolder?["text",v]:["A",{child:[["text",v]],attrs:{href:H,target:"_blank","class":"dateTime",title:zmStreamsApp.util.getFullDateFormat(parseInt(a.time))}}],J=(a.likes?" contentLiked":"")+(a.liked?" contentILiked":""),K=["DIV",{attrs:{"class":"cmntDet"+J},child:[["SPAN",{attrs:{"class":"time"},child:[I]}],["DIV",{attrs:{"class":"SC_SDot"}}],A,B,["DIV",{attrs:{"class":"SC_SDot",style:z.length?"":"display:none"}}],z,x,y]}],L=l===e?"zms_comment highlightClass":"zms_comment",M=["LI",{attrs:{"class":L,"data-cid":e},child:[F,["DIV",{attrs:{"class":"SC_avtr"}}],["DIV",{attrs:{"class":"cmntMsg"},child:[["STRONG",{attrs:{"class":"zm_susr","data-zid":f},child:[["text",i+q]]}],p]}]]}],N=_zm.getDOM(M),O=zmStreamsApp.util.getContactDetails([a.by])[a.by],P=$(N).find(".SC_avtr");if(O.avatar)$(P[0]).replaceWith(O.avatar);else{var Q=_zm.getDOM(zmail.ContactBook.Templates.avatar({isValidPhoto:!1,photo:void 0,initials:zmail.ContactBook.Utils.initials(a.name),avatarBgColor:zmail.ContactBook.Utils.colorClasses()})[0]);$(P[0]).replaceWith(Q)}if(a.attachments){var R=c.RenderAttachment({attArr:a.attachments,groupId:o,pid:k,type:b.etype,actionType:b.actionType});N.appendChild(R)}return a.link&&zmStreamsApp.linkPreview.addLinkPreviewToComment(a,N,k),N.appendChild(_zm.getDOM(K)),N},b.quoteComment=function(a,b,e){var f=a.id,g=a.by,h=zmStreamsApp.util.getContactDetails([String(g)])[g],i=a.text,j=h.zid===zmail.zuid?d.common.labels.me:h.fn||a.name,k=a.tags||[],l=b.id,m=b.notifyId,n=[],o=":",p={text:i,offset:k,group:l,span:a.replyTo},q=c.setOffsetValues(p);a.replyTo?(n=["SPAN",{attrs:{},child:[["text"," - "+d.common.labels.repliedTo+" "],["SPAN",{attrs:{style:"text-decoration: underline;cursor:pointer","class":"zm_replyto","data-cid":a.replyTo},child:[["text",d.common.labels.commentSmall]]}],q]}],o=""):n=q;var r=a.on,s=(a.likes?" contentLiked":"")+(a.liked?" contentILiked":""),t=["DIV",{attrs:{"class":"cmntDet"+s},child:[["SPAN",{child:[["text",r]]}]]}],u=m===f?"highlightClass":"",v=["LI",{attrs:{"class":u,"data-cid":f},child:[["DIV",{attrs:{"class":"SC_avtr"}}],["DIV",{attrs:{"class":"cmntMsg"},child:[["STRONG",{attrs:{"class":"zm_susr","data-zid":g},child:[["text",j+o]]}],n]}]]}],w=_zm.getDOM(v),x=zmStreamsApp.util.getContactDetails([a.by])[a.by],y=$(w).find(".SC_avtr");if(x.avatar)$(y[0]).replaceWith(x.avatar);else{var z=_zm.getDOM(zmail.ContactBook.Templates.avatar({isValidPhoto:!1,photo:void 0,initials:zmail.ContactBook.Utils.initials(a.name),avatarBgColor:zmail.ContactBook.Utils.colorClasses()})[0]);$(y[0]).replaceWith(z)}var A=e.gnrl;if(a.attachments){var B=c.RenderAttachment({attArr:a.attachments,groupId:A.group.id,pid:A.id,type:A.type,actionType:zmStreamsApp.events.getActionType(A.group)});w.appendChild(B)}return a.link&&zmStreamsApp.linkPreview.addLinkPreviewToComment(a,w,l),w.appendChild(_zm.getDOM(t)),w},b.systemComment=function(a,b){b=(b||"").replace(/\\n/gim,"\n");var c=["LI",{attrs:{"class":"Sactvty"},child:[["DIV",{child:[["B",{child:[["text",a]]}],["text"," : "],["SPAN",{child:[["text",b]],attrs:{style:"word-break: break-all; white-space: pre-wrap;"}}]],attrs:{title:d.common.labels.systemComment}}]]}];return _zm.getDOM(c)},b.selectMailDOM=function(a){var b=["SPAN",{attrs:{"class":"selMail"},child:[["SPAN",{attrs:{"class":"StCnt zm_dIB"},child:[["text",a]]}],["SPAN",{attrs:{"class":"zm_dIB"},child:[["text",d.common.labels.mailsSelected]]}]]}];return _zm.getDOM(b)},b.privateToOwner=function(a,c,d,e,f,g){var h=_zm.getDOM(["UL",{attrs:{"class":"pvtOwn"}}]);return b.privateCommentBlock(h,a,!0,c,d,e,void 0,g,f),h},b.private_comments=function(a,c,d,e,f,g,h,i){var j,k=f?"pvtOwn":"",l=e?["LI",{attrs:{"class":"pvtMsg"},child:[["UL",{attrs:{"class":"Spvt "+k,"data-zid":c.recepient}}]]}]:["UL",{attrs:{"class":"Spvt "+k,"data-zid":c.recepient}}],m=_zm.getDOM(l),n=e?m.children[0]:m;if(d instanceof Array)for(var o=0,p=d.length;o<p;o++)j=b.private_comments.comment(d[o]),d[o].id===g&&_zm.addClass(j,"highlightClass"),n.appendChild(j);else j=b.private_comments.comment(d,h),d.id===g&&_zm.addClass(j,"highlightClass"),n.appendChild(j);if(!h&&!i){var q=b.createPrivate(a,c.replyTo,e,f);n.appendChild(q)}return e?m:n},b.replyComment=function(a,b){return _zm.getDOM(["DIV",{attrs:{"data-cid":a,"class":"zms_rep"},child:[["text",zmText.applyArgs(d.common.labels.replyToUser,{userName:b})],["I",{attrs:{"class":"msi-close"}}]]}])},b.private_comments.comment=function(b){var f,g=zmStreamsApp.util.getContactDetails([b.by])[b.by];if(g){var h=g.zid===zmail.zuid?d.common.labels.me:g.fn,i={text:b.text,offset:[]},j=c.setOffsetValues(i),k=b.on,l=zmStreamsApp.util.updateTime(parseInt(b.time));l&&(k=l);var m="";b.by!==zmail.zuid||!e&&"1"!==a||(m=["I",{attrs:{"class":"msi-close delCmnt delPvtCmnt","data-cid":b.id}}]),f=["LI",{attrs:{"data-cid":b.id},child:[m,["DIV",{attrs:{"class":"SC_avtr"}}],["DIV",{attrs:{"class":"cmntMsg"},child:[["STRONG",{child:[["text",h+":"]]}],j]}],["DIV",{attrs:{"class":"cmntDet"},child:[["SPAN",{attrs:{title:zmStreamsApp.util.getFullDateFormat(parseInt(b.time))},child:[["text",k]]}]]}]]}]}var n=_zm.getDOM(f),o=$(n).find(".SC_avtr");if(g.avatar)$(o[0]).replaceWith(g.avatar);else{var p=_zm.getDOM(zmail.ContactBook.Templates.avatar({isValidPhoto:!1,photo:void 0,initials:zmail.ContactBook.Utils.initials(b.name),avatarBgColor:zmail.ContactBook.Utils.colorClasses()})[0]);$(o[0]).replaceWith(p)}return n},b}(),window.zmStreamsApp=window.zmStreamsApp||Zmail.App.extend({}),zmStreamsApp.CommentModule.views=function(a){"use strict";var b,c=zmText.get("streams"),d=c.streams.common,e=d.comment,f=d.commenting,g=zmStreamsApp.CommentModule,h=zmStreamsApp.util;return a.Comment=Zmail.View.extend({attCmpRef:"",saveContent:!0,template:g.templates,events:{"click .zmcnt.msi-love":"like","focus textArea.zms_cmTxt":function(){if(this.fixedComment&&this.isNewCollabUser){var a=$(this.$el);a.find(".cmntInfoWra").removeClass("cmntInfoWra").children(".cmntInfo").hide(),
a.find(".cmntActions").show(),this.model.getRecipientsForMail(),this.setBottom()}else{var b=this.$el.find(".SC_PUbtm");$(b).show()}},"hover ul.Stcmt":function(){this.hasAttachment()&&this.reSize()},"keydown textArea.zms_cmTxt":function(a){zmail.mailOpt.isKey&&a.ctrlKey&&13===a.keyCode&&(a.preventDefault(),this.publish(a)),this.isNewCollabUser&&this.setBottom(),this.reSize()},"paste textArea.zms_cmTxt":function(a){var b=this;this.isNewCollabUser&&this.setBottom(),setTimeout(function(){b.reSize()},100)},"input propertychange  textArea.zms_cmTxt":function(){this.setBottom()},"click .addcomnt":"publish","click .cmntMore":function(a){var b=$(a.currentTarget);if(!b.hasClass("zmLock")&&!b.hasClass("postCmnt")){b.addClass("zmLock");var c=b.data("cid"),d=b.siblings(".zms_comment").length;this.model.listAll(c,d,b)}},"click .SndRep":"attachReplyTo","click .delCmnt":function(a){var b=$(a.currentTarget),c=b.hasClass("delPvtCmnt"),d=$(b).parents(".pvtMsg").prev(".zms_comment");this.model.remove(b.data("cid"),c,$(d).data("cid"))},"click .SndPrvCmt":function(a){var b=a.currentTarget;$(b).hide(),this.addNewPrivate(b)},"mouseover .zms_comment .zm_susr,.zms_comment .zms_mention":"showUserDropdown","mouseout .zms_comment .zm_susr,.zms_comment .zms_mention":function(a){var b=a.currentTarget;$(b).data("show","false")},"click .zms_comment .zm_HTag":"showHashTag","click .ShwPrv":"showHidePrivateComment","click .zms_rep .msi-close":function(a){var b=$(a.currentTarget).parent();b.parent().find("textArea").data("cid",""),b.remove();var c=this.model.get("id");zmStreamsApp.util.storeUnposted(c,{replyTo:{}})},"click .zmst_attach":"addAttachment","keypress .pvtRlyLi input":function(a){13===a.keyCode&&this.sendPrivate(a)},"click .SndPrvRep":function(a){var b=a.currentTarget;$(b).parent().hide().siblings(".pvtRlyLi").show().find("input").focus()},"click .zm_lcnt":function(a){var b=a.currentTarget,c=this.model,d=$(b).data("cid"),e=c.pickComment(d).commentObj,f=e.likeList||{},g=_.size(f);g&&e.likes===g?this.showCommentLikes(d,b):c.sync("getLikes",this.model,{commentId:d,elm:b})},"click .zm_inclr i":function(a){var b=a.currentTarget;$(b).removeClass("zm_shrnk").toggleClass("msi-check msi-uncheck").addClass("zm_shrnk"),this.model.get("sharedCall")&&this.fixedComment&&this.updateInviteeList("recipientList")},"click .zm_inclr .zm_dIB":function(a){var b=a.currentTarget;$(b).parent().find("i").trigger("click")},"click .zm_replyto":function(a){this.showSingleComment(a.currentTarget)},"click .lockClass":function(a){var b=$(a.currentTarget).filter(".lockClass"),d=$(b).find("i"),e="";d.hasClass("msi-Ainvitee")?(d.removeClass().addClass("msi-Dinvitee"),e=c.common.labels.allowInvites):(d.removeClass().addClass("msi-Ainvitee inviteeColor"),e=c.common.labels.denyInvites),zmComponent.tooltip({elm:b[0],text:e,arrow:"top"})},"mousedown .zmCmntFixed":function(a){var b=this.$el.find("textArea.zms_cmTxt");if($(b).data("shrinkValue",!0),this.isNewCollabUser&&!$.trim(b.val())){var c=$(a.target);$(c).hasClass("zm_shrnk")&&$(b).data("shrinkValue",!1)}},"focusout textArea.zms_cmTxt":function(a){this.saveUnpost(a);var b=this.$el.find("textArea.zms_cmTxt");if(this.isNewCollabUser&&!$.trim(b.val())){if($(b).data("shrinkValue")===!1)return;this.$el.find(".cmntActions").hide();var c=this.$el.find(".cmntInfo");c.length&&(this.$el.find(".cmntInfo").show(),this.$el.find(".zmCmntFixed").addClass("cmntInfoWra")),this.setBottom()}},"click .cmntInfo":function(){zmUtil.setPreviewScroll($(this.$el).find(".cmntLabel")[0],this.$el.parents(".SC_Twpr")[0])},"click .inviteeList":"showInviteeList","click .taskcmnt":"convertTaskComment","click .noteCmnt":"convertNoteComment","click .appGroup":"showGroupDropdown","click .mailCmnt":function(){this.switchBackMail()}},saveUnpost:function(a){var b=a.currentTarget||a;if(this.saveContent){var c={},d=$(b).parent().siblings(".zms_rep");if(d.length){var e=d.data("cid"),f="",g=this.model.pickComment(e);g.commentObj&&(f=g.commentObj.name);var h={id:e,name:f};c.replyTo=h}var i=$(b).val(),j=zmMention.getMentions($(b));c.text=i,j&&j.length&&(c.mentions=j);var k=this.model.get("id");zmStreamsApp.util.storeUnposted(k,c)}},convertTaskComment:function(a){this.$el.find(".mailAct").hide(),$(a.currentTarget).parent().siblings(".msi-smiley").hide(),$(a.currentTarget).siblings(".msi-comment").show().siblings(".taskcmnt").hide(),$(this.$el).find(".addcomnt").text("Add Task").addClass("addTsk");var b=$(this.$el).find(".appGroup").show();if(!b.length){var c=this.template.groupDom();this.$el.find(".cmAct").append(c)}$(this.$el).find(".ms_note").hide(),$(this.$el).find(".zmMention").show();var d=this.$el.find("textArea"),e=$(d).data("store");e&&(zmAutoFill.removeAutoFill(e),$(d).parent().siblings("input:hidden").remove(),$(d).unwrap().prev().remove());var f={contentArray:"org",compare:["fn","ln","nn","eid"],LType:"3",OType:"3",initialHeight:!0,oneMention:!0};zmAutoFill.setAutofill(f,d),d[0].placeholder="Task title @task owner",zmMention.updateElements($(d)),this.$el.find(".zms_aAtt").hide(),zmUtil.requireTaskModule().done(function(){$(d).on("keypress",function(a){zmtCom.extendMention(d[0],a)})})},convertNoteComment:function(a){var b=this.$el;if(b.find(".mailAct").hide(),b.find(".msi-note").length)b.find(".msi-note").show();else{b.find(".zms_fixed").children(":eq(0)").before("<div class='ms_note'></div>");var c=this,d=function(a){a&&(c.noteAddCallback=a,a.onHeightChange($(c.$el).find(".cmntText").css("maxHeight"),function(){c.setBottom()})),c.setBottom()},e=b.find("textArea").focus().data("selMailIds"),f=$.isEmptyObject(e)?this.model.get("openedId"):e[0],g=zmail.mailObj[f].F;zmUtil.loadNotes("commentNote",{groupId:zmail.zuid,desc:_zm.escapeTags(b.find("textArea").val()),addparams:{msgid:f,accid:zmail.defAccId,senderid:g}},{ele:b.find(".ms_note"),callback:d})}b.find(".zm_mention").hide(),b.find(".addcomnt").text("Add Note").addClass("addNote").removeClass("addTsk");var h=b.find(".zmCmntSC");h.children(".taskcmnt").show(),h.children(".msi-comment").show(),h.children(".noteCmnt").hide(),h.siblings(".msi-smiley").hide();var i=b.find(".appGroup").show();if(!i.length){var j=this.template.groupDom();b.find(".cmAct").append(j)}b.find(".zms_aAtt").hide()},hideMailIcons:function(){var a=$(this.$el).find(".zmCmntSC");a.siblings(".msi-smiley").hide(),a.children(".msi-comment").show()},showHashTag:function(a){var b=a.currentTarget,c=$(b).text();zmUtil.publishCloseNotif(),0===c.indexOf("#")&&(c=c.substring(1,c.length));var d=this.model.get("groupId");zmStreamsApp.util.listHashTags({tag:c,gid:d})},showUserDropdown:function(a){var b=a.currentTarget,c=String($(b).data("zid")),d=this.model.get("groupId");zmStreamsApp.events.showContactCard({zid:c,elm:b,groupId:d,eType:this.model.get("etype")})},showGroupDropdown:function(a){var b=[],d=$(this.$el).find(".appGroup"),e=String($(d).data("grp"));e!==zmail.zuid&&b.push({name:c.common.labels.myStream,id:zmail.zuid,photo:zmStreamsApp.util.getContactDetails([zmail.zuid])[zmail.zuid].photo}),b=b.concat(_.toArray(zmCont.getGroup())),zmStreamsApp.util.showGroupDetails({groupInfo:b,elm:$(d).find("b"),fn:function(a){$(d).data("grp",a.id),$(d).find(".zm_grptxt").text(a.name),zmUtil.hideMenu()},showUnread:!1},{type:"popup"})},hasAttachment:function(){var a=!1,b=this.attCmpRef;return"undefined"!=typeof b&&""!==b&&(a=Boolean(b.getAllAttachedList().length)),a},attachFiles:function(a){var b=this;if(b.attCmpRef)b.attCmpRef.configJSON.eleId=a,b.attCmpRef.init();else{var c=this.callAttachment(a);zmUtil.initAttachComponent(c,function(a){b.attCmpRef=a})}},callAttachment:function(){var a=this.model.get("id"),b=zmStreamsApp.util.retrieveUnposted(a),c=b.attachment||[],d={componentId:"streams",isNewImp:!0,attachFrom:["desktop","myAttachchment","zDocs","otherCloud"],currentAttachedSize:0,eleId:this.$el.find(".zmCAt"),preAttachedFile:c,renameSupport:!0,onAddAttachment:this.saveAttachment,onRemoveAttachment:this.saveAttachment,deferredUpload:!0};return this.model.get("isDraftShare")&&(d.onAddElement=function(){g.resizeFn()},d.onRemoveElement=function(){g.resizeFn()}),d},saveAttachment:function(){var a=this.getAllAttachedList(),c=b.get("id");zmStreamsApp.util.storeUnposted(c,{attachment:a})},like:function(a){var b=a.currentTarget,d=$(b).data("cmid"),e="",f=$(b).next().text();if(!$(b).hasClass("zmLockLike")&&!$(b).hasClass("pointerEventsNone")){$(b).addClass("zmLockLike"),""!==f&&(f=parseInt(f));var g=_zm.copyOf(this.model.get("comments")),h=this.model.pickComment(d).index,i=g[h].likeList||{},j=g[h].likes;if($(b).parent().hasClass("contentILiked"))$(b).parent().removeClass("contentILiked"),e=c.streams.tooltip.likeComment,f-=1,0!==f&&""!==f||$(b).parent().removeClass("contentLiked"),delete i[zmail.zuid],f<=0&&(f=""),j-=1;else{$(b).parent().addClass("contentILiked"),e=c.streams.tooltip.unlikeComment,0!==f&&""!==f||$(b).parent().addClass("contentLiked");var k=zmStreamsApp.util.getContactDetails([zmail.zuid])[zmail.zuid];i[zmail.zuid]=k.fn,f+=1,j+=1}1===f?$(b).parent().addClass("contentLiked"):0!==f&&""!==f||$(b).parent().removeClass("contentLiked"),g[h].likeList=i,g[h].likes=j,this.model.set("comments",g),$(b).next().show().text(""),$(b).next().show().text(f),zmComponent.tooltip({elm:$(b)[0],text:e,arrow:"top"}),this.model.likeComment(d,$(b))}},showCommentLikes:function(a,b){var c=$(this.$el).find(".zm_lcnt[data-cid='"+a+"']"),d=this.model.pickComment(a).commentObj,e=d.likeList||{};if($(b).is(c)){var f,g=[];for(var i in e)f=zmStreamsApp.util.getContactDetails([i])[i],f.isDummyObj&&(f.fn=e[i]),g.push(f);g.length?(h.createPopup({items:g,parent:c,ulclass:"SC_Pr",parentClass:"SC_Slke",type:"oneLine"}),$(b).text(g.length)):$(b).text("")}},sendPrivate:function(a){var b=a.currentTarget,d=this.model,e=$(b).val();if(""!==$.trim(e)&&!$(b).hasClass("zm_snd")){var f=$(b).data("cid"),g=$(b).addClass("zm_snd").data("z");d.sendPrivate(e,f,g,function(){d.get("isDeleted")&&_zm.succErrMsg("e",c.common.messages.deletedPost),$(b).removeClass("zm_snd")})}},showHidePrivateComment:function(a){var b=a.currentTarget,d=$(b).parents(".zms_comment");if(d.length){var e=$(d[0]).next("li.pvtMsg");e.length&&("none"===e[0].style.display?(e[0].style.display="",b.childNodes[1].textContent=c.common.labels.hidePrivateComments):(e[0].style.display="none",b.childNodes[1].textContent=c.common.labels.showPrivateComments))}},showSingleComment:function(a){var b=$(a).data("cid"),c=this.model.getsinglecomment(b,a,"popup");c&&h.createPopup({items:c,type:"comment",parent:a,ulclass:"rplyCmnt"})},addNewPrivate:function(a){var b=$(a).data("cid"),c=!b,d=c?this.model.get("owner"):$(a).data("z"),e=this.template.createPrivate(b,d,!0,c);c?$(a).children().first().hasClass("pvtRlyLi")||$(a).children().first().before(e):$(a).parents("li").after(e),$(e).find("input").focus(),this.model.get("isDraftShare")&&zmStreamsApp.events.publishKeyEvent(this.model.get("miscData"))},attachReplyTo:function(a){var b=this.$el,c=$(a.currentTarget).data("cid"),d=String($(a.currentTarget).data("z")),e=zmStreamsApp.util.getContactDetails([d])[d].fn,f=this.template.replyComment(c,e),g=b.parents("ul.Stcmt").find("textArea");if(g.length||(g=b.find("textArea")),g.parent().before(f),$(f).data("setHeight",!0).siblings(".zms_rep").remove(),g.data("cid",c).focus(),this.fixedComment){var h=$(b).find(".SCS_cmnt"),i=$(b).find(".SCS_postWra");i.parent().hasClass("SCS_postMail")&&(i=i.parent());var j=i.parents(".SCS_popUp");zmStreamsApp.events.setMaxHeight(j,h[1],i[0])}},updateLike:function(a){var b=this.$el.find('.msi-love[data-cmid="'+a+'"]'),d=this.model.pickComment(a).commentObj,e="";b.removeClass("zmLockLike");var f=d.likes?d.likes:"";d.liked!==b.parent().hasClass("contentILiked")&&(d.liked?(b.parent().addClass("contentILiked"),e=c.streams.tooltip.unlikeComment):(b.parent().removeClass("contentILiked"),e=c.streams.tooltip.likeComment),b.length&&zmComponent.tooltip({elm:b[0],text:e,arrow:"top"})),1===f?$(b).parent().addClass("contentLiked"):0!==f&&""!==f||$(b).parent().removeClass("contentLiked"),b.next().show().text(f)},setBottom:function(){if(this.isNewCollabUser){var a=this.$el,b=$(a).find(".zmCmntFixed")[0],c=b.getBoundingClientRect().height+10;$(this.$el).parents(".SC_Twpr").css("bottom",c+"px")}},updPrivateComment:function(a,b,d,e,f){var g,h,i,j,k,l,m=this.$el,n={recepient:f};if(d=d||"",g=this.model.getPvtComments(d),a?(j=this.model.get("owner"),k=$(m),h=$(k).find('ul.pvtOwn[data-zid="'+f+'"]')[0]):(j=g.by,l=$(m).find('.zms_comment[data-cid="'+d+'"]'),k=l.next(),h=$(k).find('ul.Spvt[data-zid="'+f+'"]')[0]),n.replyTo=f===zmail.zuid?j:f,e)if(a){var o=this.template.privateToOwner(g,this.model.get("owner"),"",this.model.get("disableComment"),void 0,!0);h=$(k).find(".cmntMore").length?$(k).find(".cmntMore"):$(k).find(".cmnt_ul"),$(k).find(".pvtOwn").length&&$(k).find(".pvtOwn").remove(),$(h).before(o);var p=$(k).parent().find(".SCSpostAct");if(p.length){$(p).find(".SndPrvO").hide();var q=$(p).find(".ShwPrv").show();q[0].childNodes[1].textContent=c.common.labels.hidePrivateComments}}else{k.hasClass("pvtMsg")&&k.remove(),this.template.privateCommentBlock(l,g,!1,"","",this.model.get("disableComment"),!0,e);var r=$(l).find(".ShwPrv").show();r[0].childNodes[1].textContent=c.common.labels.hidePrivateComments}else if(h){var s,t,u,v;v=$(h).find(".pvtRlyLi"),b.by!==zmail.zuid&&v.length&&(t=!("none"===v[0].style.display),u=$(h).find(".pvtRlyLink")),s=a?g[f]:g["private"][f],i=this.template.private_comments(d,n,s,e,a,"",this.model.get("disableComment"),t),t&&$(i).append(v[0]).append(u[0]),$(h).replaceWith(i),_zm("<","INPUT",v[0])[0].focus()}else i=this.template.private_comments(d,n,[b],e,a,"",this.model.get("disableComment")),a?$(k).find("ul.pvtOwn").find("li.pvtMsg").append(i):$(k).append(i)},updateMentions:function(){var a=this.model.get("id"),b=zmStreamsApp.util.retrieveUnposted(a),c=b.mentions||[],d=this.$el;"org"!==c&&(c=_.without(c,zmail.zuid),c=zmStreamsApp.util.getContactDetails(c),c=_.toArray(c)),document.body.contains(d[0])&&zmAutoFill.updateArray($(d).find("textarea"),c)},reSize:function(){var a=this,b=a.$el,c=$(b).find(".cmnt_ul"),d=a.model.get("disableComment"),e="fixedComment"===$(c).data("type"),f=$(b).find(".SCS_cmnt"),g=this.isNewCollabUser?$(b).filter(".SCS_postWra"):$(b).find(".SCS_postWra");e&&!d&&(g.parent().hasClass("SCS_postMail")&&(g=g.parent()),zmStreamsApp.events.setMaxHeight($(b),f[1],g[0]))},initialize:function(a){var b=this,c=b.model;b.render(a.postElm,a.highlightComment,a.viewJSON,a.isNewCollabUser),b.listenTo(c,"change:add",b.addNew),b.listenTo(c,"change:like",b.updateLike,b),b.listenTo(c,"change:listAll",b.listAll),b.listenTo(c,"change:removeComment",b.removeComment),b.listenTo(c,"add:commenttoowner",b.addNewPrivate),b.listenTo(c,"add:privateComment",b.updPrivateComment),b.listenTo(c,"change:getLikes",b.showCommentLikes),b.listenTo(c,"change:singlecomment",b.singlecomment),b.listenTo(c,"change:disableComment",b.disableCommentUpdate),b.listenTo(c,"change:mentionData",b.updateMentions),a.isNewCollabUser&&b.listenTo(c,"change:inviteeList",b.addInviteeForMail)},addUnposted:function(a,b){var c=this.model.id,d=this.$el.find("textArea"),e=zmStreamsApp.util.retrieveUnposted(c),f=e.replyTo||"",g=e.text||"",h=e.mentions||[],i=e.attachment||[],j=!1,k=this.$el.find(".SC_PUbtm");if(f&&f.id){var l=f.id,m=f.name,n=this.template.replyComment(l,m);d.data("cid",l).parent().before(n),a&&$(d).focus(),j=!0}if(g.trim()){if($(d).val(g).data("mentions",h),zmMention.updateElements($(d)),a)if(this.isNewCollabUser){var o=this;setTimeout(function(){$(d).trigger("focus"),o.setBottom()},300)}else $(d).focus();j=!0}i&&i.length>0&&(this.addAttachment(!0),j=!0),j&&($(k).show(),zmAutoFill.resizeTextArea(d[0]))},render:function(a,b,d,e){var f=this.model;b&&$.isArray(b)&&(b=b[0]);var g=f.id,h=f.get("attachIndex"),i=d||f.toJSON(),j=this.template.comments(i,h,b,e),k=i.fixedComment;this.fixedComment=k||!1,a?$(a).append(j):a=j,e&&(this.isNewCollabUser=!0);var l,m;if(k)m=e?$(a):$(a).parent().parent(),i.isDraftShare&&(m=$(a).parent()),l=this.template.fixedComment({cid:g,sharedCall:i.sharedCall,sharedApiCall:i.sharedApiCall,entityExists:i.entityExists,totalCount:i.total,isDraftShare:i.isDraftShare,attId:h,isShare:i.isSharedFolder,placeHolder:i.placeHolder,fixedComment:!0,inviteeList:i.inviteeList}),i.disableComment||($(m).find(".zms_fixed.zmCmntFixed").remove(),$(m).append(l)),this.$el=$(m),a.parent().hasClass("SCS_postMail")&&(a=a.parent());else{this.$el=$(j);var n=$(this.$el).find(".zmst_attach");n.length&&zmComponent.tooltip({elm:n[0],text:c.streams.tooltip.addattachmentComm,arrow:"top"})}var o=i.comments;if(void 0!==o&&this.setToolTip(o),this.setDefaultEvents(l),this.addUnposted(k,m),b&&this.$el.find(".highlightClass").length){var p=this.$el;setTimeout(function(){var a=p.find(".highlightClass")[0];a.scrollIntoView(!1)},500)}var q=$(a).siblings(".SCS_postWra").length?$(a).siblings(".SCS_postWra"):$(a).find(".SCS_postWra");return q.length||(q=$(a).filter(".SCS_postWra").length?$(a).filter(".SCS_postWra"):$(a).find(".SCSpostAct")),q&&q.find(".SndPrvO").data("commentView",this),k&&zmStreamsApp.events.setMaxHeight(m,l,a[0],i.sharedCall,!0),zmUtil.addSelectMenu({applyDOM:$(j),ignoreSelector:[".SC_avtr",".cmntDet",".zm_susr",".cmntLabel",".zms_txtLI"]},{groupId:f.get("groupId")}),$(j).attr("data-commentviewid",this.cid).attr("data-id",f.id),f.setView(this.cid,this),this},onClose:function(){var a=this;a.model.removeView(a.cid),a.fixedComment?(this.noteAddCallback&&zNote.removeNoteFromView($(this.$el).find(".ms_note")[0]),a.undelegateEvents(),a.unbind(),a.stopListening(),$(a.$el).find("div.sc_cmdv").remove(),this.model.get("sharedCall")&&$(this.$el).find(".zms_fixed").remove(),a.remove()):a.remove(),a.ComSmiley&&a.ComSmiley.destroy()},removeComment:function(a,b,c){var d,e=this.$el,f=e.find('.delCmnt[data-cid="'+a+'"]'),g=$(f).closest("li"),h=$(e).hasClass("SCS_cmnt")||$(e).find(".SCS_cmnt").length;if(!f.length&&h&&(g=e.find('.zms_comment[data-cid="'+a+'"]'),g.length||(g=e.find('li[data-cid="'+a+'"]'))),d=$(g).next(),b&&2===$(g).siblings().length){var i;g=$(g).parent("ul.Spvt"),0===$(g).siblings().length&&(g=$(g).parent("li.pvtMsg"),c?(g=$(g).parent("ul.pvtOwn"),i=$(g).parents(".sc_cmdv.SCS_cmnt").siblings()):i=$(g).prev(),i.find(".SndPrv").show(),i.find(".ShwPrv").hide())}$(g).hasClass("zms_comment")&&$(d).hasClass("pvtMsg")&&d.remove(),g.remove(),this.model.get("isDraftShare")&&zmStreamsApp.events.publishKeyEvent(this.model.get("miscData"));var j=this.model.get("comments").length;if(this.model.get("sharedCall")&&this.fixedComment&&(j?this.$el.find(".StCnt").text(j):this.$el.find(".cmntInfo").hide()),this.model.get("isDraftShare")&&!j){var k=this.template.draftNoComment();this.$el.find(".sc_cmdv").append(k)}this.isNewCollabUser&&this.setBottom()},disableCommentUpdate:function(){var a=this,b=a.model,c=a.$el,d=a.template,e=b.get("attachIndex");if(a.fixedComment){if(b.get("disableComment"))$(c).children(".SCS_cmnt").remove();else if($(c).find(".SCS_cmnt").length<=1){var f=d.fixedComment(b.toJSON());$(c).append(f)}}else{var g=d.comments(b.toJSON(),e);$(c).empty().append(g.children)}b.get("disableComments")||a.setDefaultEvents(c)},setDefaultEvents:function(a){var b=this;a=a||this.$el;var c=$(a).find("textArea"),d=this.model.get("groupId");!zmCont.isGroup(d)&&this.model.get("shGroup").length&&(d=this.model.get("shGroup")[0].id);var e=zmCont.isGroup(d)?d:"",f={elm:c,resize:!0,mention:this.model.get("mention"),gid:e,addGroups:this.model.get("groupsMention"),isShareFolder:this.model.get("isSharedFolder")};c.length&&(this.ComSmiley=zmSmiley.SmileyAutoComplete({input:c[0],onSelect:function(a,b){var c=this.userInput,d=b.item.attributes.id+" ",e=c.getCurrentTypingWord();c.replaceContentBeforeCursor(e,d)}})),this.model.get("isDraftShare")&&(f.keyCallback=zmStreamsApp.events.publishKeyEvent,f.keyParam=this.model.get("miscData")),this.model.get("sharedCall")&&!this.model.get("isDraftShare")&&this.fixedComment&&this.isNewCollabUser&&!this.model.get("entityExists")&&$(c).on("mentions/change",function(a,c){c.zidList&&c.zidList.length&&b.updateInviteeList("mention")}),zmStreamsApp.events.mentionsInput(f),$(a).find(".msi-smiley").click(function(a){zmSmiley.showList(c[0],this,a)});var g=$(a).find(".cmntText")[0];zmLinks.PreviewManager(c[0]).setComponentReadyCallback(function(a){zmStreamsApp.linkPreview.sanitizeComponent(a),$(g).append(a.getDOM()),b.reSize(),setTimeout(function(){zmAutoFill.resizeTextArea(c[0])},100)}).setProgressDisplayDOM(g)},getInviteesListForMail:function(a){a=a||{};var b=this.sharedMailInvitees,c=a.refreshData||"all",d="all"===a.refreshData||!b,e=this.$el.find("textArea");if(!b||d||c){if(b=b||{},d||"mention"===c){var f=$(e).data("mentions")||[];f&&(b.mentions=_.pluck(f,"zid"))}if(d||"recipientList"===c){var g=this.$el.find(".zm_inclr .msi-check").length?this.model.getRecipientsForMail():[];g&&(b.recipientList=g)}if(d||"inviteePop"===c){var h=e.data("dzids");b.dzids||(b.dzids=[]),b.dzids=b.dzids.concat(h||[]),e.data("dzids","")}b.inviteeList=[],this.model.get("entityExists")&&this.model.get("inviteeList")&&(b.inviteeList=this.model.get("inviteeList")),this.sharedMailInvitees=b}if(a.removeIds){for(var i,j=a.removeIds,k=!1,l=0;l<j.length;l++)i=String(j[l]),b.mentions&&b.mentions.indexOf(i)!==-1&&(k=!0,b.mentions.splice(b.mentions.indexOf(i),1)),b.recipientList&&b.recipientList.indexOf(i)!==-1&&b.recipientList.splice(b.recipientList.indexOf(i),1),b.dzids&&b.dzids.indexOf(i)!==-1&&b.dzids.splice(b.dzids.indexOf(i),1);if(k){var m=zmStreamsApp.util.getContactDetails(b.mentions);m=_.toArray(m),$(e).data("mentions",m),zmMention.updateElements($(e)[0])}this.sharedMailInvitees=b}var n=[].concat(b.inviteeList,b.mentions,b.recipientList,b.dzids);return n},updateInviteeList:function(a,b){if("mention"!==a||!this.model.get("entityExists")){var c=this.getInviteesListForMail({removeIds:b,refreshData:a}),d={};c&&c.length&&(d=zmStreamsApp.util.getContactDetails(c)),this.template.addInviteeList(d,this.$el[0])}},invCloseAction:function(a,b){var c=$(a.$els.$contentWrapper).find("input"),d=zmAutoFill.getAddress(c,"id"),e=c.data("removedZid")||[];d.length&&b.model.get("entityExists")&&zmStreamsApp.PostActions.updateInviteeForMail({type:"addInvitee",inviteeList:d,eid:b.model.id}),!d&&!e||b.model.get("entityExists")||b.addInviteeForMail(d,e)},showInviteeList:function(){var a=this.getInviteesListForMail(),b={};_.each(a,function(a){b[a]=String(zmail.zuid)});var d={items:b,isOwner:!0,showInvite:!0,type:"invitee_popup",invite:!0},e=this;d.closeAction=function(a){e.invCloseAction(a,e)},d.buttons=[{name:"Add",callback:function(a){e.invCloseAction(a,e),h.hideMenu(),a.remove()}},{name:c.common.labels.cancel,callback:function(a){a.remove(),h.hideMenu()},isCancel:!0}],d.dialogDidMount=function(a){e.bindInvitee(e,a.$els.$contentWrapper)},h.createDialog(d)},addInviteeForMail:function(a,b){var c=this.$el.find("textArea");(b.length||a.length)&&(a&&a.length&&(a=a.split(","),c.data("dzids",a)),this.updateInviteeList("inviteePop",b))},bindInvitee:function(a,b){var c=$(b).find(".zm_sgst"),d=a.getInviteesListForMail(),e={contentArray:"org",compare:["fn","","nn","eid"],LType:"3",OType:"2",display:"fn",eliminateAt:!0,restrict:d,groupId:!0,addtolist:!0};zmAutoFill.setAutofill(e,c),zmAutoFill.resizeInput(c),$(b).find(".SC_cs .msi-close").click(function(){var b=$(this).parent(),d=$(b).data("uid");$(b).parent().remove();var e=$(c).data("removedZid")||[];e.push(d),a.model.get("entityExists")&&zmStreamsApp.PostActions.updateInviteeForMail({type:"removeInvitee",inviteeList:d,eid:a.model.id}),$(c).data("removedZid",e)})},switchBackMail:function(a){var b=this.$el,d=$(b).find("textArea");$(b).find(".zmBTCmnt").removeClass("zmBTCmnt");var e=this.model.get("placeHolder").button,f=$(b).find(".addcomnt"),g=f.hasClass("addTsk"),h=f.hasClass("addNote");if($(b).find(".mailAct").show().siblings(".appGroup").hide(),a&&this.clearText(d,!0),h){$(b).find(".ms_note").hide(),f.text(e).removeClass("addNote");var i=$.trim(this.noteAddCallback.getNoteValues().textContent);i&&d.val(i),$(b).find(".noteCmnt").show(),$(b).find(".zm_mention").show()}if(g){var j=$(d).data("store");j&&($(d).off("keypress"),zmAutoFill.removeAutoFill(j),$(d).parent().siblings("input:hidden").remove(),$(d).unwrap().prev().remove()),$(b).find(".taskcmnt").show(),d[0].placeholder=this.model.get("entityExists")?c.common.labels.writeComment:this.model.get("placeHolder").textArea;var k=this.model.get("groupId");f.text(e).removeClass("addTsk");var l=zmCont.isGroup(k)?k:"",m={elm:d,resize:!0,mention:this.model.get("mention"),gid:l,addGroups:this.model.get("groupsMention"),isShareFolder:this.model.get("isSharedFolder")};zmStreamsApp.events.mentionsInput(m),zmMention.updateElements($(d))}b.find(".msi-smiley").show(),b.find(".msi-comment").hide(),b.find(".zms_aAtt").show(),this.setBottom()},publishNote:function(){var a=$(this.$el).find(".appGroup").data("grp"),b=this.noteAddCallback;b.setGroup(a);var c=this;b.quickAddList().done(function(){b.clearValues(),c.setBottom(),c.switchBackMail(!0),zmStreamsApp.util.removeUnposted(c.model.get("id"))})},publishTask:function(){},publish:function(a){var b=this,d=b.model,g=b.$el.hasClass("sc_cmdv")?b.$el:$(b.$el).find(".sc_cmdv.SCS_cmnt"),i=g.data("id");if(this.model.get("sharedCall")||this.fixedComment){if(d.id!==i)return;if(this.model.get("sharedCall")&&this.model.get("entityExists")===!1&&!this.model.get("isDraftShare")){var j=this.model.get("miscData");if(!zmUtil.isChildWindow()&&"undefined"!=typeof zmPrev&&!zmPrev.isEntityOpenedInPreview(j.mailID,j.openedTab))return}}var k=b.$el,l=k.find("textArea.zms_cmTxt"),m=l.val().replace(/\s+$/,""),n=zmStreamsApp.util.getMentionData(l),o=$(k).find(".addcomnt");b.saveContent=!1,k.length||(k=d.get("fixedElement"));var p=k.find(".lockClass"),q="";p.length&&(q=p.find("i").hasClass("msi-Dinvitee"));var r=l.data("selMailIds");if(this.isNewCollabUser&&$(a.currentTarget).hasClass("addTsk")){if($(o).hasClass("taskSel"))return void zmUtil.succErrMsg("e","Previous request in progress");if(!m)return void zmUtil.succErrMsg("e","Task cannot be empty");var s=$(this.$el).find(".appGroup").data("grp"),t="",u=m;if(!$.isEmptyObject(n.offset)){var v=n.offset;t=v.text[0],u=u.substring(0,v.from[0])}var w=$.isEmptyObject(r)?this.model.get("openedId"):r[0],x={title:u,groupId:s,taction:"addTaskSubtask",actionType:"addEntity"};if(t&&(zmCont.isGroupMember(t,s)?x.assignee=t:(x.invitees=t,t="")),q&&(x.lockinvites=q),w&&zmail.mailObj[w]){var y=zmail.mailObj[w].F;x.msgid=w,x.accid=zmail.defAccId,x.senderid=y,x.summary=zmail.mailObj[w].SM||""}return $(o).addClass("taskSel"),void zmtCom.addTaskReq(x,"",function(a){zmStreamsApp.util.removeUnposted(d.get("id")),$(o).removeClass("taskSel");var c=a?a.TASKID:"";c&&(zmUtil.succErrMsg("s","Task added successfully"),b.switchBackMail(!0),$.publish("/zm/task/addTask",[a]))},!0)}if(this.isNewCollabUser&&$(a.currentTarget).hasClass("addNote"))return void this.publishNote();var z=b.hasAttachment();if(!m&&!z||$(o).hasClass("zs_snd")){if(""===m&&!z){_zm.succErrMsg("e",c.common.messages.emptyComment);var A=e;d.get("sharedCall")&&(A=d.get("entityExists")===!0?e:d.get("placeHolder").button),h.sendRemove(o,!0,A)}}else{var B=d.get("entityExists")===!0?{}:d.get("placeHolder");$.isEmptyObject(B)?h.sendRemove(o,!1,f):h.sendRemove(o,!1,B.changeText),h.getAttachments(this.attCmpRef,!0).done(function(a){var f=$(b.$el).find(".zm_inclr i"),g=f.length&&f.hasClass("msi-check")||!1;if(a&&a.error&&1===a.error.code)return!1;var i="";b.isNewCollabUser&&(i=b.getInviteesListForMail(),i=i&&i.length?i.join(","):"");var j=zmStreamsApp.linkPreview.getLinkInfoFromComponentData(zmLinks.PreviewManager(l).getPreviewData());zmStreamsApp.util.removeUnposted(d.get("id"));var k={text:m,mentions:n,replyTo:$(l).data("cid"),includeRecipients:g,linkData:j,lockInvites:q,selectedMailIds:r,sharedMailInvitees:i,error:function(a,b){if(b=b||{},!b.suppress&&!d.get("isDeleted")){var f=a.message||a.msg;zmUtil.succErrMsg("e",f,b)}d.get("isDeleted")&&zmUtil.succErrMsg("e",c.common.messages.deletedPost);var g=e;d.get("sharedCall")&&(g=d.get("entityExists")===!0?e:d.get("placeHolder").button),h.sendRemove(o,!0,g)}};a&&a.attTmpObj&&(k.attTmpObj=a.attTmpObj),a&&a.attEntObj&&(k.attEntObj=a.attEntObj),b.model.NewComment(k)}).fail(function(a){_zm.succErrMsg("e",a.msg);var b=e;d.get("sharedCall")&&(b=d.get("entityExists")===!0?e:d.get("placeHolder").button),h.sendRemove(o,!0,b)})}},clearText:function(a,b){zmMention.clearMention($(a)),$(a).data("cid","").val(""),zmAutoFill.resizeTextArea($(a)[0],{resizeMentionsBG:!0}),this.saveContent=!0;var c=$(a).parents(".zms_txtLI");if(c.length||(c=$(a).parents(".cmntText").siblings(".cmntActions")),b||(h.sendRemove($(c).find(".addcomnt"),!0,e),this.$el.find(".zms_rep").remove(),$(c).find(".zm_inclr").remove(),$(c).find(".mailSharedLock").remove(),this.clearAttachment(a,"attach"),zmLinks.PreviewManager(a).reset()),this.isNewCollabUser){var d=this;setTimeout(function(){d.setBottom()},400)}},clearAttachment:function(a){var b=$(a).parents("li.zms_txtLI");b.length||(b=$(a).parents(".SCS_cmnt")),$(b).find(".zms_aAtt .zmL").remove(),this.clearFiles()},clearFiles:function(){var a=this;"undefined"!=typeof a.attCmpRef&&""!==a.attCmpRef&&a.attCmpRef.clearStoreAttachments()},addNew:function(a){var b,d,e,f,g,h=_.last(this.model.get("comments")),i=this,j=this.model.get("comments").length,k=this.$el;b=i.template.comment(h,i.model.toJSON());var l=$(b).attr("data-cid");d=$(k).find(".cmnt_ul"),e=$(k).find("textArea"),f=$(d).find(".addcomnt");var m="fixedComment"===$(d).data("type");if(m)g=$(d).last().children().last().attr("data-cid"),g!==l&&$(d).append(b);else{var n=$(d).children();g=$(n).eq($(n).length-2).attr("data-cid"),g!==l&&$(n).last().before(b)}!e.val()&&!$(k).find(".zms_aAtt .zmL").length||a||this.clearText(e);var o=this.model.get("entityExists")===!0?{}:this.model.get("placeHolder");if(o=o||{},o.textArea=o.textArea||c.common.labels.writeComment,o.button=o.button||c.common.comment,e.attr("placeholder",o.textArea),f.text(o.button),1!==j||this.model.get("isDraftShare")||$(d).siblings(".cmntLabel").length||!this.model.get("sharedCall")||$(d).parent().prepend(this.template.commentHeader()),this.setToolTip([h]),this.model.get("isDraftShare")&&(this.$el.find(".zmNoCmnt").remove(),zmStreamsApp.events.publishKeyEvent(this.model.get("miscData"))),h.tags.length){var p=_.pluck(h.tags,"type"),q=p.indexOf("HASHTAG");p.indexOf("HASHTAG")!==-1&&zmStreamsApp.GroupApp.updateHashTag(h.tags[q])}if(this.fixedComment&&this.isNewCollabUser){var r=this.$el.find(".selMail");r.next().remove(),this.$el.find(".selMail").remove();var s=this.model.get("comments").length;if(this.$el.find(".cmntInfo").length)this.$el.find(".StCnt").text(s);else{var t=_zm.getDOM(this.template.commentInfo(s));this.$el.find("ul.inviteeList").before(t)}}},addAttachment:function(a){var c=this,d=c.$el,e=$(d).find(".sc_cmdv.SCS_cmnt").data("id");if(!this.isNewCollabUser||c.model.id===e){b=c.model;var f=d.find("textArea"),g=f.data("attach");if(!d.find(".zms_aAtt").length){var h=$(d).find(".zms_txtLI .cmntText");h.length||(h=$(d).find(".cmntText")),$(h).after(zmStreamsApp.template.addAttachment(g))}var i={id:g};if(c.model.get("isDraftShare")&&(i.share_draft=!0,i.draftID=c.model.get("id"),i.onComponentChange=(c.model.get("miscData")||{}).uploadCallback),a!==!0)i.accId=zmUtil.getDefaultAccountID(),c.attachFiles(g);else{i.accId=zmUtil.getDefaultAccountID();var j=c.callAttachment(g);j.autoLaunch=!1,zmUtil.initAttachComponent(j,function(a){c.attCmpRef=a})}}},setToolTip:function(a){var b,d,e,f,g=$(this.$el);if(a=$.isArray(a)?a:[a],a.length)for(var h in a)b=a[h],d=$(g).find('.msi-love[data-cmid="'+b.id+'"]'),d.length&&(e=b.liked?c.streams.tooltip.unlikeComment:c.streams.tooltip.likeComment,zmComponent.tooltip({elm:d[0],text:e,arrow:"top"})),f=$(g).find('.msi-close[data-cid="'+b.id+'"]'),f.length&&zmComponent.tooltip({elm:f[0],text:c.streams.tooltip.delComm,arrow:"top"});if(g.find(".lockClass").length){var i=g.find(".lockClass");zmComponent.tooltip({elm:i[0],text:c.common.labels.allowInvites,
arrow:"top"})}},selectMail:function(a,b){var c=this.$el.find("textArea"),d=c.data("selMailIds");d=d||[],"add"===b?d.push(a):d.splice(d.indexOf(a),1),c.data("selMailIds",d);var e=this.$el.find(".selMail");if(e.length)d.length?(e.show().find(".StCnt").text(d.length),e.next().show()):e.hide().next().hide();else{var f=this.template.selectMailDOM(d.length);c.trigger("focus").trigger("change"),this.$el.find(".zm_slc").prepend(f),$(f).next().show()}},listAll:function(a,b,d){var e=this.$el,f=e.find(".cmntMore");if(f.removeClass("zmLock"),$(b).is(f)){var g=_zm.copyOf(this.model.get("comments")),i=e.find(".zms_txtLI"),j=e.find("ul.Stcmt"),k=this.fixedComment,l=i.parents(".SCS_cmnt"),m=j.parents(".SCS_postWra"),n=m.parents(".SCS_popUp");k?$(j[0]).empty():this.model.get("disableComment")?$(j).children().remove():(i.siblings().remove(),i=i.detach());var o=this.model.toJSON(),p=f.data("count"),q=g.length;if(p+10<q&&(g=g.slice(q-(p+10),q)),d){var r,s;for(var t in g)r=g[t].time,s=h.updateTime(parseInt(r)),s&&(g[t].on=s)}if(o.comments=g,this.template.commentList(o,j[0]),k?zmStreamsApp.events.setMaxHeight(n,l[0],m[0]):j.append(i),g.length<10)f.remove();else{var u=this.model.get("total"),v=u-g.length;if(0===v)f.remove();else{var w=e.find(".cmntMore").parent();w.find(".cmntMore").remove(),$(j[0]).prepend(this.template.viewmore(zmText.applyArgs(c.common.labels.viewMoreComments,{count:v}),g[0].id,g.length))}}this.setToolTip(g)}},singlecomment:function(a,b){var c=b.type,d=b.elm;"popup"===c?this.showSingleComment(d):"update"===c&&this.addNew(!0)}}),a}(zmStreamsApp.CommentModule.views);