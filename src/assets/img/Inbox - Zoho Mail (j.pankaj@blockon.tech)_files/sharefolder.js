window.zmshare=function(){"use strict";var a=function(a,b,c){zmAjq.XHR({u:zmail.conPath+"/share.do",t:"POST",fn:c,p:a,ep:b})},b=function(){var a=zmText.get("sharefolder");return a}(),c=function(a,b){if("success"===a.stat){var c,d=[];"nadd"===b.mode&&91===b.resTypeId?(c=zmList.getRowInfo(b.resId,"zmlTreeH","info"),c.SH=a.sId,d[b.resId]=c,zmList.editLeftRow(d,"zmlTreeH")):"nadd"===b.mode&&92===b.resTypeId&&(c=zmList.getRowInfo(b.resId,"zmllabelH","info"),c.shId=a.sId,d[b.resId]=c,zmList.editLeftRow(d,"zmllabelH")),zmshare.closeDialog()}else zmshare.showErr(a.emsg)},d=function(a,c){var d,e;"success"===a.stat?12===c.role?($(c.obj).addClass("SC_rwWrite"),d=$(c.liobj),e=d.find("span[id='zmshr_allowDelegate"+c.uId+"']"),e.removeClass("SC_dyn")):($(c.obj).removeClass("SC_rwWrite"),d=$(c.liobj),d.find("div[id='zmshr_frmlst"+c.uId+"']").addClass("SC_dyn"),e=d.find("span[id='zmshr_allowDelegate"+c.uId+"']"),e.addClass("SC_dyn"),e.find("i").eq(0).removeClass("msi-check").addClass("msi-uncheck"),d.removeClass("aldg")):zmshare.showErr(b.update_permission)},e=function(b){var c=$(b).attr("class"),e=11;c.indexOf("SC_rwWrite")===-1&&(e=12);var f=$(b).parents("li"),g={mode:"chg",shId:$("#sharepopup").attr("data-shid"),uId:f.attr("data-uid"),role:e},h={liobj:f,obj:b,role:e,uId:f.attr("data-uid")};a(g,h,d)},f=function(a){"success"===a.stat?zmshare.showSucc(b.notify_resend):zmshare.showErr(b.failed_confirmation)},g=function(b){var c=$(b).parents("li"),d={mode:"resnd",shId:$("#sharepopup").attr("data-shid"),uId:c.attr("data-uid")},e={};a(d,e,f)},h=function(a,c){if("success"===a.stat){if(!c.unshare){var d=[],e=$("#zmshr_usrlst").attr("zuid_list");e&&(d=e.split(","));for(var f=d.length;f--;)d[f]===c.liobj.attr("data-uid")&&d.splice(f,1);zmAutoFill.updateArray($("#sharepopup #zmshr_usrinp"),"",d),$(c.liobj).remove()}if(c.resId){var g,h=[],i=91;"tag"===c.resType&&(i=92),91===i?(g=zmList.getRowInfo(c.resId,"zmlTreeH","info"),g.SH="-1",h[c.resId]=g,zmList.editLeftRow(h,"zmlTreeH")):92===i&&(g=zmList.getRowInfo(c.resId,"zmllabelH","info"),g.shId="-1",h[c.resId]=g,zmList.editLeftRow(h,"zmllabelH")),zmshare.closeDialog()}}else zmshare.showErr(b.remove_permission)},i=function(b){var c=$(b).parents("li"),d=$(b).parents("ul"),e={mode:"del",shId:$("#sharepopup").attr("data-shid"),uId:c.attr("data-uid")},f={liobj:c};2===d.find("> li").length&&(e.resId=$("#sharepopup").attr("data-resId"),f.resId=$("#sharepopup").attr("data-resId"),f.resType=$("#sharepopup").attr("data-resType")),a(e,f,h)},j=function(a){var c={id:"id",name:"FN",OZUID:"OZUID",accessText:"ROLE",entityClass:"RT"},d={accessText:{11:"R",12:"W",13:"W"}},e={entityClass:{91:"msi-folder",92:"msi-label"}};a&&a.rType&&(a.rType=parseInt(a.rType));var f={};if(f[a.rId]={FN:a.rName,OZUID:a.owner,SHID:a.shareId,RT:a.rType,ROLE:a.role,EID:a.delegateEmail},$("#zmlSTree > div").length){zmail.shrTree[0][a.rId]=f[a.rId];var g,h="zmlSTreeH";g=zmail.mailLeft.getNodes()[0].getLayer(h),"CHANGE_ROLE"===a.action?g.editNode(f,g.mapObject):g.appendNode(f,g.mapObject)}else{zmail.shrTree=[],zmail.shrTree[0]={},zmail.shrTree[0][a.rId]=f[a.rId];var i,j=new ZMLayer;i={type:"3",mapObject:c,listId:"zmlSTree",classObject:d,id:"zmlSTreeH",dataObject:{headerObject:{id:"zmlSTreeH",name:b.shared_with_me,showList:!0},listObject:zmail.shrTree[0]}},zmail.showFeature&&(j.entityClass=e),j.push(i),zmail.mailLeft.getNodes()[0].insertLayerAfter("zmlTreeH",j)}},k=function(a){if($("#zmlSTree > div").length&&1===$("#zmlSTree > div").length)zmail.mailLeft.getNodes()[0].deleteLayer("zmlSTreeH");else{var c=zmail.mailLeft.getNodes()[0].getLayer("zmlSTreeH"),d=zmList.getRowInfo(a.rId,"zmlSTreeH");c.deleteNode(d)}zmUtil.succErrMsg("e",b.share_with_me_update),zmInit.getListingDetObj().fId&&zmInit.getListingDetObj().fId===a.rId&&zmUtil.selectFolderInLHS(zmail.folId.iId)},l=function(a){var c={};for(var d in a){var f=a[d],h=f.ui;c[h]=f}var j=$.map(a,function(a){return a.ui}),k=$("<span/>"),l=[];zmail.ContactBook.get({zuid:j,type:"org"}).done(function(a){if(a.map(function(a){return a.attrs}),a.length)for(var d=a.length,e=0;e<d;e++){var f=a[e].attrs,g=f.zid,h=c[g],i=h.r,j=h.c,m=f.eid,n=h.e,o="SC_rwToggle",p=!1,q="",r="",s=!1,t="SC_dyn";12===i||13===i?(o+=" SC_rwWrite",n&&(s=!0,p=!0)):r="SC_dyn",p&&(q="aldg"),f.fn&&(m=f.fn);var u="";j&&(u="SC_dyn");var v="msi-uncheck";s&&(v="msi-check",t="");var w="<div>",x="zmshr_allowDelegate"+g;w+='<span id="'+x+'" class="SC_frt '+r+'">',w+='<i class="'+v+'"></i>',w+=b.allow_delegation+"</span>",w+='<font id="zmshare_user_name_'+g+'"></font>';var y=' class="SC_lnk '+u+'" name="resend"';w+="<label "+y+">"+b.resend+"</label><br>",w+='<div class="SC_cs SC_np '+t+'"',w+=' id="zmshr_frmlst'+g+'">',w+="<span>"+n+"</span>",w+='<i class="msi-barrow"></i>',w+="</div>",w+="</div>";var z='data-uid="'+g+'" ';z+='data-role="'+i+'" ',z+='data-shstat="'+j+'" ',z+='class="'+q+'"';var A="<li "+z+">";A+=w,A+='<div data-readval="read" data-read="'+b.read+'" ',A+='data-write="'+b.write+'" class="'+o+'"></div>',A+='<i class="msi-trash"></i>',A+="</li>",k.append(A),k.find("font#zmshare_user_name_"+g).text(m),l.push(g)}});var m={contentArray:"org",compare:["fn","ln","nn","eid"],LType:"3",OType:"2",display:"fn",restrict:l};if(zmAutoFill.setAutofill(m,$("#sharepopup #zmshr_usrinp")),l.length>0){var n='<ul><li class="SC_lne"></li>'+k.html()+"</ul>";$("#zmshr_load").remove(),$("#zmshr_usrlst").removeClass("SC_dyn"),$("#zmshr_usrlst").html(n);var o=$(window).height()-100,p=$("#sharepopup").height();p>o&&($("#zmshr_usrlst").css("max-height",o-150+"px"),$("#zmshr_usrlst").css("overflow-y","auto")),$("#zmshr_usrlst").attr("zuid_list",l),$("#zmshr_usrlst li").each(function(){var a=$(this).attr("data-uid"),b=$(this);a&&zmail.ContactBook.get({zuid:a}).done(function(a){var c=a[0].avatar();b.prepend(c)})}),$("#zmshr_usrlst li div[data-readval='read']").off("click").on("click",function(){e($(this))});var q=Object.keys(zmList.frmListObj(zmail.cmpdata.FROM_LIST)),r=q.length;1===r?$("#zmshr_usrlst li div[id^='zmshr_frmlst']").each(function(){$(this).removeClass().addClass("SC_cs SC_np SC_ni")}):r>1&&$("#zmshr_usrlst li div[id^='zmshr_frmlst']").off("click").on("click",function(){zmshare.showFrm($(this))}),$("#zmshr_usrlst li span[id^='zmshr_allowDelegate']").click(function(){zmshare.allowDelegate($(this))}),$("#zmshr_usrlst label[name=resend]").click(function(){g($(this))}),$("#zmshr_usrlst li i.msi-trash").click(function(){i($(this))})}},m={getUserLst:function(b){var c={mode:"getUsr",shId:b},d={shId:b};a(c,d,l)},closeDialog:function(){var a=$("#sharepopup")[0].zm_share_dialog_ele;a.remove()},saveShare:function(d,e,f){var g=$("#zmshr_role").attr("class"),h=12,i=!0;g.indexOf("SC_rwWrite")===-1&&(h=11,i=!1);var j=$("#zmshr_delegate"),k=$("#zmshr_delegate").find("i").eq(0),l="";i&&j.is(":visible")&&k.hasClass("msi-check")&&(h=13,l=$("#zmshr_frmlst").find("span").eq(0).text());var m=zmAutoFill.getAddress($("#sharepopup #zmshr_usrinp"),"id");if(""===m)return zmshare.showErr(b.choose_org_member),!1;var n=91;"tag"===e&&(n=92);var o={uId:m,role:h,resId:d,resTypeId:n},p={resId:d,resTypeId:n},q="add";f?(o.shId=f,p.shId=f):q="nadd",o.mode=q,p.mode=q,l&&(o.sndrAddr=l),a(o,p,c)},allowDelegate:function(b){var c=$(b).parents("li"),d=c.find("div[data-readval='read']").attr("class"),e=12;d.indexOf("SC_rwWrite")===-1&&(e=11);var f="",g=!1;$(b).find("i").eq(0).hasClass("msi-uncheck")&&(f=zmail.cmpdata.DEFFRM_ADDR,g=!0);var h={mode:"chg",shId:$("#sharepopup").attr("data-shid"),uId:c.attr("data-uid")},i={liobj:c,obj:b,uId:c.attr("data-uid")};g?(h.sndrAddr=f,h.role=13,i.sndrAddr=f,i.delegate=g):h.role=e,a(h,i,zmshare.updateDelegate)},updateDelegate:function(a,c){var d=$(c.liobj);if("success"===a.stat){var e=d.find("div[id='zmshr_frmlst"+c.uId+"']");c.delegate?(d.find("i").eq(0).removeClass("msi-uncheck").addClass("msi-check"),e.removeClass("SC_dyn"),e.find("span").eq(0).text(c.sndrAddr),d.addClass("aldg")):(d.find("i").eq(0).removeClass("msi-check").addClass("msi-uncheck"),e.addClass("SC_dyn"),d.removeClass("aldg"))}else zmshare.showErr(b.update_permission)},showFrm:function(b){var c,d=zmList.frmListObj(zmail.cmpdata.FROM_LIST),e={},f=[];for(var g in d)c={htm:g,data:{frm:g,obj:b}},b.find("span").eq(0).text()!==g&&f.push(c);e.list=f,e.par=b,e.align="pleft",e.clk=function(b){var c=b.obj,d=$(c).parents("li"),e={mode:"chg",shId:$("#sharepopup").attr("data-shid"),uId:d.attr("data-uid"),role:13,sndrAddr:b.frm},f={liobj:d,obj:c,sndrAddr:b.frm,txtObj:c.find("span").eq(0),sndr:!0};a(e,f,zmshare.changeFrmAddr)},zmsuite.showMenu(e)},changeFrmAddr:function(a,c){"success"===a.stat?c.sndr&&($(c.txtObj).text(c.sndrAddr),$("#zm_dropDown").remove()):(zmshare.showErr(b.unable_fromaddr),$("#zm_dropDown").remove())},unshared:function(b){var c={};c.shId=b,c.mode="del",c.resId=$("#sharepopup").attr("data-resId");var d=$.extend({},c);d.unshare=!0,a(c,d,h)},unshare:function(b){var c,d=b.zm_unshareId,e="";zmail.shrTree[0]&&(e=zmail.shrTree[0][d].SHID,c=zmail.shrTree[0][d].OZUID);var f={};f.shareId=e,f.ownerId=c,f.mode="unsub";var g=$.extend({},f);g.obj=b,a(f,g,zmshare.unshareUpdate)},unshareUpdate:function(a,c){if("success"===a.stat)if($("#zmlSTree > div").length&&1===$("#zmlSTree > div").length)zmail.mailLeft.getNodes()[0].deleteLayer("zmlSTreeH");else{var d=zmail.mailLeft.getNodes()[0].getLayer("zmlSTreeH"),e=zmList.getRowInfo(c.obj.zm_unshareId,"zmlSTreeH");d.deleteNode(e)}else zmshare.showErr(b.unable_unsubscribe)},showSucc:function(a){$("#zmshare_folder_error_band").removeClass("SC_emsg SC_dyn"),$("#zmshare_folder_error_band").addClass("SC_smsg"),$("#zmshare_folder_error_msg").text(a),$("#zmshare_folder_error_close").off("click").on("click",function(){$("#zmshare_folder_error_band").addClass("SC_dyn")}),setTimeout(function(){$("#zmshare_folder_error_band").addClass("SC_dyn")},2e3)},showErr:function(a){$("#zmshare_folder_error_band").removeClass("SC_smsg SC_dyn"),$("#zmshare_folder_error_band").addClass("SC_emsg"),$("#zmshare_folder_error_msg").text(a),$("#zmshare_folder_error_close").off("click").on("click",function(){$("#zmshare_folder_error_band").addClass("SC_dyn")})},shNotify:function(a,b){b=b||{},b=b.data||{},b.act&&(b=b.data);var c=b.action;"USER_ADD"===c||"CHANGE_ROLE"===c?j(b):"USER_REMOVE"===c&&k(b)}};return zmComponent.notifier&&zmComponent.notifier.addHandler("sharedfolder",m.shNotify),m}();